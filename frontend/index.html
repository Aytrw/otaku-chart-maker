<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACGNÁîüÊ∂Ø‰∏™‰∫∫ÂñúÂ•ΩË°®</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #f0f0f0;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .ctrl-box {
            margin-top: 16px;
            margin-bottom: 16px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            background-color: #ea4c89;
            color: #fff;
            border: none;
            padding: 10px 30px;
            font-size: 15px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(234, 76, 137, 0.25);
            transition: background-color 0.3s;
        }
        .ctrl-btn:hover { background-color: #f082ac; }

        .grid-wrapper {
            background: #ffffff;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .grid-title {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(6, 150px);
            gap: 0;
        }

        .grid-cell {
            width: 150px;
            height: 240px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border-right: 2px solid #333;
            border-bottom: 2px solid #333;
            background: #fff;
            display: flex;
            flex-direction: column;
        }
        .grid-cell:hover {
            z-index: 10;
        }
        .grid-cell.selected {
            z-index: 10;
        }

        /* Ê†ºÂ≠êÊÇ¨ÂÅúÊïàÊûú - ÊûÅÁÆÄ */
        .cell-hover-overlay {
            position: absolute;
            inset: 0;
            background: rgba(234, 76, 137, 0.08);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 1;
        }
        .grid-cell:hover .cell-hover-overlay {
            opacity: 1;
        }
        /* ÊúâÂ∞ÅÈù¢ÁöÑÊ†ºÂ≠êÊÇ¨ÂÅúÊó∂ÂæÆÊöó */
        .grid-cell.has-cover .cell-hover-overlay {
            background: rgba(0, 0, 0, 0.15);
        }

        /* È¶ñË°åÈ¶ñÂàóËæπÊ°Ü */
        .grid-cell:nth-child(6n+1) { border-left: 2px solid #333; }
        .grid-cell:nth-child(-n+6) { border-top: 2px solid #333; }

        .cell-img-area {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
        }
        .cell-img-area img {
            position: absolute;
            image-rendering: auto;
            transition: transform 0.3s;
        }
        .grid-cell:hover .cell-img-area img {
            transform: scale(1.03);
        }
        .cell-img-area .placeholder {
            color: #ccc;
            font-size: 28px;
            user-select: none;
        }

        /* Ê†ºÂ≠êÊÇ¨ÂÅúÂ∑•ÂÖ∑Ê†è */
        .cell-toolbar {
            position: absolute;
            top: 4px;
            right: 4px;
            display: flex;
            gap: 3px;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 3;
        }
        .grid-cell:hover .cell-toolbar { opacity: 1; }
        .cell-tool-btn {
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.55);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: background 0.15s;
        }
        .cell-tool-btn:hover {
            background: #ea4c89;
        }
        .cell-tool-btn.danger:hover { background: #ff6b6b; }

        .cell-label {
            height: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-top: 1px solid #ccc;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            padding: 0 4px;
        }

        /* ========== Â∞ÅÈù¢ÈÄâÊã©ÂºπÁ™ó ========== */
        .cover-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.55);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .cover-modal.active { display: flex; }

        .cover-modal-inner {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 18px 20px;
            max-width: 960px;
            max-height: 92vh;
            overflow: hidden;
            width: 94%;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        .cover-modal-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            text-align: center;
            flex-shrink: 0;
        }
        .cover-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            padding: 4px 6px;
        }
        .cover-item {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid #ddd;
            aspect-ratio: 3/4;
            border-radius: 4px;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
        }
        .cover-item:hover {
            border-color: #ea4c89;
            box-shadow: 0 0 10px rgba(234,76,137,0.35);
            transform: scale(1.03);
            z-index: 1;
        }
        .cover-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: auto;
        }
        .cover-modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 14px;
            flex-shrink: 0;
        }
        .cover-modal-btn {
            padding: 7px 24px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        .cover-modal-btn.close-btn { background: #eee; color: #555; }
        .cover-modal-btn.close-btn:hover { background: #ddd; }
        .cover-modal-btn.clear-btn { background: #ff6b6b; color: #fff; }
        .cover-modal-btn.clear-btn:hover { background: #ee5a5a; }

        .no-covers-msg {
            text-align: center;
            color: #999;
            padding: 36px 20px;
            font-size: 13px;
            line-height: 2;
            grid-column: 1 / -1;
        }

        /* Â∞ÅÈù¢Â∑•ÂÖ∑Ê†è */
        .cover-toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin-bottom: 8px;
        }
        .cover-tool-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border: 1.5px solid #ddd;
            border-radius: 6px;
            background: #fff;
            font-size: 11px;
            font-weight: bold;
            color: #555;
            cursor: pointer;
            transition: all 0.15s;
        }
        .cover-tool-btn:hover { border-color: #ea4c89; color: #ea4c89; }
        .cover-tool-btn:active { background: #fce4ec; }
        .cover-tool-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Tab ÂàáÊç¢ */
        .modal-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #eee;
            flex-shrink: 0;
        }
        .modal-tab {
            flex: 1;
            padding: 10px 0;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            background: none;
            border-top: none; border-left: none; border-right: none;
        }
        .modal-tab:hover { color: #666; }
        .modal-tab.active {
            color: #ea4c89;
            border-bottom-color: #ea4c89;
        }
        .tab-panel { display: none; }
        .tab-panel.active {
            display: block;
            flex: 1 1 auto;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding-right: 6px;
        }
        .tab-panel.active::-webkit-scrollbar { width: 6px; }
        .tab-panel.active::-webkit-scrollbar-track { background: transparent; }
        .tab-panel.active::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
        .tab-panel.active::-webkit-scrollbar-thumb:hover { background: #ccc; }

        /* ÊêúÁ¥¢Èù¢ÊùøÔºàÂç†‰ΩçÔºåÂêéÁª≠ËøÅÁßªÔºâ */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-bar input:focus { border-color: #ea4c89; }
        .search-bar select {
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
            outline: none;
        }
        .search-bar select:focus { border-color: #ea4c89; }
        .search-bar button {
            padding: 8px 18px;
            background: #ea4c89;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }
        .search-bar button:hover { background: #f082ac; }
        .search-bar button:disabled { background: #ccc; cursor: not-allowed; }

        .search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 6px;
        }
        .search-item {
            cursor: pointer;
            border: 2px solid #eee;
            border-radius: 6px;
            overflow: hidden;
            transition: border-color 0.15s, box-shadow 0.15s;
            background: #fff;
        }
        .search-item:hover {
            border-color: #ea4c89;
            box-shadow: 0 2px 10px rgba(234,76,137,0.2);
        }
        .search-item-img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            display: block;
            background: #f5f5f5;
        }
        .search-item-info {
            padding: 2px 4px 1px;
        }
        .search-item-name {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .search-item-sub {
            font-size: 9px;
            color: #999;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: none;
        }
        .search-status {
            text-align: center;
            padding: 36px 20px;
            color: #aaa;
            font-size: 13px;
            line-height: 1.8;
        }
        .search-status-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 8px;
            opacity: 0.5;
        }
        .search-status .spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 3px solid #eee;
            border-top-color: #ea4c89;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-bottom: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‰∏ãËΩΩ‰∏≠Ë¶ÜÁõñÂ±Ç */
        .download-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .download-overlay-box {
            background: #fff;
            padding: 24px 36px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .download-overlay-box .spinner {
            width: 28px; height: 28px;
            border: 3px solid #eee;
            border-top-color: #ea4c89;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin: 0 auto 10px;
        }

        /* Ê†áÁ≠æÊµèËßà */
        .tag-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        .tag-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            background: #fce4ec;
            color: #c62828;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .tag-badge .remove-tag {
            cursor: pointer;
            font-size: 14px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .tag-badge .remove-tag:hover { opacity: 1; }
        .result-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #999;
        }
        .search-item-meta {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 1px 4px 3px;
        }
        .search-item-type {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 3px;
            font-weight: bold;
            background: #e3f2fd;
            color: #1565c0;
        }
        .search-item-type.type-anime { background: #e3f2fd; color: #1565c0; }
        .search-item-type.type-game  { background: #fce4ec; color: #c62828; }
        .search-item-type.type-manga { background: #fff3e0; color: #e65100; }
        .search-item-type.type-novel { background: #f3e5f5; color: #7b1fa2; }
        .search-item-score {
            font-size: 10px;
            color: #ff9800;
            font-weight: bold;
        }
        /* Êù•Ê∫êÂæΩÁ´† */
        .source-badge {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        .source-badge.source-bgm  { background: #e8f0fe; color: #3b6ece; }
        .source-badge.source-vndb { background: #f3e5f5; color: #7b1fa2; }
        .load-more-wrapper {
            text-align: center;
            padding: 16px 0;
            grid-column: 1 / -1;
        }
        .load-more-btn {
            padding: 8px 32px;
            background: #fff;
            border: 2px solid #ea4c89;
            color: #ea4c89;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .load-more-btn:hover {
            background: #ea4c89;
            color: #fff;
        }
        .load-more-btn:disabled { background: #eee; border-color: #ccc; color: #999; cursor: not-allowed; }

        /* Á±ªÂûãÁ≠õÈÄâ */
        .type-filter-row {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .type-btn {
            padding: 4px 14px;
            border: 1.5px solid #ddd;
            border-radius: 14px;
            background: #fff;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            color: #555;
            transition: all 0.15s;
        }
        .type-btn:hover { border-color: #ea4c89; color: #ea4c89; }
        .type-btn.active {
            background: #ea4c89;
            border-color: #ea4c89;
            color: #fff;
        }

        /* Êï∞ÊçÆÊ∫êÈÄâÊã© */
        .source-selector-row {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
            padding-bottom: 14px;
            border-bottom: 1px solid #f0f0f0;
        }
        .source-btn-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }
        .source-btn {
            padding: 7px 22px;
            border: 2px solid #ddd;
            border-radius: 18px;
            background: #fff;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            color: #555;
            transition: all 0.2s;
        }
        .source-btn:hover { border-color: #ea4c89; color: #ea4c89; background: #fff5f8; }
        .source-btn.active {
            background: #ea4c89;
            border-color: #ea4c89;
            color: #fff;
            box-shadow: 0 2px 8px rgba(234,76,137,0.25);
        }
        .source-desc {
            font-size: 10px;
            color: #b0b0b0;
            white-space: nowrap;
            transition: color 0.15s;
        }
        .source-btn-wrap:has(.source-btn.active) .source-desc {
            color: #e06090;
        }

        /* Èù¢ÊùøÂå∫ÂùóÊ†áÈ¢ò */
        .section-label {
            font-size: 12px;
            color: #888;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .section-label::before {
            content: '';
            width: 3px;
            height: 13px;
            background: #ea4c89;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .section-label .section-hint {
            font-weight: 400;
            color: #bbb;
            margin-left: 2px;
        }

        /* VNDB ÂºïÂØºÊèêÁ§∫ */
        .vndb-guide {
            background: linear-gradient(135deg, #f8f0ff 0%, #f0f4ff 100%);
            border: 1px solid #e8dff5;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 12px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .vndb-guide-icon {
            font-size: 18px;
            flex-shrink: 0;
            line-height: 1.4;
        }
        .vndb-guide-text {
            font-size: 12px;
            color: #666;
            line-height: 1.7;
        }
        .vndb-guide-text strong {
            color: #7b1fa2;
        }

        /* ÂàÜÈ°µ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            padding: 12px 0 4px;
            flex-wrap: wrap;
            grid-column: 1 / -1;
        }
        .page-btn {
            min-width: 32px;
            height: 32px;
            padding: 0 8px;
            border: 1.5px solid #ddd;
            border-radius: 6px;
            background: #fff;
            font-size: 13px;
            cursor: pointer;
            color: #555;
            transition: all 0.15s;
        }
        .page-btn:hover { border-color: #ea4c89; color: #ea4c89; }
        .page-btn.active { background: #ea4c89; border-color: #ea4c89; color: #fff; font-weight: bold; }
        .page-btn:disabled { background: #f5f5f5; color: #ccc; cursor: not-allowed; border-color: #eee; }
        .page-ellipsis { color: #aaa; font-size: 13px; padding: 0 4px; }

        /* Ê†áÁ≠æÊµèËßàÂô® */
        .tag-browser {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 8px 10px;
            background: #fafafa;
            margin-bottom: 8px;
        }
        .tag-cat-row {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 4px;
        }
        .tag-cat-row:last-child { margin-bottom: 0; }
        .tag-cat-label {
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            min-width: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 3px;
            padding-top: 3px;
            flex-shrink: 0;
        }
        .tag-cat-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .tag-cat-group {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .tag-pick-btn {
            padding: 2px 8px;
            border: 1.5px solid #ddd;
            border-radius: 12px;
            background: #fff;
            font-size: 12px;
            cursor: pointer;
            color: #555;
            transition: all 0.15s;
            line-height: 1.5;
        }
        .tag-pick-btn:hover { border-color: #ea4c89; color: #ea4c89; }
        .tag-pick-btn.active {
            background: #ea4c89;
            border-color: #ea4c89;
            color: #fff;
        }
        .search-sort-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        .search-sort-row label {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
        }
        .sort-select {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
            outline: none;
        }
        .sort-select:focus { border-color: #ea4c89; }

        /* Ë£ÅÂâ™ÁºñËæëÂô® */
        .crop-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.78);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .crop-modal.active { display: flex; }
        .crop-modal-inner {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            width: min(700px, 95vw);
            max-height: 94vh;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.45);
        }
        .crop-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .crop-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 80%;
        }
        .crop-close-x {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #aaa;
            padding: 0 2px;
            line-height: 1;
        }
        .crop-close-x:hover { color: #333; }
        .crop-body {
            display: flex;
            gap: 14px;
            align-items: stretch;
        }
        .crop-workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .crop-stage {
            background: #1c1c1c;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        .crop-viewport {
            width: min(360px, 65vw);
            aspect-ratio: 3 / 4;
            max-height: 56vh;
            overflow: hidden;
            position: relative;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.18);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
            cursor: move;
            background: #000;
            touch-action: none;
            transition: border-color 0.15s;
        }
        .crop-viewport:hover {
            border-color: rgba(234,76,137,0.4);
        }
        .crop-viewport.dragging {
            cursor: move;
            border-color: rgba(234,76,137,0.7);
        }
        .crop-img {
            position: absolute;
            user-select: none;
            pointer-events: none;
        }
        .crop-grid-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            background-image:
                linear-gradient(to right, rgba(255,255,255,0.6) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.6) 1px, transparent 1px);
            background-size: 33.333% 33.333%;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.4);
        }
        .crop-center-mark {
            position: absolute;
            top: 50%; left: 50%;
            width: 20px; height: 20px;
            margin: -10px 0 0 -10px;
            pointer-events: none;
            z-index: 2;
            opacity: 0.6;
            transition: opacity 0.15s;
        }
        .crop-center-mark::before,
        .crop-center-mark::after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 3px rgba(0,0,0,0.7);
            border-radius: 1px;
        }
        .crop-center-mark::before {
            left: 0; right: 0; top: 50%;
            height: 2px; margin-top: -1px;
        }
        .crop-center-mark::after {
            top: 0; bottom: 0; left: 50%;
            width: 2px; margin-left: -1px;
        }
        .crop-viewport:hover .crop-center-mark,
        .crop-viewport.dragging .crop-center-mark { opacity: 1; }
        .crop-controls {
            background: #f7f7f7;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .crop-control {
            display: grid;
            grid-template-columns: 66px 1fr 42px;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }
        .crop-control input[type="range"] {
            width: 100%;
            accent-color: #ea4c89;
        }
        .crop-control-value {
            text-align: right;
            font-variant-numeric: tabular-nums;
            color: #333;
            font-weight: bold;
        }
        .crop-side {
            width: 180px;
            min-width: 180px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .crop-preview-card {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        .crop-preview-title {
            font-size: 12px;
            color: #777;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .crop-preview-box {
            width: 126px;
            aspect-ratio: 3 / 4;
            border: 1.5px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            margin: 0 auto;
            position: relative;
            background: #111;
        }
        .crop-preview-tip {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            line-height: 1.5;
        }
        .crop-hint {
            font-size: 11px;
            color: #888;
            line-height: 1.6;
        }
        .crop-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .crop-reset-btn {
            padding: 7px 18px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            color: #666;
        }
        .crop-reset-btn:hover { border-color: #bbb; background: #f8f8f8; }
        .crop-cancel-btn {
            padding: 7px 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 13px;
        }
        .crop-save-btn {
            padding: 7px 22px;
            border: none;
            border-radius: 5px;
            background: #ea4c89;
            color: #fff;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        .crop-save-btn:hover { background: #d93a77; }
        .crop-save-btn:disabled { background: #ccc; cursor: not-allowed; }

        #exportCanvas { display: none; }

        /* ========== Êô∫ËÉΩÊé®ËçêÁ≥ªÁªü ========== */
        .spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 3px solid #eee;
            border-top-color: #ea4c89;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        .fill-progress-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #888;
        }
        .fill-progress-bar .bar-track {
            flex: 1;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        .fill-progress-bar .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ea4c89, #f082ac);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .fill-progress-bar .bar-text {
            font-weight: bold;
            color: #ea4c89;
            white-space: nowrap;
            min-width: 70px;
        }

        /* ========== Âø´ÈÄüÊêúÁ¥¢Ê®°ÊÄÅÊ°Ü ========== */
        .quick-search-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0);
            z-index: 950;
            transition: background 0.25s;
            pointer-events: none;
        }
        .quick-search-backdrop.active {
            background: rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }
        .quick-search-popup {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) translateY(8px);
            z-index: 960;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.18);
            width: 520px;
            max-width: 92vw;
            max-height: 78vh;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .quick-search-popup.active {
            opacity: 1;
            transform: translate(-50%, -50%) translateY(0);
            pointer-events: auto;
        }
        .quick-search-header {
            padding: 14px 16px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .quick-search-icon { display: none; }
        .quick-search-header-info { flex: 1; }
        .quick-search-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }
        .quick-search-subtitle {
            font-size: 11px;
            color: #aaa;
        }
        .quick-search-close {
            width: 26px;
            height: 26px;
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
            color: #bbb;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.15s;
            border-radius: 4px;
        }
        .quick-search-close:hover { color: #ea4c89; background: #fce4ec; }
        .quick-search-body {
            padding: 0 16px 10px;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .quick-search-input-wrap {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        .quick-search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.15s;
        }
        .quick-search-input:focus { border-color: #ea4c89; }
        .quick-search-btn {
            padding: 8px 14px;
            background: #ea4c89;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }
        .quick-search-btn:hover { background: #d63d7a; }
        .quick-search-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .quick-search-results {
            flex: 1;
            overflow-y: auto;
            margin: 0 -4px;
            padding: 0 4px 4px;
        }
        .quick-search-results::-webkit-scrollbar { width: 4px; }
        .quick-search-results::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }

        /* ÂàóË°®ÂºèÁªìÊûúÈ°π */
        .qs-list { display: flex; flex-direction: column; gap: 6px; }
        .qs-item {
            display: flex;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.12s;
            align-items: flex-start;
        }
        .qs-item:hover { background: #fce4ec; }
        .qs-item-cover {
            width: 48px;
            height: 64px;
            flex-shrink: 0;
            border-radius: 4px;
            overflow: hidden;
            background: #f5f5f5;
        }
        .qs-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .qs-item-body {
            flex: 1;
            min-width: 0;
        }
        .qs-item-name {
            font-size: 13px;
            font-weight: 500;
            color: #222;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .qs-item-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 2px;
            font-size: 11px;
            color: #999;
        }
        .qs-item-score { color: #ff9800; font-weight: 500; }
        .qs-item-type {
            padding: 1px 5px;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 10px;
            color: #777;
        }
        .qs-item-desc {
            font-size: 11px;
            color: #999;
            line-height: 1.4;
            margin-top: 3px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .quick-search-loading, .quick-search-empty {
            text-align: center;
            padding: 30px 16px;
            color: #bbb;
            font-size: 12px;
        }
        .quick-search-loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f0f0f0;
            border-top-color: #ea4c89;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin: 0 auto 8px;
        }
        .quick-search-hint {
            font-size: 12px;
            color: #ccc;
            text-align: center;
            padding: 24px 16px;
        }
        .quick-search-footer {
            display: flex;
            gap: 8px;
            padding: 8px 16px 10px;
            border-top: 1px solid #f0f0f0;
            flex-shrink: 0;
        }
        .quick-search-action-btn {
            flex: 1;
            padding: 7px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fff;
            font-size: 12px;
            cursor: pointer;
            color: #666;
            transition: all 0.12s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .quick-search-action-btn:hover {
            border-color: #ea4c89;
            color: #ea4c89;
            background: #fff5f8;
        }
        .quick-search-action-btn.primary {
            background: #ea4c89;
            border-color: #ea4c89;
            color: #fff;
        }
        .quick-search-action-btn.primary:hover {
            background: #d63d7a;
        }

        /* ========== ‰æßËæπÊäΩÂ±âÈù¢Êùø ========== */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0);
            z-index: 900;
            transition: background 0.3s ease;
            pointer-events: none;
        }
        .drawer-backdrop.active {
            background: rgba(0, 0, 0, 0.4);
            pointer-events: auto;
        }
        .cell-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 420px;
            max-width: 90vw;
            height: 100vh;
            background: #fff;
            z-index: 901;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -8px 0 40px rgba(0, 0, 0, 0.15);
        }
        .cell-drawer.active {
            transform: translateX(0);
        }
        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px 16px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }
        .drawer-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .drawer-title-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ea4c89, #f082ac);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 16px;
        }
        .drawer-close {
            width: 36px;
            height: 36px;
            border: none;
            background: #f5f5f5;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .drawer-close:hover {
            background: #ea4c89;
            color: #fff;
            transform: rotate(90deg);
        }
        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }
        .drawer-body::-webkit-scrollbar { width: 6px; }
        .drawer-body::-webkit-scrollbar-track { background: transparent; }
        .drawer-body::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
        .drawer-body::-webkit-scrollbar-thumb:hover { background: #ccc; }
        .drawer-current {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #fef6f9 0%, #f8f4ff 100%);
            border-radius: 12px;
            margin-bottom: 20px;
            animation: fadeInUp 0.4s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .drawer-current-img {
            width: 80px;
            height: 107px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        .drawer-current-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }
        .drawer-current-name {
            font-size: 15px;
            font-weight: bold;
            color: #333;
            line-height: 1.4;
        }
        .drawer-current-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .drawer-action-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: #555;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .drawer-action-btn:hover {
            border-color: #ea4c89;
            color: #ea4c89;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 76, 137, 0.2);
        }
        .drawer-action-btn.danger:hover {
            border-color: #ff6b6b;
            color: #ff6b6b;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
        }
        .drawer-section {
            margin-bottom: 20px;
        }
        .drawer-section-title {
            font-size: 13px;
            font-weight: 700;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .drawer-section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(135deg, #ea4c89, #f082ac);
            border-radius: 2px;
        }
        .drawer-rec-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .drawer-rec-item {
            cursor: pointer;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fff;
            position: relative;
        }
        .drawer-rec-item:hover {
            border-color: #ea4c89;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(234, 76, 137, 0.2);
        }
        .drawer-rec-item::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #ea4c89;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s;
        }
        .drawer-rec-item:hover::after {
            opacity: 1;
            transform: scale(1);
        }
        .drawer-rec-img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            display: block;
            background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
        }
        .drawer-rec-info {
            padding: 8px 10px;
        }
        .drawer-rec-name {
            font-size: 11px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .drawer-rec-meta {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .drawer-rec-score {
            font-size: 11px;
            color: #ff9800;
            font-weight: bold;
        }
        .drawer-rec-type {
            font-size: 10px;
            padding: 2px 6px;
            background: #f0f0f0;
            color: #666;
            border-radius: 4px;
        }
        .drawer-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #999;
        }
        .drawer-loading .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f0f0f0;
            border-top-color: #ea4c89;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        .drawer-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .drawer-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        .drawer-footer {
            padding: 16px 24px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            background: #fafafa;
        }
        .drawer-footer-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: #555;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .drawer-footer-btn:hover {
            border-color: #ea4c89;
            color: #ea4c89;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(234, 76, 137, 0.15);
        }
        .drawer-footer-btn.primary {
            background: linear-gradient(135deg, #ea4c89, #f082ac);
            border-color: transparent;
            color: #fff;
        }
        .drawer-footer-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(234, 76, 137, 0.35);
        }
        /* ËÑâÂÜ≤Âä®Áîª */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .pulse {
            animation: pulse 0.3s ease;
        }
        /* ÊàêÂäüÂèçÈ¶àÂä®Áîª */
        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .success-pop {
            animation: successPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .fill-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fill-overlay-box {
            background: #fff;
            padding: 30px 50px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            min-width: 320px;
        }
        .fill-overlay-box .fill-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0 10px;
        }
        .fill-overlay-box .fill-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #ea4c89, #f082ac);
            border-radius: 4px;
            transition: width 0.15s;
        }
        .fill-overlay-box .fill-text {
            font-size: 15px;
            font-weight: bold;
            color: #333;
        }
        .fill-overlay-box .fill-sub {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        .ctrl-btn.secondary-btn {
            background: #f5f5f5;
            color: #666;
            box-shadow: none;
            border: 1px solid #ddd;
        }
        .ctrl-btn.secondary-btn:hover { background: #e8e8e8; color: #333; }
    </style>
</head>
<body>

    <div class="grid-wrapper">
        <div class="grid-title">ACGNÁîüÊ∂Ø‰∏™‰∫∫ÂñúÂ•ΩË°®</div>
        <div class="fill-progress-bar" id="progressBar">
            <span class="bar-text" id="progressText">Â∑≤Â°´ 0/60</span>
            <div class="bar-track"><div class="bar-fill" id="progressFill" style="width:0%"></div></div>
        </div>
        <div class="grid-container" id="gridContainer"></div>
    </div>

    <div class="ctrl-box">
        <button class="ctrl-btn" onclick="saveImage()">üíæ ‰øùÂ≠ò‰∏∫ÂõæÁâá</button>
        <button class="ctrl-btn secondary-btn" onclick="clearAll()">üóëÔ∏è ÂÖ®ÈÉ®Ê∏ÖÁ©∫</button>
    </div>

    <!-- Âø´ÈÄüÊêúÁ¥¢Ê®°ÊÄÅÊ°Ü -->
    <div class="quick-search-backdrop" id="quickSearchBackdrop" onclick="hideQuickSearch()"></div>
    <div class="quick-search-popup" id="quickSearchPopup">
        <div class="quick-search-header">
            <div class="quick-search-header-info">
                <div class="quick-search-title" id="quickSearchTitle">ÈÄâÊã©‰ΩúÂìÅ</div>
                <div class="quick-search-subtitle">ÊêúÁ¥¢ÊàñÊµèËßàÊé®Ëçê</div>
            </div>
            <button class="quick-search-close" onclick="hideQuickSearch()">‚úï</button>
        </div>
        <div class="quick-search-body">
            <div class="quick-search-input-wrap">
                <input type="text" class="quick-search-input" id="quickSearchInput" placeholder="ËæìÂÖ•‰ΩúÂìÅÂêçÁß∞ÊêúÁ¥¢..." onkeydown="if(event.key==='Enter') doQuickSearch()">
                <button class="quick-search-btn" id="quickSearchBtn" onclick="doQuickSearch()">ÊêúÁ¥¢</button>
            </div>
            <div class="quick-search-results" id="quickSearchResults">
                <div class="quick-search-hint">ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢ÔºåÊàñÁÇπÂáª‰∏ãÊñπ„ÄåÊé®Ëçê„ÄçÊµèËßàÁÉ≠Èó®‰ΩúÂìÅ</div>
            </div>
        </div>
        <div class="quick-search-footer">
            <button class="quick-search-action-btn" onclick="quickSearchShowRec()">üé≤ Êé®Ëçê</button>
            <button class="quick-search-action-btn" onclick="quickSearchRefresh()" id="quickSearchRefreshBtn" style="display:none">üîÑ Êç¢‰∏ÄÊâπ</button>
            <button class="quick-search-action-btn" onclick="quickSearchOpenFull()">üîç È´òÁ∫ßÁ≠õÈÄâ</button>
        </div>
    </div>

    <!-- ‰æßËæπÊäΩÂ±âÈù¢Êùø -->
    <div class="drawer-backdrop" id="drawerBackdrop" onclick="hideDrawer()"></div>
    <div class="cell-drawer" id="cellDrawer">
        <div class="drawer-header">
            <div class="drawer-title">
                <span class="drawer-title-icon">üéØ</span>
                <span id="drawerTitle">ÈÄâÊã©‰ΩúÂìÅ</span>
            </div>
            <button class="drawer-close" onclick="hideDrawer()" title="ÂÖ≥Èó≠ (ESC)">‚úï</button>
        </div>
        <div class="drawer-body">
            <!-- ÂΩìÂâçÂ∑≤ÈÄâ‰ΩúÂìÅ -->
            <div id="drawerCurrentSection" style="display:none">
                <div class="drawer-current">
                    <img class="drawer-current-img" id="drawerCurrentImg" src="" alt="">
                    <div class="drawer-current-info">
                        <div class="drawer-current-name" id="drawerCurrentName">ÂΩìÂâç‰ΩúÂìÅ</div>
                        <div class="drawer-current-actions">
                            <button class="drawer-action-btn" onclick="drawerCrop()">‚úÇÔ∏è Ë£ÅÂâ™Ë∞ÉÊï¥</button>
                            <button class="drawer-action-btn danger" onclick="drawerClear()">üóëÔ∏è Ê∏ÖÈô§</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Êé®Ëçê‰ΩúÂìÅÂå∫ -->
            <div class="drawer-section">
                <div class="drawer-section-title">üî• ‰∏∫‰Ω†Êé®Ëçê</div>
                <div class="drawer-rec-grid" id="drawerRecGrid"></div>
            </div>
        </div>
        <div class="drawer-footer">
            <button class="drawer-footer-btn" id="drawerMoreBtn" onclick="drawerLoadMore()">üîÑ Êç¢‰∏ÄÊâπ</button>
            <button class="drawer-footer-btn primary" onclick="drawerOpenFullModal()">üîç ÂÆåÊï¥ÊêúÁ¥¢</button>
        </div>
    </div>

    <!-- Â∞ÅÈù¢ÈÄâÊã©ÂºπÁ™ó -->
    <div class="cover-modal" id="coverModal">
        <div class="cover-modal-inner">
            <div class="cover-modal-title" id="modalTitle">ÈÄâÊã©Â∞ÅÈù¢</div>

            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="covers" onclick="switchTab('covers')">üìÅ Â∑≤ÊúâÂ∞ÅÈù¢</button>
                <button class="modal-tab" data-tab="search" onclick="switchTab('search')">üîç ÊêúÁ¥¢‰ΩúÂìÅ</button>
            </div>

            <!-- Â∑≤ÊúâÂ∞ÅÈù¢ -->
            <div class="tab-panel active" id="tabCovers">
                <div class="cover-toolbar">
                    <button class="cover-tool-btn" onclick="triggerUploadCover()" title="‰ªéÊú¨Âú∞ÂØºÂÖ•ÂõæÁâáÂà∞ covers ÁõÆÂΩï">üìÇ ÂØºÂÖ•Â∞ÅÈù¢</button>
                    <button class="cover-tool-btn" onclick="refreshCovers()" title="Âà∑Êñ∞ covers ÁõÆÂΩïÔºàÊãñÂÖ•Êñ∞Êñá‰ª∂ÂêéÁÇπÂáªÔºâ">üîÑ Âà∑Êñ∞</button>
                </div>
                <input type="file" id="uploadCoverInput" accept="image/*" multiple style="display:none" onchange="handleUploadFiles(this.files)">
                <div class="cover-grid" id="coverGrid"></div>
            </div>

            <!-- ÊêúÁ¥¢‰ΩúÂìÅ -->
            <div class="tab-panel" id="tabSearch">
                <!-- Êï∞ÊçÆÊ∫êÈÄâÊã© -->
                <div class="section-label">ÈÄâÊã©Êï∞ÊçÆÊù•Ê∫ê</div>
                <div class="source-selector-row">
                    <div class="source-btn-wrap">
                        <button class="source-btn active" data-source="bgm" onclick="setSource('bgm')"
                            title="Bangumi Áï™ÁªÑËÆ°Âàí ‚Äî ÁªºÂêàÊÄß ACGN ‰ø°ÊÅØÁ´ôÔºåÊî∂ÂΩïÂä®Áîª„ÄÅÊº´Áîª„ÄÅÊ∏∏Êàè„ÄÅÈü≥‰πê„ÄÅÂ∞èËØ¥Á≠âÊù°ÁõÆÔºåÊã•Êúâ‰∏∞ÂØåÁöÑÊ†áÁ≠æÂíåËØÑÂàÜ‰ΩìÁ≥ª">üì∫ Bangumi</button>
                        <span class="source-desc">Âä®Áîª / Êº´Áîª / Ê∏∏Êàè / Â∞èËØ¥</span>
                    </div>
                    <div class="source-btn-wrap">
                        <button class="source-btn" data-source="vndb" onclick="setSource('vndb')"
                            title="VNDB (The Visual Novel Database) ‚Äî ÂÖ®ÁêÉÊúÄÂ§ßÁöÑËßÜËßâÂ∞èËØ¥Êï∞ÊçÆÂ∫ìÔºå‰∏ìÊ≥®Êî∂ÂΩï Galgame ‰∏éËßÜËßâÂ∞èËØ¥‰ΩúÂìÅÔºåÊîØÊåÅ‰∏≠Êó•Ëã±ÂêçÁß∞ÊêúÁ¥¢">üéÆ VNDB</button>
                        <span class="source-desc">Galgame / ËßÜËßâÂ∞èËØ¥</span>
                    </div>
                </div>

                <!-- Bangumi ‰∏ìÂ±ûÊéß‰ª∂ÔºàVNDB Ê®°Âºè‰∏ãÈöêËóèÔºâ -->
                <div id="bgmControls">
                    <div class="section-label">È¢òÊùêÊ†áÁ≠æ <span class="section-hint">‚Äî ÁÇπÂáªÊ∑ªÂä†Ê†áÁ≠æÁªÑÂêàÁ≠õÈÄâÔºåÂèØÂ§öÈÄâ</span></div>
                    <div class="tag-browser" id="tagBrowser"></div>
                    <div class="tag-badges" id="tagBadges"></div>
                    <div class="section-label">Á±ªÂûãÁ≠õÈÄâ</div>
                    <div class="type-filter-row" id="typeFilterRow">
                        <button class="type-btn active" data-type="all" onclick="setSubjectType('all')">üì¶ ÂÖ®ÈÉ®</button>
                        <button class="type-btn" data-type="anime" onclick="setSubjectType('anime')">üé• Âä®Áîª</button>
                        <button class="type-btn" data-type="manga" onclick="setSubjectType('manga')">üìñ Êº´Áîª</button>
                        <button class="type-btn" data-type="novel" onclick="setSubjectType('novel')">üìù Â∞èËØ¥</button>
                        <button class="type-btn" data-type="game" onclick="setSubjectType('game')">üéÆ Ê∏∏Êàè</button>
                    </div>
                    <div class="section-label">ÊéíÂ∫èÊñπÂºè</div>
                    <div class="search-sort-row">
                        <select class="sort-select" id="sortSelect" onchange="onSortChange()">
                            <option value="rank">ÊåâÊéíÂêç</option>
                            <option value="score">ÊåâËØÑÂàÜ</option>
                            <option value="heat" selected>ÊåâÁÉ≠Â∫¶</option>
                            <option value="match">ÊåâÂåπÈÖçÂ∫¶ÔºàÈúÄÂÖ≥ÈîÆËØçÔºâ</option>
                        </select>
                    </div>
                </div><!-- /bgmControls -->

                <!-- VNDB ÂºïÂØºÊèêÁ§∫ÔºàBGM Ê®°Âºè‰∏ãÈöêËóèÔºâ -->
                <div id="vndbGuide" class="vndb-guide" style="display:none">
                    <div class="vndb-guide-icon">üí°</div>
                    <div class="vndb-guide-text">
                        <strong>VNDB ÊêúÁ¥¢ÊèêÁ§∫</strong>ÔºöÁõ¥Êé•ËæìÂÖ•ËßÜËßâÂ∞èËØ¥ÁöÑ‰∏≠ÊñáÂêç„ÄÅÊó•ÊñáÂéüÂêçÊàñËã±ÊñáÂêçËøõË°åÊêúÁ¥¢„ÄÇ
                        ÊîØÊåÅÊ®°Á≥äÂåπÈÖçÔºåÁªìÊûúÊåâÁõ∏ÂÖ≥Â∫¶ÊéíÂ∫è„ÄÇÁÇπÂáª‰ΩúÂìÅÂç°ÁâáÂç≥ÂèØ‰∏ãËΩΩÂ∞ÅÈù¢Âπ∂Â∫îÁî®Âà∞Ê†ºÂ≠ê‰∏≠„ÄÇ
                    </div>
                </div>

                <!-- ÂÖ≥ÈîÆËØçÊêúÁ¥¢ -->
                <div class="section-label" id="searchBarLabel">ÂÖ≥ÈîÆËØç <span class="section-hint">‚Äî ËæìÂÖ•‰ΩúÂìÅÂêçÁß∞Ëøõ‰∏ÄÊ≠•Á≠õÈÄâ</span></div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçËøõ‰∏ÄÊ≠•Á≠õÈÄâÔºàÂèØÈÄâÔºâ..." onkeydown="if(event.key==='Enter') doSearch()">
                    <button onclick="doSearch()" id="searchBtn">ÊêúÁ¥¢</button>
                </div>
                <!-- ÁªìÊûú‰ø°ÊÅØ -->
                <div id="resultInfo" class="result-info" style="display:none;"><span id="resultCount"></span></div>
                <!-- ÊêúÁ¥¢ÁªìÊûú -->
                <div id="searchResults">
                    <div class="search-status"><span class="search-status-icon">üîç</span>ÈÄâÊã©‰∏äÊñπÈ¢òÊùêÊ†áÁ≠æÔºåÊàñÁõ¥Êé•ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢</div>
                </div>
                <!-- ÂàÜÈ°µ -->
                <div id="pagination" class="pagination"></div>
            </div>

            <div class="cover-modal-actions">
                <button class="cover-modal-btn clear-btn" onclick="clearCover()">Ê∏ÖÈô§Â∞ÅÈù¢</button>
                <button class="cover-modal-btn close-btn" onclick="closeModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- Ë£ÅÂâ™ÂºπÁ™ó -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-modal-inner">
            <div class="crop-header">
                <div class="crop-title" id="cropTitle">Ë£ÅÂâ™Â∞ÅÈù¢</div>
                <button class="crop-close-x" onclick="closeCropModal()" aria-label="ÂÖ≥Èó≠">√ó</button>
            </div>
            <div class="crop-body">
                <div class="crop-workspace">
                    <div class="crop-stage">
                        <div class="crop-viewport" id="cropViewport">
                            <img id="cropImage" class="crop-img" alt="crop-source" draggable="false">
                            <div class="crop-grid-overlay"></div>
                            <div class="crop-center-mark"></div>
                        </div>
                    </div>
                    <div class="crop-controls">
                        <div class="crop-control">
                            <span>Áº©Êîæ</span>
                            <input id="cropZoom" type="range" min="100" max="300" step="1">
                            <span id="cropZoomValue" class="crop-control-value">100%</span>
                        </div>
                        <div class="crop-control">
                            <span>Ê®™Âêë</span>
                            <input id="cropX" type="range" min="0" max="100" step="1">
                            <span id="cropXValue" class="crop-control-value">50%</span>
                        </div>
                        <div class="crop-control">
                            <span>Á∫µÂêë</span>
                            <input id="cropY" type="range" min="0" max="100" step="1">
                            <span id="cropYValue" class="crop-control-value">50%</span>
                        </div>
                    </div>
                    <div class="crop-hint">ÊãñÊãΩÂõæÁâáÂèØÂø´ÈÄüË∞ÉÊï¥Ë£ÅÂâ™Âå∫ÂüüÔºõËØ•Êìç‰ΩúÂè™ÂΩ±ÂìçÂΩìÂâçÊ†ºÂ≠êÊòæÁ§∫Ôºå‰∏ç‰ºö‰øÆÊîπ covers ÂéüÂõæ„ÄÇ</div>
                </div>
                <div class="crop-side">
                    <div class="crop-preview-card">
                        <div class="crop-preview-title">Ë£ÅÂâ™È¢ÑËßà</div>
                        <div class="crop-preview-box">
                            <img id="cropPreviewImage" class="crop-img" alt="crop-preview" draggable="false">
                        </div>
                        <div class="crop-preview-tip">È¢ÑËßà‰∏éÊ†ºÂ≠êÊòæÁ§∫ÂèäÂØºÂá∫‰øùÊåÅ‰∏ÄËá¥„ÄÇ</div>
                    </div>
                </div>
            </div>
            <div class="crop-actions">
                <button class="crop-reset-btn" onclick="resetCropDraft()">ÈáçÁΩÆ</button>
                <button class="crop-cancel-btn" onclick="closeCropModal()">ÂèñÊ∂à</button>
                <button class="crop-save-btn" onclick="saveCropDraft()">Â∫îÁî®Ë£ÅÂâ™</button>
            </div>
        </div>
    </div>

    <canvas id="exportCanvas"></canvas>



    <!-- Â°´ÂÖÖËøõÂ∫¶ -->
    <div class="fill-overlay" id="fillOverlay" style="display:none">
        <div class="fill-overlay-box">
            <div class="fill-text" id="fillText">Ê≠£Âú®‰∏∫‰Ω†ÊåëÈÄâ‰ΩúÂìÅ...</div>
            <div class="fill-bar"><div class="fill-bar-inner" id="fillBarInner" style="width:0%"></div></div>
            <div class="fill-sub" id="fillSub">0/60</div>
        </div>
    </div>

<script>
    // texts ÂÆö‰πâ 6√ó10 ÁΩëÊ†ºÁöÑ 60 ‰∏™ÂàÜÁ±ªÊ†áÁ≠æ„ÄÇ
    const texts = [
        "ÂÖ•Âùë‰Ωú", "ÊúÄÂñúÊ¨¢", "ÁúãÊúÄÂ§öÊ¨°", "ÊúÄÊÉ≥ÂÆâÂà©", "ÊúÄ‰∏ÄÁúºÁºò", "ÊúÄÈúáÊíº",
        "ÊúÄÊ≤ªÊÑà", "ÊúÄÊêûÁ¨ë", "ÊúÄÊÑüÂä®", "ÊúÄÁÉ≠Ë°Ä", "ÊúÄËá¥ÈÉÅ", "ÊúÄÁîµÊ≥¢",
        "ÊúÄ‰Ω≥ÂâßÊÉÖ", "ÊúÄ‰Ω≥ÊºîÂá∫", "ÊúÄ‰Ω≥Èü≥‰πê", "ÊúÄ‰Ω≥‰∏ñÁïåËßÇ", "ÊúÄ‰Ω≥ËßíËâ≤Â°ëÈÄ†", "Êâ≠ÁöÑÊúÄÂéâÂÆ≥",
        "ÊúÄ‰Ω≥ÊÅãÁà±", "ÊúÄ‰Ω≥‰øÆÁΩóÂú∫", "ÊúÄ‰Ω≥ÂêéÂÆ´", "ÊúÄ‰Ω≥ÁôæÂêà", "ÊúÄ‰Ω≥ËÄΩÁæé", "ÊúÄ‰Ω≥Áæ§ÂÉè",
        "ÊúÄ‰Ω≥Êó•Â∏∏", "ÊúÄ‰Ω≥Ê†°Âõ≠", "ÊúÄ‰Ω≥ËøêÂä®", "ÊúÄ‰Ω≥ÊàòÊñó", "ÊúÄ‰Ω≥Êô∫Êñó", "ÊúÄ‰Ω≥ÊÇ¨Áñë",
        "ÊúÄ‰Ω≥Â•áÂπª", "ÊúÄ‰Ω≥ÁßëÂπª", "ÊúÄ‰Ω≥Êú∫Áî≤", "ÊúÄ‰Ω≥ÂÜíÈô©", "ÊúÄ‰Ω≥Âè≤ËØó", "ÊúÄ‰Ω≥Êú´Êó•",
        "ÊúÄ‰Ω≥ÂºÇ‰∏ñÁïå", "ÊúÄ‰Ω≥Á©øË∂ä", "ÊúÄ‰Ω≥Êû∂Á©∫", "ÊúÄ‰Ω≥ËΩ¨Áîü", "ÊúÄ‰Ω≥ÂéüÂàõ", "ÊúÄ‰Ω≥ÊîπÁºñ",
        "ÊúÄ‰Ω≥Êó∂Èó¥ËΩÆÂõû", "ÊúÄ‰Ω≥ÂèôËØ°", "ÊúÄ‰Ω≥‰º™Â®ò", "ÊúÄ‰Ω≥Ë∂ÖËÉΩÂäõ", "ÊúÄ‰Ω≥ËÅåÂú∫", "ÊúÄ‰Ω≥ÁæéÈ£ü",
        "Â∞è‰ºóÊúÄÁà±", "ÊúÄÁà±ÁîªÈ£é", "ÊúÄÁà±ÈïøÁØá", "ÊúÄÊÅêÊÄñ", "ÊúÄÂÜôÂÆû", "Â∏∏Âê¨ËØ¥‰ªéÊú™Áúã",
        "Ëä±ÊúÄÂ§öÈí±", "ÊúÄË¢´‰Ωé‰º∞", "ÊúÄËøáË™â", "ÊúÄËÉÉÁñº", "ÊúÄÊúüÁª≠‰Ωú", "ÊúÄËÆ®Âéå"
    ];

    // cellImages ‰øùÂ≠òÊØè‰∏™Ê†ºÂ≠êÁöÑÂ∞ÅÈù¢ URL„ÄÇ
    const cellImages = new Array(texts.length).fill(null);
    // cellCrops ‰øùÂ≠òÊØè‰∏™Ê†ºÂ≠êÁöÑË£ÅÂâ™ÂèÇÊï∞Ôºà‰ªÖÂΩ±ÂìçÂΩìÂâçÁî®Êà∑Â±ïÁ§∫‰∏éÂØºÂá∫Ôºå‰∏çÊîπÂéüÂõæÔºâ„ÄÇ
    const cellCrops = new Array(texts.length).fill(null);
    // cellSubjectIDs ‰øùÂ≠òÊØè‰∏™Ê†ºÂ≠êÂÖ≥ËÅîÁöÑ Bangumi ‰ΩúÂìÅ IDÔºåÁî®‰∫éÊé®ËçêÂéªÈáç„ÄÇ
    const cellSubjectIDs = new Array(texts.length).fill(null);
    // cellSwapOffsets ‰øùÂ≠òÊØè‰∏™Ê†ºÂ≠êÁöÑ"Êç¢‰∏Ä‰∏™"ÂÅèÁßªËÆ°Êï∞„ÄÇ
    const cellSwapOffsets = new Array(texts.length).fill(0);
    // coverUrls ‰øùÂ≠ò /api/covers ËøîÂõûÁöÑÂ∞ÅÈù¢ÂàóË°®„ÄÇ
    let coverUrls = [];
    // activeCellIndex ËÆ∞ÂΩïÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑÊ†ºÂ≠êÁ¥¢Âºï„ÄÇ
    let activeCellIndex = -1;
    // _imgCache ÁºìÂ≠òÂ∑≤Âä†ËΩΩÂõæÁâáÔºåÂáèÂ∞ëÈáçÂ§çÂØºÂá∫Êó∂ÁöÑÁΩëÁªúÂíåËß£Á†ÅÂºÄÈîÄ„ÄÇ
    const _imgCache = new Map();
    // Ë£ÅÂâ™ÁºñËæëÁä∂ÊÄÅ
    let cropEditingIndex = -1;
    let cropDraft = null;
    let cropDragging = false;
    let cropDragStartX = 0;
    let cropDragStartY = 0;

    // ÊêúÁ¥¢Èù¢ÊùøÁöÑÈ¢òÊùêÊ†áÁ≠æÂàÜÁªÑÔºåÁî®‰∫é Bangumi tag ÊµèËßà„ÄÇ
    const allTags = [
        { label: "ÊÉÖÊÑü", color: "#e84393", tags: ["Ê≤ªÊÑà", "ÊêûÁ¨ë", "ÁÉ≠Ë°Ä", "ÊÑüÂä®", "ÂÇ¨Ê≥™", "Ëá¥ÈÉÅ", "ÊÅêÊÄñ", "Ê∏©È¶®", "ÁáÉ", "ËôêÂøÉ", "ÂéãÊäë", "Á¥ßÂº†", "ËΩªÊùæ", "Êµ™Êº´", "ËçíËØû", "ÈªëÊöó"] },
        { label: "ÊÅãÁà±", color: "#fd79a8", tags: ["ÊÅãÁà±", "ÁôæÂêà", "BL", "ÂêéÂÆ´", "Á∫ØÁà±", "ÊöóÊÅã", "‰∏âËßíÂÖ≥Á≥ª", "ÂàùÊÅã", "ÈùíÊ¢ÖÁ´πÈ©¨", "ÂßêÂºüÊÅã", "Â∏àÁîüÊÅã", "ÂêåÂ±Ö", "ÂºÇÂú∞ÊÅã", "Â¶πÊéß", "NTR"] },
        { label: "Êó•Â∏∏", color: "#fdcb6e", tags: ["Êó•Â∏∏", "Ê†°Âõ≠", "ÈùíÊò•", "ËÅåÂú∫", "ÁæéÈ£ü", "Èü≥‰πê", "ÂÅ∂ÂÉè", "ËøêÂä®", "ÊóÖË°å", "ÊñôÁêÜ", "ÂÆ∂Â∫≠", "Á§æÂõ¢", "‰π°Êùë", "ÂÆ†Áâ©", "Èú≤Ëê•", "ÈíìÈ±º"] },
        { label: "Âä®‰Ωú", color: "#e17055", tags: ["ÊàòÊñó", "ÂÜíÈô©", "Ë∂ÖËÉΩÂäõ", "Á´ûÊäÄ", "Ê†ºÊñó", "ÂÜõ‰∫ã", "Êú∫Êàò", "Ê≠¶ÊúØ", "ÁîüÂ≠ò", "È≠îÊ≥ïÂ∞ëÂ•≥", "ÁâπÂ∑•", "ÊöóÊùÄ", "ÂºÇËÉΩ", "Â§ç‰ªá"] },
        { label: "ÊÇ¨Áñë", color: "#a29bfe", tags: ["Êé®ÁêÜ", "ÊÇ¨Áñë", "Êô∫Êñó", "ÁäØÁΩ™", "ÊÉäÊÇö", "ÂøÉÁêÜ", "‰æ¶Êé¢", "Ëß£Ë∞ú", "ÂØÜÂÆ§", "Ë∞ãÁï•", "Èó¥Ë∞ç", "Èò¥Ë∞ã", "ÁåéÂ•á", "ÈªëÂ∏Æ"] },
        { label: "ÂπªÊÉ≥", color: "#74b9ff", tags: ["Â•áÂπª", "ÁßëÂπª", "Êú∫Áî≤", "ËµõÂçöÊúãÂÖã", "È≠îÊ≥ï", "Â¶ñÊÄ™", "Âê∏Ë°ÄÈ¨º", "ÁéÑÂπª", "‰∫∫Â§ñ", "Á≤æÁÅµ", "Ëí∏Ê±ΩÊúãÂÖã", "ÂÖãËãèÈ≤Å", "ÈÉΩÂ∏ÇÂ•áÂπª"] },
        { label: "ËÆæÂÆö", color: "#00cec9", tags: ["ÂºÇ‰∏ñÁïå", "Á©øË∂ä", "ËΩ¨Áîü", "Êû∂Á©∫", "Êú´Êó•", "Âè≤ËØó", "Á•ûËØù", "ÂéÜÂè≤", "ÂÆ´Âª∑", "ËøëÊú™Êù•", "Â∫üÂúü", "Â§™Á©∫", "Êàò‰∫â", "‰∏≠‰∏ñÁ∫™", "Ê±üÊà∑", "Áé∞‰ª£"] },
        { label: "Âèô‰∫ã", color: "#636e72", tags: ["ÂâßÊÉÖ", "ÂéüÂàõ", "ÊîπÁºñ", "ÂÜôÂÆû", "ÂèôËø∞ÊÄßËØ°ËÆ°", "Êó∂Èó¥Âæ™ÁéØ", "Áæ§ÂÉèÂâß", "ÊÑèËØÜÊµÅ", "ÂèçËΩ¨", "Â§öÁ∫øÂèô‰∫ã", "Áü≠ÁØá", "ÈïøÁØá", "ÈùûÁ∫øÊÄß"] },
        { label: "Â±ûÊÄß", color: "#fab1a0", tags: ["Áæ§ÂÉè", "‰º™Â®ò", "ÂÖΩËÄ≥", "ÂÇ≤Â®á", "ÁóÖÂ®á", "Â§©ÁÑ∂ÂëÜ", "ËÖπÈªë", "Â•≥‰ªÜ", "Â§ßÂ∞èÂßê", "ËêåÁ≥ª", "Â¶πÁ≥ª", "Ê≠£Â§™", "ËêùËéâ", "ÁúºÈïú", "ÈæôÂÇ≤Â§©"] },
        { label: "Âèó‰ºó", color: "#b2bec3", tags: ["Â∞ëÂπ¥", "Â∞ëÂ•≥", "ÈùíÂπ¥", "‰πôÂ•≥", "GL", "Â≠ê‰æõÂêë", "Â•≥ÊÄßÂêë", "Áî∑ÊÄßÂêë", "Ê≥°Èù¢Áï™", "ÂÖ®Âπ¥ÈæÑ", "Êàê‰∫∫Âêë", "R18"] },
    ];

    // cellTagMap ÂÆö‰πâÊØè‰∏™Ê†ºÂ≠êÊ†áÁ≠æÂØπÂ∫îÁöÑÊé®ËçêÁ≠ñÁï•ÔºåÁã¨Á´ã‰∫é texts Êï∞ÁªÑ
    const cellTagMap = {
        "ÂÖ•Âùë‰Ωú":       { tags: [], sort: "heat", type: "anime" },
        "ÊúÄÂñúÊ¨¢":       { tags: [], sort: "heat", type: "anime" },
        "ÁúãÊúÄÂ§öÊ¨°":     { tags: [], sort: "heat", type: "anime" },
        "ÊúÄÊÉ≥ÂÆâÂà©":     { tags: [], sort: "heat", type: "anime" },
        "ÊúÄ‰∏ÄÁúºÁºò":     { tags: ["Ê≤ªÊÑà", "Êó•Â∏∏"], sort: "heat" },
        "ÊúÄÈúáÊíº":       { tags: ["ÁÉ≠Ë°Ä", "ÁáÉ"], sort: "heat" },
        "ÊúÄÊ≤ªÊÑà":       { tags: ["Ê≤ªÊÑà"], sort: "heat" },
        "ÊúÄÊêûÁ¨ë":       { tags: ["ÊêûÁ¨ë"], sort: "heat" },
        "ÊúÄÊÑüÂä®":       { tags: ["ÊÑüÂä®", "ÂÇ¨Ê≥™"], sort: "heat" },
        "ÊúÄÁÉ≠Ë°Ä":       { tags: ["ÁÉ≠Ë°Ä"], sort: "heat" },
        "ÊúÄËá¥ÈÉÅ":       { tags: ["Ëá¥ÈÉÅ"], sort: "heat" },
        "ÊúÄÁîµÊ≥¢":       { tags: ["ÊêûÁ¨ë"], sort: "heat" },
        "ÊúÄ‰Ω≥ÂâßÊÉÖ":     { tags: ["ÂâßÊÉÖ"], sort: "heat" },
        "ÊúÄ‰Ω≥ÊºîÂá∫":     { tags: [], sort: "heat", type: "anime" },
        "ÊúÄ‰Ω≥Èü≥‰πê":     { tags: ["Èü≥‰πê"], sort: "heat" },
        "ÊúÄ‰Ω≥‰∏ñÁïåËßÇ":   { tags: ["Â•áÂπª", "ÁßëÂπª"], sort: "heat" },
        "ÊúÄ‰Ω≥ËßíËâ≤Â°ëÈÄ†": { tags: ["Áæ§ÂÉèÂâß"], sort: "heat" },
        "Êâ≠ÁöÑÊúÄÂéâÂÆ≥":   { tags: ["ÂèçËΩ¨"], sort: "heat" },
        "ÊúÄ‰Ω≥ÊÅãÁà±":     { tags: ["ÊÅãÁà±"], sort: "heat" },
        "ÊúÄ‰Ω≥‰øÆÁΩóÂú∫":   { tags: ["‰∏âËßíÂÖ≥Á≥ª", "ÂêéÂÆ´"], sort: "heat" },
        "ÊúÄ‰Ω≥ÂêéÂÆ´":     { tags: ["ÂêéÂÆ´"], sort: "heat" },
        "ÊúÄ‰Ω≥ÁôæÂêà":     { tags: ["ÁôæÂêà"], sort: "heat" },
        "ÊúÄ‰Ω≥ËÄΩÁæé":     { tags: ["BL"], sort: "heat" },
        "ÊúÄ‰Ω≥Áæ§ÂÉè":     { tags: ["Áæ§ÂÉè"], sort: "heat" },
        "ÊúÄ‰Ω≥Êó•Â∏∏":     { tags: ["Êó•Â∏∏"], sort: "heat" },
        "ÊúÄ‰Ω≥Ê†°Âõ≠":     { tags: ["Ê†°Âõ≠"], sort: "heat" },
        "ÊúÄ‰Ω≥ËøêÂä®":     { tags: ["ËøêÂä®"], sort: "heat" },
        "ÊúÄ‰Ω≥ÊàòÊñó":     { tags: ["ÊàòÊñó"], sort: "heat" },
        "ÊúÄ‰Ω≥Êô∫Êñó":     { tags: ["Êô∫Êñó"], sort: "heat" },
        "ÊúÄ‰Ω≥ÊÇ¨Áñë":     { tags: ["ÊÇ¨Áñë", "Êé®ÁêÜ"], sort: "heat" },
        "ÊúÄ‰Ω≥Â•áÂπª":     { tags: ["Â•áÂπª"], sort: "heat" },
        "ÊúÄ‰Ω≥ÁßëÂπª":     { tags: ["ÁßëÂπª"], sort: "heat" },
        "ÊúÄ‰Ω≥Êú∫Áî≤":     { tags: ["Êú∫Êàò"], sort: "heat" },
        "ÊúÄ‰Ω≥ÂÜíÈô©":     { tags: ["ÂÜíÈô©"], sort: "heat" },
        "ÊúÄ‰Ω≥Âè≤ËØó":     { tags: ["Âè≤ËØó"], sort: "heat" },
        "ÊúÄ‰Ω≥Êú´Êó•":     { tags: ["Êú´Êó•"], sort: "heat" },
        "ÊúÄ‰Ω≥ÂºÇ‰∏ñÁïå":   { tags: ["ÂºÇ‰∏ñÁïå"], sort: "heat" },
        "ÊúÄ‰Ω≥Á©øË∂ä":     { tags: ["Á©øË∂ä"], sort: "heat" },
        "ÊúÄ‰Ω≥Êû∂Á©∫":     { tags: ["Êû∂Á©∫"], sort: "heat" },
        "ÊúÄ‰Ω≥ËΩ¨Áîü":     { tags: ["ËΩ¨Áîü"], sort: "heat" },
        "ÊúÄ‰Ω≥ÂéüÂàõ":     { tags: ["ÂéüÂàõ"], sort: "heat" },
        "ÊúÄ‰Ω≥ÊîπÁºñ":     { tags: ["ÊîπÁºñ"], sort: "heat" },
        "ÊúÄ‰Ω≥Êó∂Èó¥ËΩÆÂõû": { tags: ["Êó∂Èó¥Âæ™ÁéØ"], sort: "heat" },
        "ÊúÄ‰Ω≥ÂèôËØ°":     { tags: ["ÂèôËø∞ÊÄßËØ°ËÆ°"], sort: "heat" },
        "ÊúÄ‰Ω≥‰º™Â®ò":     { tags: ["‰º™Â®ò"], sort: "heat" },
        "ÊúÄ‰Ω≥Ë∂ÖËÉΩÂäõ":   { tags: ["Ë∂ÖËÉΩÂäõ"], sort: "heat" },
        "ÊúÄ‰Ω≥ËÅåÂú∫":     { tags: ["ËÅåÂú∫"], sort: "heat" },
        "ÊúÄ‰Ω≥ÁæéÈ£ü":     { tags: ["ÁæéÈ£ü", "ÊñôÁêÜ"], sort: "heat" },
        "Â∞è‰ºóÊúÄÁà±":     { tags: [], sort: "score", type: "anime" },
        "ÊúÄÁà±ÁîªÈ£é":     { tags: [], sort: "heat", type: "anime" },
        "ÊúÄÁà±ÈïøÁØá":     { tags: ["ÈïøÁØá"], sort: "heat" },
        "ÊúÄÊÅêÊÄñ":       { tags: ["ÊÅêÊÄñ"], sort: "heat" },
        "ÊúÄÂÜôÂÆû":       { tags: ["ÂÜôÂÆû"], sort: "heat" },
        "Â∏∏Âê¨ËØ¥‰ªéÊú™Áúã": { tags: [], sort: "heat", type: "anime" },
        "Ëä±ÊúÄÂ§öÈí±":     { tags: [], sort: "heat", type: "anime" },
        "ÊúÄË¢´‰Ωé‰º∞":     { tags: [], sort: "score", type: "anime" },
        "ÊúÄËøáË™â":       { tags: [], sort: "heat", type: "anime" },
        "ÊúÄËÉÉÁñº":       { tags: ["Ëá¥ÈÉÅ", "ËôêÂøÉ"], sort: "heat" },
        "ÊúÄÊúüÁª≠‰Ωú":     { tags: [], sort: "heat", type: "anime" },
        "ÊúÄËÆ®Âéå":       { tags: [], sort: "heat", type: "anime" },
    };

    // ÊêúÁ¥¢Áä∂ÊÄÅ
    let currentTags = [];           // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÂàóË°®
    let currentPage = 1;            // ÂΩìÂâçÈ°µÁ†Å
    let currentTotal = 0;           // ÊêúÁ¥¢ÁªìÊûúÊÄªÊï∞
    let currentSubjectType = "all"; // Á±ªÂûãÁ≠õÈÄâ
    let _cachedPageSize = 0;        // ÁºìÂ≠òÁöÑÊØèÈ°µÊù°Êï∞
    const SEARCH_ROWS = 2;           // ÊêúÁ¥¢ÁªìÊûúÊòæÁ§∫Ë°åÊï∞
    const MIN_ITEM_WIDTH = 100;      // ÊêúÁ¥¢Âç°ÁâáÊúÄÂ∞èÂÆΩÂ∫¶
    const SEARCH_GAP = 6;            // ÊêúÁ¥¢ÁΩëÊ†ºÈó¥Ë∑ù
    // getSearchPageSize Ê†πÊçÆÂºπÁ™óÂÆΩÂ∫¶Âä®ÊÄÅËÆ°ÁÆóÊØèÈ°µÊù°ÁõÆÊï∞ÔºàÂõ∫ÂÆö 2 Ë°åÔºåÊó†Á©∫‰ΩçÔºâ„ÄÇ
    function getSearchPageSize() {
        if (_cachedPageSize > 0) return _cachedPageSize;
        const modal = document.querySelector(".cover-modal-inner");
        // modal padding 20px√ó2, tab-panel padding-right 6px
        const availableWidth = modal && modal.clientWidth > 0
            ? (modal.clientWidth - 46) : 880;
        const cols = Math.max(1, Math.floor(
            (availableWidth + SEARCH_GAP) / (MIN_ITEM_WIDTH + SEARCH_GAP)
        ));
        _cachedPageSize = cols * SEARCH_ROWS;
        return _cachedPageSize;
    }
    function resetPageSizeCache() { _cachedPageSize = 0; }
    let _searchTimer = null;        // ÊêúÁ¥¢Èò≤ÊäñËÆ°Êó∂Âô®
    let _loadingRequests = 0;       // Ê≠£Âú®ËøõË°åÁöÑÂä†ËΩΩËØ∑Ê±ÇÊï∞Èáè
    let _searchVersion = 0;         // ÊêúÁ¥¢ÁâàÊú¨Âè∑ÔºåÁî®‰∫éÈöîÁ¶ªÊóßËØ∑Ê±ÇÁªìÊûú
    const _pageCache = new Map();   // ÂàÜÈ°µÁºìÂ≠ò key -> data
    const _inflight = new Map();    // ËØ∑Ê±ÇÂéªÈáç key -> Promise
    const CACHE_LIMIT = 120;        // ÂàÜÈ°µÁºìÂ≠ò‰∏äÈôêÔºåÈÅøÂÖçÊó†ÈôêÂ¢ûÈïø
    const PREFETCH_STEPS = [1, 2, -1]; // È¢ÑÂä†ËΩΩÈ°∫Â∫èÔºöÂêé1È°µ„ÄÅÂêé2È°µ„ÄÅÂâç1È°µ

    // Êï∞ÊçÆÊ∫êÈÄâÊã©Ôºö"bgm" Êàñ "vndb"
    let currentSource = "bgm";

    // VNDB ÊêúÁ¥¢Áä∂ÊÄÅÔºàÁã¨Á´ã‰∫é BangumiÔºâ
    let vndbPage = 1;
    let vndbTotal = 0;
    let _vndbSearchTimer = null;
    let _vndbLoadingRequests = 0;
    let _vndbSearchVersion = 0;
    const _vndbPageCache = new Map();
    const _vndbInflight = new Map();
    const VNDB_PREFETCH_STEPS = [1]; // VNDB ‰ªÖÈ¢ÑÂä†ËΩΩÂêé 1 È°µ

    // initGrid ÂàõÂª∫60‰∏™ÁΩëÊ†ºÊ†ºÂ≠êÂπ∂ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
    function initGrid() {
        const container = document.getElementById("gridContainer");
        container.innerHTML = "";
        texts.forEach((text, i) => {
            const cell = document.createElement("div");
            cell.className = "grid-cell";
            cell.dataset.index = i;
            cell.onclick = (e) => handleCellClick(i, e);
            cell.innerHTML = `
                <div class="cell-img-area" id="imgArea${i}">
                    <span class="placeholder">Ôºã</span>
                </div>
                <div class="cell-label">${text}</div>
                <div class="cell-hover-overlay"></div>
            `;
            container.appendChild(cell);
            renderCellImage(i, text);
        });
    }

    function defaultCrop() {
        return { zoom: 1, centerX: 0.5, centerY: 0.5 };
    }

    function cloneCrop(crop) {
        return {
            zoom: Number(crop?.zoom ?? 1),
            centerX: Number(crop?.centerX ?? 0.5),
            centerY: Number(crop?.centerY ?? 0.5),
        };
    }

    function clampCrop(crop) {
        crop.zoom = Math.min(3, Math.max(1, Number(crop.zoom) || 1));
        const cx = Number(crop.centerX);
        const cy = Number(crop.centerY);
        crop.centerX = Math.min(1, Math.max(0, isNaN(cx) ? 0.5 : cx));
        crop.centerY = Math.min(1, Math.max(0, isNaN(cy) ? 0.5 : cy));
        return crop;
    }

    function getCellCrop(index) {
        return clampCrop(cloneCrop(cellCrops[index] || defaultCrop()));
    }

    // computeCropLayout Ê†πÊçÆÂõæÁâáÂéüÂßãÂ∞∫ÂØ∏„ÄÅÂÆπÂô®ÂÆΩÈ´òÊØîÂíåË£ÅÂâ™ÂèÇÊï∞ËÆ°ÁÆóÂÆö‰ΩçÁôæÂàÜÊØî„ÄÇ
    function computeCropLayout(natW, natH, containerRatio, crop) {
        const imgRatio = natW / natH;
        let wPct, hPct;
        if (imgRatio > containerRatio) {
            hPct = 100 * crop.zoom;
            wPct = 100 * crop.zoom * imgRatio / containerRatio;
        } else {
            wPct = 100 * crop.zoom;
            hPct = 100 * crop.zoom * containerRatio / imgRatio;
        }
        const overflowX = wPct - 100;
        const overflowY = hPct - 100;
        return {
            width: wPct + '%',
            height: hPct + '%',
            left: -(crop.centerX * overflowX) + '%',
            top: -(crop.centerY * overflowY) + '%',
        };
    }

    // applyCropLayoutToElement Â∞ÜË£ÅÂâ™Â∏ÉÂ±ÄÂ∫îÁî®Âà∞ÂõæÁâáÂÖÉÁ¥†„ÄÇ
    function applyCropLayoutToElement(img, layout) {
        img.style.objectFit = '';
        img.style.objectPosition = '';
        img.style.width = layout.width;
        img.style.height = layout.height;
        img.style.left = layout.left;
        img.style.top = layout.top;
    }

    function renderCellImage(index, altText = "cover") {
        const area = document.getElementById(`imgArea${index}`);
        if (!area) return;
        area.innerHTML = "";
        
        const cell = area.closest(".grid-cell");

        const url = cellImages[index];
        if (!url) {
            const placeholder = document.createElement("span");
            placeholder.className = "placeholder";
            placeholder.textContent = "Ôºã";
            area.appendChild(placeholder);
            if (cell) cell.classList.remove("has-cover");
            return;
        }
        
        if (cell) cell.classList.add("has-cover");

        const crop = getCellCrop(index);
        const img = document.createElement("img");
        img.src = url;
        img.alt = altText;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.objectPosition = `${crop.centerX * 100}% ${crop.centerY * 100}%`;
        img.onload = () => {
            const r = (area.offsetWidth && area.offsetHeight)
                ? area.offsetWidth / area.offsetHeight : 150 / 204;
            const layout = computeCropLayout(img.naturalWidth, img.naturalHeight, r, crop);
            applyCropLayoutToElement(img, layout);
        };
        area.appendChild(img);

        // ÊÇ¨ÂÅúÂ∑•ÂÖ∑Ê†èÔºöË£ÅÂâ™ + Ê∏ÖÈô§
        const toolbar = document.createElement("div");
        toolbar.className = "cell-toolbar";
        
        const cropBtn = document.createElement("button");
        cropBtn.className = "cell-tool-btn";
        cropBtn.type = "button";
        cropBtn.title = "Ë£ÅÂâ™Â∞ÅÈù¢";
        cropBtn.textContent = "‚úÇ";
        cropBtn.onclick = (e) => {
            e.stopPropagation();
            openCropModal(index);
        };
        toolbar.appendChild(cropBtn);
        
        const clearBtn = document.createElement("button");
        clearBtn.className = "cell-tool-btn danger";
        clearBtn.type = "button";
        clearBtn.title = "Ê∏ÖÈô§Â∞ÅÈù¢";
        clearBtn.textContent = "√ó";
        clearBtn.onclick = (e) => {
            e.stopPropagation();
            quickClearCell(index);
        };
        toolbar.appendChild(clearBtn);
        
        area.appendChild(toolbar);
    }

    // loadCovers ‰ªéÂêéÁ´ØÂä†ËΩΩ covers ÁõÆÂΩï‰∏≠ÁöÑÂ∞ÅÈù¢ÂàóË°®„ÄÇ
    async function loadCovers() {
        try {
            const resp = await fetch("/api/covers");
            if (!resp.ok) return;
            const list = await resp.json();
            coverUrls = list.map(n => ({ name: n, url: "covers/" + encodeURIComponent(n) }));
        } catch (e) {
            console.warn("Âä†ËΩΩÂ∞ÅÈù¢Â§±Ë¥•:", e);
        }
    }

    // refreshCovers ÊâãÂä®Âà∑Êñ∞Â∞ÅÈù¢ÂàóË°®Âπ∂ÈáçÊñ∞Ê∏≤ÊüìÂºπÁ™óÂÜÖÁΩëÊ†º„ÄÇ
    async function refreshCovers() {
        await loadCovers();
        renderCoverGrid();
    }

    // renderCoverGrid Ê∏≤ÊüìÂºπÁ™óÂÜÖÁöÑÂ∑≤ÊúâÂ∞ÅÈù¢ÁΩëÊ†º„ÄÇ
    function renderCoverGrid() {
        const grid = document.getElementById("coverGrid");
        if (!grid) return;
        grid.innerHTML = "";
        if (coverUrls.length === 0) {
            grid.innerHTML = `<div class="no-covers-msg">covers Êñá‰ª∂Â§π‰∏≠Ê≤°ÊúâÊâæÂà∞ÂõæÁâá<br>ÁÇπÂáª„ÄåÂØºÂÖ•Â∞ÅÈù¢„Äç‰∏ä‰º†Êú¨Âú∞ÂõæÁâáÔºåÊàñÂàáÊç¢Âà∞ Bangumi / VNDB Tab Âú®Á∫øÊêúÁ¥¢</div>`;
            return;
        }
        coverUrls.forEach(({ name, url }) => {
            const item = document.createElement("div");
            item.className = "cover-item";
            item.innerHTML = `<img src="${url}" alt="${name}" title="${name}">`;
            item.onclick = (e) => { e.stopPropagation(); selectCover(url, name); };
            grid.appendChild(item);
        });
    }

    // triggerUploadCover Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©ÂØπËØùÊ°Ü„ÄÇ
    function triggerUploadCover() {
        document.getElementById("uploadCoverInput").click();
    }

    // handleUploadFiles ‰∏ä‰º†ÈÄâ‰∏≠ÁöÑÂõæÁâáÊñá‰ª∂Âà∞ÂêéÁ´Ø covers ÁõÆÂΩï„ÄÇ
    async function handleUploadFiles(files) {
        if (!files || files.length === 0) return;
        const overlay = document.createElement("div");
        overlay.className = "download-overlay";
        overlay.innerHTML = `<div class="download-overlay-box">
            <div class="spinner"></div>
            <div>Ê≠£Âú®ÂØºÂÖ•Â∞ÅÈù¢Ôºà0/${files.length}Ôºâ...</div>
        </div>`;
        document.body.appendChild(overlay);
        const msgEl = overlay.querySelector("div > div:last-child");

        let lastFilename = null;
        try {
            for (let i = 0; i < files.length; i++) {
                msgEl.textContent = `Ê≠£Âú®ÂØºÂÖ•Â∞ÅÈù¢Ôºà${i + 1}/${files.length}Ôºâ...`;
                const form = new FormData();
                form.append("file", files[i]);
                const resp = await fetch("/api/upload-cover", { method: "POST", body: form });
                const data = await resp.json();
                if (data.error) {
                    alert(`ÂØºÂÖ• ${files[i].name} Â§±Ë¥•: ${data.error}`);
                    continue;
                }
                lastFilename = data.filename;
            }
            await loadCovers();
            renderCoverGrid();
            if (lastFilename && activeCellIndex >= 0) {
                // ‰∏çËá™Âä®ÈÄâÊã©Ôºå‰ªÖÂà∑Êñ∞ÂàóË°®
            }
        } catch (e) {
            alert("ÂØºÂÖ•Âá∫Èîô: " + e.message);
        } finally {
            overlay.remove();
            document.getElementById("uploadCoverInput").value = "";
        }
    }

    // openCoverPicker ÊâìÂºÄÂºπÁ™óÂπ∂Ê∏≤ÊüìÂèØÈÄâÂ∞ÅÈù¢„ÄÇ
    function openCoverPicker(index) {
        activeCellIndex = index;
        const grid = document.getElementById("coverGrid");
        document.getElementById("modalTitle").textContent = `‰∏∫„Äå${texts[index]}„ÄçÈÄâÊã©Â∞ÅÈù¢`;

        // Ê∏≤ÊüìÂ∑≤ÊúâÂ∞ÅÈù¢ÂàóË°®
        renderCoverGrid();

        // ÈáçÁΩÆÊêúÁ¥¢Áä∂ÊÄÅ
        currentTags = [];
        currentPage = 1;
        currentTotal = 0;
        currentSubjectType = "all";
        document.getElementById("searchInput").value = "";
        document.getElementById("resultInfo").style.display = "none";
        document.getElementById("pagination").innerHTML = "";
        document.getElementById("searchResults").innerHTML =
            '<div class="search-status">ÈÄâÊã©‰∏äÊñπÈ¢òÊùêÊ†áÁ≠æÔºåÊàñÁõ¥Êé•ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢</div>';
        document.querySelectorAll(".type-btn").forEach(b =>
            b.classList.toggle("active", b.dataset.type === "all"));
        _searchVersion += 1;
        _pageCache.clear();
        _inflight.clear();
        syncTagBrowserUI();
        renderTagBadges();

        // ÈáçÁΩÆ VNDB ÊêúÁ¥¢Áä∂ÊÄÅ
        vndbPage = 1;
        vndbTotal = 0;
        _vndbSearchVersion += 1;
        _vndbPageCache.clear();
        _vndbInflight.clear();

        // ÈáçÁΩÆÊï∞ÊçÆÊ∫ê‰∏∫ Bangumi
        setSource("bgm");

        resetPageSizeCache();
        switchTab("covers");
        document.getElementById("coverModal").classList.add("active");
    }

    // selectCover Â∞ÜÈÄâ‰∏≠Â∞ÅÈù¢ÂÜôÂÖ•ÂΩìÂâçÊ†ºÂ≠êÂπ∂‰øùÂ≠òÁä∂ÊÄÅ„ÄÇ
    function selectCover(url, name) {
        const i = activeCellIndex;
        cellImages[i] = url;
        cellCrops[i] = defaultCrop();
        renderCellImage(i, name);
        closeModal();
        hidePopover();
        saveState();
        updateProgressBar();
    }

    // clearCover Ê∏ÖÈô§ÂΩìÂâçÊ†ºÂ≠êÁöÑÂ∞ÅÈù¢Âπ∂‰øùÂ≠òÁä∂ÊÄÅ„ÄÇ
    function clearCover() {
        const i = activeCellIndex;
        cellImages[i] = null;
        cellCrops[i] = null;
        cellSubjectIDs[i] = null;
        cellSwapOffsets[i] = 0;
        renderCellImage(i);
        closeModal();
        hidePopover();
        saveState();
        updateProgressBar();
    }

    // closeModal ÂÖ≥Èó≠Â∞ÅÈù¢ÈÄâÊã©ÂºπÁ™ó„ÄÇ
    function closeModal() {
        document.getElementById("coverModal").classList.remove("active");
    }

    // ÁÇπÂáªÂºπÁ™óÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠
    document.addEventListener("click", (e) => {
        if (e.target === document.getElementById("coverModal")) closeModal();
        if (e.target === document.getElementById("cropModal")) closeCropModal();
    });

    function openCropModal(index) {
        if (!cellImages[index]) return;
        cropEditingIndex = index;
        cropDraft = getCellCrop(index);
        const title = texts[index] || "ÂΩìÂâçÊ†ºÂ≠ê";
        document.getElementById("cropTitle").textContent = `Ë£ÅÂâ™Â∞ÅÈù¢ ¬∑ „Äå${title}„Äç`;
        const src = cellImages[index];
        const cropImg = document.getElementById("cropImage");
        const previewImg = document.getElementById("cropPreviewImage");
        cropImg.src = src;
        previewImg.src = src;
        [cropImg, previewImg].forEach(el => {
            el.style.width = '100%';
            el.style.height = '100%';
            el.style.objectFit = 'cover';
            el.style.left = '0';
            el.style.top = '0';
        });
        syncCropInputs();
        if (cropImg.complete && cropImg.naturalWidth > 0) {
            applyCropDraftToPreview();
        } else {
            cropImg.onload = () => applyCropDraftToPreview();
        }
        document.getElementById("cropModal").classList.add("active");
    }

    function closeCropModal() {
        document.getElementById("cropModal").classList.remove("active");
        cropEditingIndex = -1;
        cropDraft = null;
        cropDragging = false;
        document.getElementById("cropViewport").classList.remove("dragging");
    }

    function syncCropInputs() {
        if (!cropDraft) return;
        const zoomVal = Math.round(cropDraft.zoom * 100);
        const xVal = Math.round(cropDraft.centerX * 100);
        const yVal = Math.round(cropDraft.centerY * 100);
        document.getElementById("cropZoom").value = String(zoomVal);
        document.getElementById("cropX").value = String(xVal);
        document.getElementById("cropY").value = String(yVal);
        document.getElementById("cropZoomValue").textContent = `${zoomVal}%`;
        document.getElementById("cropXValue").textContent = `${xVal}%`;
        document.getElementById("cropYValue").textContent = `${yVal}%`;
    }

    function applyCropDraftToPreview() {
        if (!cropDraft) return;
        clampCrop(cropDraft);
        const cropImg = document.getElementById("cropImage");
        if (!cropImg.naturalWidth) return;
        const layout = computeCropLayout(
            cropImg.naturalWidth, cropImg.naturalHeight, 3 / 4, cropDraft
        );
        applyCropLayoutToElement(cropImg, layout);
        applyCropLayoutToElement(document.getElementById("cropPreviewImage"), layout);
        syncCropInputs();
    }

    function resetCropDraft() {
        cropDraft = defaultCrop();
        applyCropDraftToPreview();
    }

    function saveCropDraft() {
        if (cropEditingIndex < 0 || !cropDraft) return;
        cellCrops[cropEditingIndex] = clampCrop(cloneCrop(cropDraft));
        renderCellImage(cropEditingIndex);
        saveState();
        closeCropModal();
    }

    document.getElementById("cropZoom").addEventListener("input", (e) => {
        if (!cropDraft) return;
        cropDraft.zoom = Number(e.target.value) / 100;
        cropDraft = clampCrop(cropDraft);
        applyCropDraftToPreview();
    });
    document.getElementById("cropX").addEventListener("input", (e) => {
        if (!cropDraft) return;
        cropDraft.centerX = Number(e.target.value) / 100;
        cropDraft = clampCrop(cropDraft);
        applyCropDraftToPreview();
    });
    document.getElementById("cropY").addEventListener("input", (e) => {
        if (!cropDraft) return;
        cropDraft.centerY = Number(e.target.value) / 100;
        cropDraft = clampCrop(cropDraft);
        applyCropDraftToPreview();
    });

    const cropViewport = document.getElementById("cropViewport");
    cropViewport.addEventListener("pointerdown", (e) => {
        if (!cropDraft) return;
        cropDragging = true;
        cropDragStartX = e.clientX;
        cropDragStartY = e.clientY;
        cropViewport.classList.add("dragging");
        cropViewport.setPointerCapture(e.pointerId);
    });
    cropViewport.addEventListener("pointermove", (e) => {
        if (!cropDragging || !cropDraft) return;
        const dx = e.clientX - cropDragStartX;
        const dy = e.clientY - cropDragStartY;
        cropDragStartX = e.clientX;
        cropDragStartY = e.clientY;

        const cropImg = document.getElementById("cropImage");
        if (!cropImg.naturalWidth) return;
        const rect = cropViewport.getBoundingClientRect();
        const imgRatio = cropImg.naturalWidth / cropImg.naturalHeight;
        const boxRatio = rect.width / rect.height || 3 / 4;
        let wFactor, hFactor;
        if (imgRatio > boxRatio) {
            hFactor = cropDraft.zoom;
            wFactor = cropDraft.zoom * imgRatio / boxRatio;
        } else {
            wFactor = cropDraft.zoom;
            hFactor = cropDraft.zoom * boxRatio / imgRatio;
        }
        const overflowXPx = (wFactor - 1) * rect.width;
        const overflowYPx = (hFactor - 1) * rect.height;
        if (overflowXPx > 0.5) cropDraft.centerX -= dx / overflowXPx;
        if (overflowYPx > 0.5) cropDraft.centerY -= dy / overflowYPx;
        cropDraft = clampCrop(cropDraft);
        applyCropDraftToPreview();
    });
    cropViewport.addEventListener("pointerup", (e) => {
        cropDragging = false;
        cropViewport.classList.remove("dragging");
        if (cropViewport.hasPointerCapture(e.pointerId)) {
            cropViewport.releasePointerCapture(e.pointerId);
        }
    });
    cropViewport.addEventListener("pointercancel", () => {
        cropDragging = false;
        cropViewport.classList.remove("dragging");
    });

    // switchTab ÂàáÊç¢ÂºπÁ™óÂÜÖÁöÑ tab Èù¢Êùø„ÄÇ
    function switchTab(tab) {
        document.querySelectorAll(".modal-tab").forEach(t =>
            t.classList.toggle("active", t.dataset.tab === tab));
        document.getElementById("tabCovers").classList.toggle("active", tab === "covers");
        document.getElementById("tabSearch").classList.toggle("active", tab === "search");
        if (tab === "search") {
            setTimeout(() => document.getElementById("searchInput").focus(), 100);
        }
    }

    // setSource ÂàáÊç¢ÊêúÁ¥¢Êï∞ÊçÆÊ∫êÔºåÊòæÁ§∫/ÈöêËóèÂØπÂ∫îÊéß‰ª∂„ÄÇ
    function setSource(src) {
        currentSource = src;
        document.querySelectorAll(".source-btn").forEach(b =>
            b.classList.toggle("active", b.dataset.source === src));
        document.getElementById("bgmControls").style.display = src === "bgm" ? "" : "none";
        document.getElementById("vndbGuide").style.display = src === "vndb" ? "flex" : "none";
        const input = document.getElementById("searchInput");
        const barLabel = document.getElementById("searchBarLabel");
        if (src === "vndb") {
            input.placeholder = "ËæìÂÖ• Galgame / ËßÜËßâÂ∞èËØ¥ÂêçÁß∞ÊêúÁ¥¢...";
            barLabel.innerHTML = 'ÂÖ≥ÈîÆËØç <span class="section-hint">‚Äî ËæìÂÖ•‰ΩúÂìÅ‰∏≠/Êó•/Ëã±ÂêçÁß∞</span>';
        } else {
            input.placeholder = "ËæìÂÖ•ÂÖ≥ÈîÆËØçËøõ‰∏ÄÊ≠•Á≠õÈÄâÔºàÂèØÈÄâÔºâ...";
            barLabel.innerHTML = 'ÂÖ≥ÈîÆËØç <span class="section-hint">‚Äî ËæìÂÖ•‰ΩúÂìÅÂêçÁß∞Ëøõ‰∏ÄÊ≠•Á≠õÈÄâ</span>';
        }
        // ÂàáÊç¢Êï∞ÊçÆÊ∫êÊó∂ÈáçÁΩÆÊêúÁ¥¢ÊåâÈíÆÁä∂ÊÄÅÂπ∂Ê∏ÖÁ©∫ÁªìÊûú
        const btn = document.getElementById("searchBtn");
        btn.disabled = false;
        btn.textContent = "ÊêúÁ¥¢";
        resetSearchResults();
    }

    // ---- ÊêúÁ¥¢Èù¢ÊùøÂäüËÉΩ ----

    // initTagBrowser ÊåâÂàÜÁ±ªÊ∏≤ÊüìÊ†áÁ≠æÈÄâÊã©ÊåâÈíÆ„ÄÇ
    function initTagBrowser() {
        const browser = document.getElementById("tagBrowser");
        browser.innerHTML = "";
        allTags.forEach(({ label, color, tags }) => {
            const row = document.createElement("div");
            row.className = "tag-cat-row";
            row.innerHTML = `<span class="tag-cat-label"><span class="tag-cat-dot" style="background:${color}"></span>${label}</span>`;
            const group = document.createElement("div");
            group.className = "tag-cat-group";
            tags.forEach(tag => {
                const btn = document.createElement("button");
                btn.className = "tag-pick-btn";
                btn.textContent = tag;
                btn.dataset.tag = tag;
                btn.onclick = () => toggleTag(tag);
                group.appendChild(btn);
            });
            row.appendChild(group);
            browser.appendChild(row);
        });
    }

    // syncTagBrowserUI ÂêåÊ≠•Ê†áÁ≠æÊåâÈíÆÁöÑÈÄâ‰∏≠È´ò‰∫Æ„ÄÇ
    function syncTagBrowserUI() {
        document.querySelectorAll(".tag-pick-btn").forEach(btn =>
            btn.classList.toggle("active", currentTags.includes(btn.dataset.tag)));
    }

    // renderTagBadges Ê∏≤ÊüìÂ∑≤ÈÄâÊ†áÁ≠æÂæΩÁ´†„ÄÇ
    function renderTagBadges() {
        const container = document.getElementById("tagBadges");
        container.innerHTML = "";
        currentTags.forEach((tag, idx) => {
            const badge = document.createElement("span");
            badge.className = "tag-badge";
            badge.innerHTML = `${tag} <span class="remove-tag" onclick="removeTag(${idx})">√ó</span>`;
            container.appendChild(badge);
        });
    }

    // toggleTag ÂàáÊç¢Ê†áÁ≠æÈÄâ‰∏≠Áä∂ÊÄÅÔºåÊúâÊù°‰ª∂Êó∂Ëá™Âä®ÊêúÁ¥¢„ÄÇ
    function toggleTag(tag) {
        const idx = currentTags.indexOf(tag);
        if (idx === -1) currentTags.push(tag);
        else currentTags.splice(idx, 1);
        syncTagBrowserUI();
        renderTagBadges();
        if (hasSearchCondition()) doSearch();
        else resetSearchResults();
    }

    // removeTag ÁßªÈô§ÊåáÂÆö‰ΩçÁΩÆÁöÑÊ†áÁ≠æ„ÄÇ
    function removeTag(idx) {
        currentTags.splice(idx, 1);
        syncTagBrowserUI();
        renderTagBadges();
        if (hasSearchCondition()) doSearch();
        else resetSearchResults();
    }

    // setSubjectType ÂàáÊç¢‰ΩúÂìÅÁ±ªÂûãÁ≠õÈÄâ„ÄÇ
    function setSubjectType(type) {
        currentSubjectType = type;
        document.querySelectorAll(".type-btn").forEach(b =>
            b.classList.toggle("active", b.dataset.type === type));
        if (hasSearchCondition()) doSearch();
    }

    // onSortChange ÊéíÂ∫èÂ≠óÊÆµÂèòÊõ¥Êó∂Ëß¶ÂèëÊêúÁ¥¢„ÄÇ
    function onSortChange() {
        if (hasSearchCondition()) doSearch();
    }

    // hasSearchCondition Âà§Êñ≠ÊòØÂê¶ÊúâÊúâÊïàÊêúÁ¥¢Êù°‰ª∂„ÄÇ
    function hasSearchCondition() {
        if (currentSource === "vndb") {
            return !!document.getElementById("searchInput").value.trim();
        }
        return currentTags.length > 0
            || document.getElementById("searchInput").value.trim()
            || currentSubjectType !== "all";
    }

    // resetSearchResults Ê∏ÖÁ©∫ÊêúÁ¥¢ÁªìÊûúÂå∫„ÄÇ
    function resetSearchResults() {
        let icon, hint;
        if (currentSource === "vndb") {
            icon = "üéÆ";
            hint = "ËæìÂÖ•ËßÜËßâÂ∞èËØ¥ÂêçÁß∞ÂºÄÂßãÊêúÁ¥¢<br><span style='font-size:11px;color:#bbb'>ÊîØÊåÅ‰∏≠Êñá„ÄÅÊó•ÊñáÂéüÂêç„ÄÅËã±ÊñáÂêçÔºåÊ®°Á≥äÂåπÈÖç</span>";
        } else {
            icon = "üîç";
            hint = "ÈÄâÊã©‰∏äÊñπÈ¢òÊùêÊ†áÁ≠æÔºåÊàñÁõ¥Êé•ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢<br><span style='font-size:11px;color:#bbb'>ÂèØÁªÑÂêàÂ§ö‰∏™Ê†áÁ≠æ + ÂÖ≥ÈîÆËØç + Á±ªÂûãÁ≠õÈÄâ</span>";
        }
        document.getElementById("searchResults").innerHTML =
            `<div class="search-status"><span class="search-status-icon">${icon}</span>${hint}</div>`;
        document.getElementById("resultInfo").style.display = "none";
        document.getElementById("pagination").innerHTML = "";
    }

    // doSearch Ëß¶ÂèëÊêúÁ¥¢Ôºà300ms Èò≤ÊäñÔºâÔºåÊ†πÊçÆÂΩìÂâçÊï∞ÊçÆÊ∫êÂàÜÂèë„ÄÇ
    function doSearch() {
        if (currentSource === "vndb") {
            doVNDBSearch();
            return;
        }
        currentPage = 1;
        _searchVersion += 1;
        _pageCache.clear();
        _inflight.clear();
        clearTimeout(_searchTimer);
        _searchTimer = setTimeout(() => loadAndRenderPage(currentPage, true), 300);
    }

    // currentSearchParams ËØªÂèñÂΩìÂâçÊêúÁ¥¢ÂèÇÊï∞Âø´ÁÖßÔºåÈÅøÂÖçËØ∑Ê±ÇËøáÁ®ãË¢´ UI ÊîπÂä®ÂΩ±Âìç„ÄÇ
    function currentSearchParams() {
        return {
            sort: document.getElementById("sortSelect").value,
            keyword: document.getElementById("searchInput").value.trim(),
            subjectType: currentSubjectType,
            tags: [...currentTags],
        };
    }

    // pageCacheKey ÁîüÊàêÂàÜÈ°µÁºìÂ≠òÈîÆÔºåÁªëÂÆöÊêúÁ¥¢Êù°‰ª∂ÂíåÈ°µÁ†Å„ÄÇ
    function pageCacheKey(params, page) {
        return JSON.stringify([
            params.tags,
            params.keyword,
            params.subjectType,
            params.sort,
            page,
            getSearchPageSize(),
        ]);
    }

    // trimCache Â¶ÇÊûúÁºìÂ≠òË∂ÖÈôêÔºåÂà†Èô§ÊúÄÊó©ÂÜôÂÖ•ÁöÑÊù°ÁõÆ„ÄÇ
    function trimCache() {
        while (_pageCache.size > CACHE_LIMIT) {
            const oldestKey = _pageCache.keys().next().value;
            if (!oldestKey) break;
            _pageCache.delete(oldestKey);
        }
    }

    // fetchPageData Ëé∑ÂèñÊåáÂÆöÈ°µÊï∞ÊçÆÔºöÂÖàËØªÁºìÂ≠òÔºåÂÜçÂ§çÁî®È£ûË°å‰∏≠ËØ∑Ê±ÇÔºåÊúÄÂêéÂèëÊñ∞ËØ∑Ê±Ç„ÄÇ
    async function fetchPageData(page, params, version) {
        const key = pageCacheKey(params, page);
        if (_pageCache.has(key)) {
            return _pageCache.get(key);
        }
        if (_inflight.has(key)) {
            return _inflight.get(key);
        }

        const pageSize = getSearchPageSize();
        const offset = (page - 1) * pageSize;
        const body = {
            offset,
            limit: pageSize,
            sort: params.sort,
            subjectType: params.subjectType,
        };
        if (params.tags.length > 0) body.tags = params.tags;
        if (params.keyword) body.keyword = params.keyword;

        const promise = (async () => {
            const resp = await fetch("/api/browse", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            const data = await resp.json();
            if (!data.error && version === _searchVersion) {
                _pageCache.set(key, data);
                trimCache();
            }
            return data;
        })();

        _inflight.set(key, promise);
        promise.finally(() => _inflight.delete(key));
        return promise;
    }

    // prefetchAround ÂêéÂè∞È¢ÑÂä†ËΩΩÁõ∏ÈÇªÈ°µÔºåÂ§çÁî® fetchPageData ÂéªÈáçÈÄªËæë„ÄÇ
    function prefetchAround(page, totalPages, params, version) {
        PREFETCH_STEPS.forEach(step => {
            const nextPage = page + step;
            if (nextPage < 1 || nextPage > totalPages || nextPage === page) {
                return;
            }
            fetchPageData(nextPage, params, version).catch(() => {});
        });
    }

    // loadAndRenderPage Âä†ËΩΩÂπ∂Ê∏≤ÊüìÊåáÂÆöÈ°µÔºåÊîØÊåÅÁºìÂ≠òÂëΩ‰∏≠„ÄÅËØ∑Ê±ÇÂéªÈáçÂíåÂêéÂè∞È¢ÑÂä†ËΩΩ„ÄÇ
    async function loadAndRenderPage(page, showLoading) {
        const version = _searchVersion;
        const params = currentSearchParams();

        const resultsDiv = document.getElementById("searchResults");
        const btn = document.getElementById("searchBtn");
        _loadingRequests += 1;
        btn.disabled = true;
        btn.textContent = "ÊêúÁ¥¢‰∏≠...";
        if (showLoading) {
            resultsDiv.innerHTML = '<div class="search-status"><div class="spinner"></div><br>Ê≠£Âú®Âä†ËΩΩ‰ΩúÂìÅ...</div>';
            document.getElementById("pagination").innerHTML = "";
        }

        try {
            const data = await fetchPageData(page, params, version);
            if (version !== _searchVersion) return;
            if (page !== currentPage) return;

            if (data.error) {
                resultsDiv.innerHTML = `<div class="search-status">‚ùå ${data.error}</div>`;
                return;
            }
            renderBrowseResults(data);
            const totalPages = Math.max(1, Math.ceil((data.total || 0) / getSearchPageSize()));
            prefetchAround(page, totalPages, params, version);
        } catch (e) {
            if (version !== _searchVersion) return;
            if (page !== currentPage) return;
            resultsDiv.innerHTML = `<div class="search-status">‚ùå ÊêúÁ¥¢Âá∫Èîô: ${e.message}</div>`;
        } finally {
            _loadingRequests = Math.max(0, _loadingRequests - 1);
            if (_loadingRequests === 0) {
                btn.disabled = false;
                btn.textContent = "ÊêúÁ¥¢";
            }
        }
    }

    // renderBrowseResults Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûúÂç°ÁâáÂíåÂàÜÈ°µ„ÄÇ
    function renderBrowseResults(data) {
        const resultsDiv = document.getElementById("searchResults");
        currentTotal = data.total || 0;
        const items = data.results || [];
        const totalPages = Math.max(1, Math.ceil(currentTotal / getSearchPageSize()));

        // ÊòæÁ§∫ÁªìÊûú‰ø°ÊÅØ
        const infoDiv = document.getElementById("resultInfo");
        infoDiv.style.display = "flex";
        document.getElementById("resultCount").textContent =
            `ÂÖ± ${currentTotal} ‰∏™ÁªìÊûú ¬∑ Á¨¨ ${currentPage} / ${totalPages} È°µ`;

        if (items.length === 0) {
            resultsDiv.innerHTML = '<div class="search-status">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥‰ΩúÂìÅ</div>';
            document.getElementById("pagination").innerHTML = "";
            return;
        }

        // Ê∏≤ÊüìÁªìÊûúÂç°Áâá
        resultsDiv.innerHTML = "";
        const grid = document.createElement("div");
        grid.className = "search-results";
        resultsDiv.appendChild(grid);

        // ËÆ°ÁÆóÂàóÊï∞Âπ∂Êà™Êñ≠Âà∞ÂÆåÊï¥Ë°åÔºåÈÅøÂÖçÊúÄÂêé‰∏ÄË°åÁ©∫‰Ωç
        const pageSize = getSearchPageSize();
        const cols = pageSize / SEARCH_ROWS;
        const displayCount = items.length >= cols
            ? Math.floor(items.length / cols) * cols
            : items.length;

        items.slice(0, displayCount).forEach(item => {
            const el = document.createElement("div");
            el.className = "search-item";
            const displayName = item.name_cn || item.name;
            const subName = item.name_cn ? item.name : "";
            const coverSrc = item.cover || "";
            const typeLabel = item.type_label || "";
            const typeClass = typeLabel === "Âä®Áîª" ? "type-anime"
                            : typeLabel === "Ê∏∏Êàè" ? "type-game"
                            : typeLabel === "Êº´Áîª" ? "type-manga"
                            : typeLabel === "Â∞èËØ¥" ? "type-novel" : "";
            const score = item.score ? `‚≠ê${item.score}` : "";

            el.innerHTML = `
                ${coverSrc
                    ? `<img class="search-item-img" src="${coverSrc}" alt="${displayName}" loading="lazy"
                           onerror="this.style.display='none'">`
                    : `<div class="search-item-img" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">Êó†Âõæ</div>`
                }
                <div class="search-item-info">
                    <div class="search-item-name" title="${displayName}">${displayName}</div>
                    ${subName ? `<div class="search-item-sub" title="${subName}">${subName}</div>` : ""}
                </div>
                <div class="search-item-meta">
                    <span class="source-badge source-bgm">BGM</span>
                    ${typeLabel ? `<span class="search-item-type ${typeClass}">${typeLabel}</span>` : ""}
                    ${score ? `<span class="search-item-score">${score}</span>` : ""}
                </div>
            `;
            el.onclick = () => downloadAndApplyCover(item, "bgm");
            grid.appendChild(el);
        });

        renderPagination(totalPages);
    }

    // renderPagination Ê∏≤ÊüìÂàÜÈ°µÊåâÈíÆ„ÄÇ
    function renderPagination(totalPages) {
        const pag = document.getElementById("pagination");
        pag.innerHTML = "";
        if (totalPages <= 1) return;

        const addBtn = (label, page, disabled = false, active = false) => {
            const b = document.createElement("button");
            b.className = "page-btn" + (active ? " active" : "");
            b.textContent = label;
            b.disabled = disabled;
            if (!disabled && !active) b.onclick = () => goToPage(page);
            pag.appendChild(b);
        };
        const addEllipsis = () => {
            const s = document.createElement("span");
            s.className = "page-ellipsis";
            s.textContent = "‚Ä¶";
            pag.appendChild(s);
        };

        // ‰∏ä‰∏ÄÈ°µ
        addBtn("‚Äπ", currentPage - 1, currentPage <= 1);
        // È°µÁ†ÅÔºàÂΩìÂâçÈ°µÂâçÂêéÂêÑÊòæÁ§∫ 2 È°µÔºåÈ¶ñÂ∞æË∂ÖËåÉÂõ¥Âä†ÁúÅÁï•Âè∑Ôºâ
        const WING = 2;
        let lo = Math.max(1, currentPage - WING);
        let hi = Math.min(totalPages, currentPage + WING);
        if (lo > 1) { addBtn("1", 1); if (lo > 2) addEllipsis(); }
        for (let p = lo; p <= hi; p++) addBtn(String(p), p, false, p === currentPage);
        if (hi < totalPages) { if (hi < totalPages - 1) addEllipsis(); addBtn(String(totalPages), totalPages); }
        // ‰∏ã‰∏ÄÈ°µ
        addBtn("‚Ä∫", currentPage + 1, currentPage >= totalPages);
    }

    // goToPage Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µ„ÄÇ
    function goToPage(page) {
        currentPage = page;
        const params = currentSearchParams();
        const key = pageCacheKey(params, page);
        const shouldShowLoading = !_pageCache.has(key) && !_inflight.has(key);
        loadAndRenderPage(page, shouldShowLoading);
        document.getElementById("searchResults").scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // downloadAndApplyCover ‰∏ãËΩΩÂ∞ÅÈù¢Âπ∂Â∫îÁî®Âà∞ÂΩìÂâçÊ†ºÂ≠êÔºåsource ÂèØ‰∏∫ "bgm" Êàñ "vndb"
    async function downloadAndApplyCover(item, source) {
        if (!item.cover) {
            alert("ËØ•‰ΩúÂìÅÊ≤°ÊúâÂ∞ÅÈù¢ÂõæÁâá");
            return;
        }

        // ÊòæÁ§∫‰∏ãËΩΩÈÅÆÁΩ©
        const overlay = document.createElement("div");
        overlay.className = "download-overlay";
        overlay.innerHTML = `<div class="download-overlay-box">
            <div class="spinner"></div>
            <div>Ê≠£Âú®‰∏ãËΩΩÂ∞ÅÈù¢...</div>
        </div>`;
        document.body.appendChild(overlay);

        try {
            const displayName = item.name_cn || item.name || "cover";
            const safeName = displayName.replace(/[<>:"\/\\|?*\s]/g, "_").substring(0, 60);
            const filename = `${safeName}_${item.id}`;

            const resp = await fetch("/api/download-cover", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: item.cover, filename, source: source || "bgm" })
            });
            const data = await resp.json();

            if (data.error) {
                alert("‰∏ãËΩΩÂ§±Ë¥•: " + data.error);
                return;
            }

            // Â∞Ü‰∏ãËΩΩÁöÑÂ∞ÅÈù¢Â∫îÁî®Âà∞ÂΩìÂâçÊ†ºÂ≠ê
            const coverPath = "covers/" + encodeURIComponent(data.filename);
            // ËÆ∞ÂΩï‰ΩúÂìÅ ID Áî®‰∫éÊé®ËçêÂéªÈáç
            if (source !== "vndb" && typeof item.id === "number") {
                cellSubjectIDs[activeCellIndex] = item.id;
            }
            selectCover(coverPath, data.filename);
            await loadCovers();
        } catch (e) {
            alert("‰∏ãËΩΩÂá∫Èîô: " + e.message);
        } finally {
            overlay.remove();
        }
    }

    // ---- VNDB ÊêúÁ¥¢ÂäüËÉΩ ----

    // doVNDBSearch Ëß¶Âèë VNDB ÊêúÁ¥¢Ôºà300ms Èò≤ÊäñÔºâ„ÄÇ
    function doVNDBSearch() {
        const keyword = document.getElementById("searchInput").value.trim();
        if (!keyword) return;
        vndbPage = 1;
        _vndbSearchVersion += 1;
        _vndbPageCache.clear();
        _vndbInflight.clear();
        clearTimeout(_vndbSearchTimer);
        _vndbSearchTimer = setTimeout(() => loadAndRenderVNDBPage(vndbPage, true), 300);
    }

    // vndbPageCacheKey ÁîüÊàê VNDB ÂàÜÈ°µÁºìÂ≠òÈîÆ„ÄÇ
    function vndbPageCacheKey(keyword, page) {
        return JSON.stringify(["vndb", keyword, page, getSearchPageSize()]);
    }

    // fetchVNDBPageData Ëé∑Âèñ VNDB ÊåáÂÆöÈ°µÊï∞ÊçÆÔºåÂ∏¶ÁºìÂ≠òÂíåÂéªÈáç„ÄÇ
    async function fetchVNDBPageData(page, keyword, version) {
        const key = vndbPageCacheKey(keyword, page);
        if (_vndbPageCache.has(key)) return _vndbPageCache.get(key);
        if (_vndbInflight.has(key)) return _vndbInflight.get(key);

        const promise = (async () => {
            const resp = await fetch("/api/vndb/search", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ keyword, page, limit: getSearchPageSize() })
            });
            const data = await resp.json();
            if (!data.error && version === _vndbSearchVersion) {
                _vndbPageCache.set(key, data);
                while (_vndbPageCache.size > CACHE_LIMIT) {
                    _vndbPageCache.delete(_vndbPageCache.keys().next().value);
                }
            }
            return data;
        })();

        _vndbInflight.set(key, promise);
        promise.finally(() => _vndbInflight.delete(key));
        return promise;
    }

    // prefetchVNDBAround ÂêéÂè∞È¢ÑÂä†ËΩΩ VNDB Áõ∏ÈÇªÈ°µ„ÄÇ
    function prefetchVNDBAround(page, totalPages, keyword, version) {
        VNDB_PREFETCH_STEPS.forEach(step => {
            const p = page + step;
            if (p >= 1 && p <= totalPages && p !== page)
                fetchVNDBPageData(p, keyword, version).catch(() => {});
        });
    }

    // loadAndRenderVNDBPage Âä†ËΩΩÂπ∂Ê∏≤Êüì VNDB ÊåáÂÆöÈ°µÔºà‰ΩøÁî®ÂÖ±‰∫´ÁªìÊûúÂå∫ÂüüÔºâ„ÄÇ
    async function loadAndRenderVNDBPage(page, showLoading) {
        const version = _vndbSearchVersion;
        const keyword = document.getElementById("searchInput").value.trim();
        if (!keyword) return;

        const resultsDiv = document.getElementById("searchResults");
        const btn = document.getElementById("searchBtn");
        _vndbLoadingRequests += 1;
        btn.disabled = true;
        btn.textContent = "ÊêúÁ¥¢‰∏≠...";
        if (showLoading) {
            resultsDiv.innerHTML = '<div class="search-status"><div class="spinner"></div><br>Ê≠£Âú®ÊêúÁ¥¢ VNDB...</div>';
            document.getElementById("pagination").innerHTML = "";
        }

        try {
            const data = await fetchVNDBPageData(page, keyword, version);
            if (version !== _vndbSearchVersion) return;
            if (page !== vndbPage) return;

            if (data.error) {
                resultsDiv.innerHTML = `<div class="search-status">‚ùå ${data.error}</div>`;
                return;
            }
            renderVNDBResults(data);
            const totalPages = Math.max(1, Math.ceil((data.total || 0) / getSearchPageSize()));
            prefetchVNDBAround(page, totalPages, keyword, version);
        } catch (e) {
            if (version !== _vndbSearchVersion) return;
            if (page !== vndbPage) return;
            resultsDiv.innerHTML = `<div class="search-status">‚ùå ÊêúÁ¥¢Âá∫Èîô: ${e.message}</div>`;
        } finally {
            _vndbLoadingRequests = Math.max(0, _vndbLoadingRequests - 1);
            if (_vndbLoadingRequests === 0) {
                btn.disabled = false;
                btn.textContent = "ÊêúÁ¥¢";
            }
        }
    }

    // renderVNDBResults Ê∏≤Êüì VNDB ÊêúÁ¥¢ÁªìÊûúÂç°ÁâáÂíåÂàÜÈ°µ„ÄÇ
    function renderVNDBResults(data) {
        const resultsDiv = document.getElementById("searchResults");
        vndbTotal = data.total || 0;
        const items = data.results || [];
        const totalPages = Math.max(1, Math.ceil(vndbTotal / getSearchPageSize()));

        const infoDiv = document.getElementById("resultInfo");
        infoDiv.style.display = "flex";
        document.getElementById("resultCount").textContent =
            `ÂÖ± ${vndbTotal} ‰∏™ÁªìÊûú ¬∑ Á¨¨ ${vndbPage} / ${totalPages} È°µ`;

        if (items.length === 0) {
            resultsDiv.innerHTML = '<div class="search-status">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥‰ΩúÂìÅ</div>';
            document.getElementById("pagination").innerHTML = "";
            return;
        }

        resultsDiv.innerHTML = "";
        const grid = document.createElement("div");
        grid.className = "search-results";
        resultsDiv.appendChild(grid);

        // ËÆ°ÁÆóÂàóÊï∞Âπ∂Êà™Êñ≠Âà∞ÂÆåÊï¥Ë°åÔºåÈÅøÂÖçÊúÄÂêé‰∏ÄË°åÁ©∫‰Ωç
        const pageSize = getSearchPageSize();
        const cols = pageSize / SEARCH_ROWS;
        const displayCount = items.length >= cols
            ? Math.floor(items.length / cols) * cols
            : items.length;

        items.slice(0, displayCount).forEach(item => {
            const el = document.createElement("div");
            el.className = "search-item";
            const displayName = item.name_cn || item.name;
            const subName = item.name_cn ? item.name : "";
            const coverSrc = item.cover || "";
            const score = item.score ? `‚≠ê${item.score.toFixed(1)}` : "";

            el.innerHTML = `
                ${coverSrc
                    ? `<img class="search-item-img" src="${coverSrc}" alt="${displayName}" loading="lazy"
                           onerror="this.style.display='none'">`
                    : `<div class="search-item-img" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">Êó†Âõæ</div>`
                }
                <div class="search-item-info">
                    <div class="search-item-name" title="${displayName}">${displayName}</div>
                    ${subName ? `<div class="search-item-sub" title="${subName}">${subName}</div>` : ""}
                </div>
                <div class="search-item-meta">
                    <span class="source-badge source-vndb">VNDB</span>
                    ${score ? `<span class="search-item-score">${score}</span>` : ""}
                </div>
            `;
            el.onclick = () => downloadAndApplyCover(item, "vndb");
            grid.appendChild(el);
        });

        renderVNDBPagination(totalPages);
    }

    // renderVNDBPagination Ê∏≤Êüì VNDB ÂàÜÈ°µÊåâÈíÆ„ÄÇ
    function renderVNDBPagination(totalPages) {
        const pag = document.getElementById("pagination");
        pag.innerHTML = "";
        if (totalPages <= 1) return;

        const addBtn = (label, page, disabled = false, active = false) => {
            const b = document.createElement("button");
            b.className = "page-btn" + (active ? " active" : "");
            b.textContent = label;
            b.disabled = disabled;
            if (!disabled && !active) b.onclick = () => goToVNDBPage(page);
            pag.appendChild(b);
        };
        const addEllipsis = () => {
            const s = document.createElement("span");
            s.className = "page-ellipsis";
            s.textContent = "‚Ä¶";
            pag.appendChild(s);
        };

        addBtn("‚Äπ", vndbPage - 1, vndbPage <= 1);
        const WING = 2;
        let lo = Math.max(1, vndbPage - WING);
        let hi = Math.min(totalPages, vndbPage + WING);
        if (lo > 1) { addBtn("1", 1); if (lo > 2) addEllipsis(); }
        for (let p = lo; p <= hi; p++) addBtn(String(p), p, false, p === vndbPage);
        if (hi < totalPages) { if (hi < totalPages - 1) addEllipsis(); addBtn(String(totalPages), totalPages); }
        addBtn("‚Ä∫", vndbPage + 1, vndbPage >= totalPages);
    }

    // goToVNDBPage Ë∑≥ËΩ¨ VNDB ÊåáÂÆöÈ°µ„ÄÇ
    function goToVNDBPage(page) {
        vndbPage = page;
        const keyword = document.getElementById("searchInput").value.trim();
        const key = vndbPageCacheKey(keyword, page);
        const shouldShowLoading = !_vndbPageCache.has(key) && !_vndbInflight.has(key);
        loadAndRenderVNDBPage(page, shouldShowLoading);
        document.getElementById("searchResults").scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // saveState Â∞ÜÊ†ºÂ≠êÊï∞ÊçÆ‰øùÂ≠òÂà∞ÊúçÂä°Á´Ø state.json„ÄÇ
    async function saveState() {
        try {
            await fetch("/api/state", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    cells: cellImages,
                    crops: cellCrops,
                    subjectIDs: cellSubjectIDs,
                    swapOffsets: cellSwapOffsets,
                })
            });
        } catch (e) {
            console.warn("‰øùÂ≠òÁä∂ÊÄÅÂ§±Ë¥•:", e);
        }
    }

    // loadState ‰ªéÊúçÂä°Á´ØËØªÂèñÂπ∂ÊÅ¢Â§çÂ∑≤‰øùÂ≠òÁöÑÊ†ºÂ≠êÁä∂ÊÄÅ
    async function loadState() {
        try {
            const resp = await fetch("/api/state");
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data.cells) return;
            data.cells.forEach((url, i) => {
                if (url && i < cellImages.length) {
                    cellImages[i] = url;
                    if (Array.isArray(data.crops) && data.crops[i]) {
                        cellCrops[i] = clampCrop(cloneCrop(data.crops[i]));
                    } else {
                        cellCrops[i] = defaultCrop();
                    }
                    if (Array.isArray(data.subjectIDs) && data.subjectIDs[i] != null) {
                        cellSubjectIDs[i] = data.subjectIDs[i];
                    }
                    if (Array.isArray(data.swapOffsets) && data.swapOffsets[i]) {
                        cellSwapOffsets[i] = data.swapOffsets[i];
                    }
                    renderCellImage(i);
                }
            });
            updateProgressBar();
        } catch (e) {
            console.warn("Âä†ËΩΩÁä∂ÊÄÅÂ§±Ë¥•:", e);
        }
    }

    // saveImage Â∞ÜÂΩìÂâçË°®Ê†ºÁªòÂà∂Âà∞ canvas Âπ∂‰∏ãËΩΩ‰∏∫ PNG„ÄÇ
    async function saveImage() {
        const cols = 6;
        const rows = 10;
        const boxW = 220;
        const boxH = 310;
        const border = 2;
        const padding = 36;
        const titleH = 70;
        const labelH = 40;
        const totalW = padding * 2 + cols * boxW + (cols + 1) * border;
        const totalH = padding * 2 + titleH + rows * boxH + (rows + 1) * border;

        const canvas = document.getElementById("exportCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = totalW;
        canvas.height = totalH;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, totalW, totalH);

        ctx.fillStyle = "#333";
        ctx.font = "bold 36px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ACGNÁîüÊ∂Ø‰∏™‰∫∫ÂñúÂ•ΩË°®", totalW / 2, padding + titleH / 2);

        const loadImg = (src) => new Promise((resolve) => {
            if (!src) {
                resolve(null);
                return;
            }
            if (_imgCache.has(src)) {
                resolve(_imgCache.get(src));
                return;
            }
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                _imgCache.set(src, img);
                resolve(img);
            };
            img.onerror = () => resolve(null);
            img.src = src;
        });

        const imgs = await Promise.all(cellImages.map(loadImg));
        const gridLeft = padding;
        const gridTop = padding + titleH;

        for (let i = 0; i < texts.length; i++) {
            const col = i % cols;
            const row = Math.floor(i / cols);
            const x = gridLeft + col * boxW + (col + 1) * border;
            const y = gridTop + row * boxH + (row + 1) * border;

            ctx.fillStyle = "#fff";
            ctx.fillRect(x, y, boxW, boxH);

            if (imgs[i]) {
                ctx.save();
                ctx.beginPath();
                ctx.rect(x, y, boxW, boxH - labelH);
                ctx.clip();
                coverDraw(ctx, imgs[i], x, y, boxW, boxH - labelH, getCellCrop(i));
                ctx.restore();
            }

            const textY = y + boxH - labelH;
            ctx.fillStyle = "#f0f0f0";
            ctx.fillRect(x, textY, boxW, labelH);
            ctx.strokeStyle = "#ccc";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, textY);
            ctx.lineTo(x + boxW, textY);
            ctx.stroke();

            ctx.fillStyle = "#333";
            ctx.font = "bold 18px sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(texts[i], x + boxW / 2, textY + labelH / 2);
        }

        ctx.strokeStyle = "#333";
        ctx.lineWidth = border;
        const gridW = cols * boxW + (cols + 1) * border;
        const gridH = rows * boxH + (rows + 1) * border;

        for (let r = 0; r <= rows; r++) {
            const lineY = gridTop + r * boxH + r * border + border / 2;
            ctx.beginPath();
            ctx.moveTo(gridLeft, lineY);
            ctx.lineTo(gridLeft + gridW, lineY);
            ctx.stroke();
        }

        for (let c = 0; c <= cols; c++) {
            const lineX = gridLeft + c * boxW + c * border + border / 2;
            ctx.beginPath();
            ctx.moveTo(lineX, gridTop);
            ctx.lineTo(lineX, gridTop + gridH);
            ctx.stroke();
        }

        const link = document.createElement("a");
        link.download = "ACGNÁîüÊ∂Ø‰∏™‰∫∫ÂñúÂ•ΩË°®.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    }

    // coverDraw ‰ΩøÁî® cover ÊñπÂºèÁªòÂà∂ÂõæÁâáÂπ∂Â∫îÁî®Ë£ÅÂâ™ÔºàcenterX/centerY ÊéßÂà∂ÂÖ®ÂõæÂÜÖÁöÑÂèØËßÜÂå∫ÂüüÂÅèÁßªÔºâ„ÄÇ
    function coverDraw(ctx, img, x, y, w, h, crop = defaultCrop()) {
        crop = clampCrop(cloneCrop(crop));
        const imageRatio = img.width / img.height;
        const boxRatio = w / h;
        let baseW, baseH;
        if (imageRatio > boxRatio) {
            baseH = img.height;
            baseW = baseH * boxRatio;
        } else {
            baseW = img.width;
            baseH = baseW / boxRatio;
        }

        const srcW = baseW / crop.zoom;
        const srcH = baseH / crop.zoom;
        const maxOffX = img.width - srcW;
        const maxOffY = img.height - srcH;
        const srcX = crop.centerX * maxOffX;
        const srcY = crop.centerY * maxOffY;

        ctx.drawImage(img, srcX, srcY, srcW, srcH, x, y, w, h);
    }

    // ---- ËøõÂ∫¶Êù° ----

    function getFilledCount() {
        return cellImages.filter(img => img !== null).length;
    }

    function updateProgressBar() {
        const filled = getFilledCount();
        const total = texts.length;
        const pct = Math.round(filled / total * 100);
        document.getElementById("progressText").textContent = `Â∑≤Â°´ ${filled}/${total}`;
        document.getElementById("progressFill").style.width = pct + "%";
    }



    // ---- ÂÖ®ÈÉ®Ê∏ÖÁ©∫ ----

    function clearAll() {
        if (!confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊ†ºÂ≠êÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ")) return;
        for (let i = 0; i < texts.length; i++) {
            cellImages[i] = null;
            cellCrops[i] = null;
            cellSubjectIDs[i] = null;
            cellSwapOffsets[i] = 0;
            renderCellImage(i);
        }
        updateProgressBar();
        saveState();
    }

    // quickClearCell Âø´Êç∑Ê∏ÖÈô§Âçï‰∏™Ê†ºÂ≠êÁöÑÂ∞ÅÈù¢
    function quickClearCell(index) {
        cellImages[index] = null;
        cellCrops[index] = null;
        cellSubjectIDs[index] = null;
        cellSwapOffsets[index] = 0;
        renderCellImage(index);
        updateProgressBar();
        saveState();
    }

    // ---- Âπ∂ÂèëÊéßÂà∂Â∑•ÂÖ∑ ----

    async function runWithConcurrency(taskFns, limit) {
        let idx = 0;
        async function worker() {
            while (idx < taskFns.length) {
                const i = idx++;
                await taskFns[i]();
            }
        }
        const workers = [];
        for (let w = 0; w < Math.min(limit, taskFns.length); w++) {
            workers.push(worker());
        }
        await Promise.all(workers);
    }

    // ---- ‰∏ÄÈîÆÊô∫ËÉΩÂ°´ÂÖÖ ----

    async function autoFillAll() {
        const specs = [];
        const indices = [];
        const excludeIDs = [];
        cellSubjectIDs.forEach(id => { if (id) excludeIDs.push(id); });
        texts.forEach((label, i) => {
            if (cellImages[i]) return;
            const mapping = cellTagMap[label];
            if (!mapping) return;
            specs.push({
                label, tags: mapping.tags || [],
                sort: mapping.sort || "rank",
                subjectType: mapping.type || "",
                offset: 0,
            });
            indices.push(i);
        });
        if (specs.length === 0) { alert("ÊâÄÊúâÊ†ºÂ≠êÈÉΩÂ∑≤Â°´ÂÖÖÔºÅ"); return; }

        const overlay = document.getElementById("fillOverlay");
        const barInner = document.getElementById("fillBarInner");
        const fillText = document.getElementById("fillText");
        const fillSub = document.getElementById("fillSub");
        overlay.style.display = "flex";
        barInner.style.width = "0%";
        fillText.textContent = "Ê≠£Âú®‰∏∫‰Ω†ÊåëÈÄâ‰ΩúÂìÅ...";
        fillSub.textContent = `0/${specs.length}`;

        try {
            const resp = await fetch("/api/recommend", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cells: specs, excludeIDs }),
            });
            const data = await resp.json();
            if (data.error) { alert("Êé®ËçêËé∑ÂèñÂ§±Ë¥•: " + data.error); return; }

            const results = data.results || [];
            const validCount = results.filter(r => r.found && r.item && r.item.cover).length;
            if (validCount === 0) {
                fillSub.textContent = "Ê≤°ÊúâÊâæÂà∞Êé®Ëçê‰ΩúÂìÅ";
                await new Promise(r => setTimeout(r, 1500));
                return;
            }

            fillText.textContent = "Ê≠£Âú®‰∏ãËΩΩÂ∞ÅÈù¢...";
            let completed = 0;

            const tasks = results.map((result, ri) => async () => {
                const cellIdx = indices[ri];
                if (!result.found || !result.item || !result.item.cover) {
                    completed++;
                    barInner.style.width = Math.round(completed / results.length * 100) + "%";
                    fillSub.textContent = `${completed}/${results.length}`;
                    return;
                }
                try {
                    const item = result.item;
                    const displayName = item.name_cn || item.name || "cover";
                    const safeName = displayName.replace(/[<>:"\/\\|?*\s]/g, "_").substring(0, 60);
                    const dlResp = await fetch("/api/download-cover", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ url: item.cover, filename: `${safeName}_${item.id}`, source: "bgm" }),
                    });
                    const dlData = await dlResp.json();
                    if (!dlData.error) {
                        cellImages[cellIdx] = "covers/" + encodeURIComponent(dlData.filename);
                        cellCrops[cellIdx] = defaultCrop();
                        cellSubjectIDs[cellIdx] = item.id;
                        renderCellImage(cellIdx, displayName);
                    }
                } catch (e) { console.warn("‰∏ãËΩΩÂ∞ÅÈù¢Â§±Ë¥•:", e); }
                completed++;
                barInner.style.width = Math.round(completed / results.length * 100) + "%";
                fillSub.textContent = `${completed}/${results.length}`;
            });

            await runWithConcurrency(tasks, 4);
        } catch (e) {
            alert("Êô∫ËÉΩÂ°´ÂÖÖÂá∫Èîô: " + e.message);
        } finally {
            overlay.style.display = "none";
            await loadCovers();
            updateProgressBar();
            saveState();
        }
    }

    // ---- ‰æßËæπÊäΩÂ±âÊé®Ëçê ----

    let _drawerIndex = -1;
    let _drawerOffset = 0;
    let _drawerItems = [];
    const DRAWER_COUNT = 9; // 3x3 ÁΩëÊ†º

    function showDrawer(index) {
        _drawerIndex = index;
        _drawerOffset = 0;
        _drawerItems = [];
        activeCellIndex = index;

        const drawer = document.getElementById("cellDrawer");
        const backdrop = document.getElementById("drawerBackdrop");
        const title = document.getElementById("drawerTitle");
        title.textContent = texts[index];

        // È´ò‰∫ÆÂΩìÂâçÊ†ºÂ≠ê
        document.querySelectorAll(".grid-cell").forEach((cell, i) => {
            cell.classList.toggle("selected", i === index);
        });

        // ÂΩìÂâçÂ∞ÅÈù¢Âå∫Âüü
        const currentSection = document.getElementById("drawerCurrentSection");
        if (cellImages[index]) {
            currentSection.style.display = "";
            document.getElementById("drawerCurrentImg").src = cellImages[index];
            document.getElementById("drawerCurrentName").textContent = texts[index];
        } else {
            currentSection.style.display = "none";
        }

        // Ëß¶ÂèëÊäΩÂ±âÂä®Áîª
        requestAnimationFrame(() => {
            backdrop.classList.add("active");
            drawer.classList.add("active");
        });

        // Âä†ËΩΩÊé®Ëçê
        loadDrawerRecommendations();

        // ESC ÂÖ≥Èó≠
        document.addEventListener("keydown", handleDrawerEscape);
    }

    function hideDrawer() {
        const drawer = document.getElementById("cellDrawer");
        const backdrop = document.getElementById("drawerBackdrop");
        
        drawer.classList.remove("active");
        backdrop.classList.remove("active");
        
        // ÁßªÈô§Ê†ºÂ≠êÈ´ò‰∫Æ
        document.querySelectorAll(".grid-cell").forEach(cell => {
            cell.classList.remove("selected");
        });
        
        document.removeEventListener("keydown", handleDrawerEscape);
        _drawerIndex = -1;
    }

    function handleDrawerEscape(e) {
        if (e.key === "Escape") {
            hideDrawer();
        }
    }

    async function loadDrawerRecommendations() {
        const index = _drawerIndex;
        if (index < 0) return;
        const label = texts[index];
        const mapping = cellTagMap[label];
        if (!mapping) {
            // Êó†Êé®ËçêÈÖçÁΩÆÁöÑÊ†ºÂ≠êÊòæÁ§∫ÊèêÁ§∫
            const grid = document.getElementById("drawerRecGrid");
            grid.innerHTML = `
                <div class="drawer-empty" style="grid-column: 1/-1;">
                    <div class="drawer-empty-icon">üé®</div>
                    <div>Ê≠§Ê†ºÂ≠êÊöÇÊó†Êô∫ËÉΩÊé®Ëçê</div>
                    <div style="font-size:12px;margin-top:8px;color:#bbb;">ÁÇπÂáª‰∏ãÊñπ„ÄåÂÆåÊï¥ÊêúÁ¥¢„ÄçÊâãÂä®ÈÄâÊã©‰ΩúÂìÅ</div>
                </div>
            `;
            document.getElementById("drawerMoreBtn").style.display = "none";
            return;
        }

        const grid = document.getElementById("drawerRecGrid");
        const moreBtn = document.getElementById("drawerMoreBtn");
        grid.innerHTML = `
            <div class="drawer-loading" style="grid-column: 1/-1;">
                <div class="spinner"></div>
                <div>Ê≠£Âú®Âä†ËΩΩÊé®Ëçê...</div>
            </div>
        `;

        try {
            const body = {
                offset: _drawerOffset,
                limit: DRAWER_COUNT + 6, // Â§öËØ∑Ê±Ç‰∏Ä‰∫õÁî®‰∫éËøáÊª§
                sort: mapping.sort || "heat",
            };
            if (mapping.tags && mapping.tags.length > 0) body.tags = mapping.tags;
            if (mapping.type) body.subjectType = mapping.type;
            // Â¶ÇÊûúÊ≤°ÊúâÊ†áÁ≠æ‰πüÊ≤°ÊúâÁ±ªÂûãÔºåÈªòËÆ§‰ΩøÁî®Âä®ÁîªÁ±ªÂûã
            if ((!mapping.tags || mapping.tags.length === 0) && !mapping.type) {
                body.subjectType = "anime";
            }

            const resp = await fetch("/api/browse", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
            });
            const data = await resp.json();
            
            if (index !== _drawerIndex) return; // Áî®Êà∑Â∑≤ÂàáÊç¢Âà∞ÂÖ∂‰ªñÊ†ºÂ≠ê
            
            if (data.error) {
                grid.innerHTML = `
                    <div class="drawer-empty" style="grid-column: 1/-1;">
                        <div class="drawer-empty-icon">üòï</div>
                        <div>Âä†ËΩΩÂ§±Ë¥•</div>
                        <div style="font-size:12px;margin-top:8px;color:#bbb;">${escapeHtml(data.error)}</div>
                    </div>
                `;
                moreBtn.style.display = "none";
                return;
            }

            const items = data.results || [];
            // ËøáÊª§Â∑≤‰ΩøÁî®ÁöÑ‰ΩúÂìÅ
            const usedIDs = new Set(cellSubjectIDs.filter(id => id != null));
            const filtered = items.filter(item => !usedIDs.has(item.id)).slice(0, DRAWER_COUNT);
            _drawerItems = filtered;

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="drawer-empty" style="grid-column: 1/-1;">
                        <div class="drawer-empty-icon">üì≠</div>
                        <div>ÊöÇÊó†Êõ¥Â§öÊé®Ëçê</div>
                        <div style="font-size:12px;margin-top:8px;color:#bbb;">ËØïËØï„ÄåÂÆåÊï¥ÊêúÁ¥¢„ÄçÊé¢Á¥¢Êõ¥Â§ö‰ΩúÂìÅ</div>
                    </div>
                `;
                moreBtn.style.display = "none";
                return;
            }

            grid.innerHTML = "";
            filtered.forEach((item, i) => {
                const el = document.createElement("div");
                el.className = "drawer-rec-item";
                el.style.animationDelay = `${i * 0.05}s`;
                el.style.animation = "fadeInUp 0.4s ease forwards";
                el.style.opacity = "0";
                
                const name = escapeHtml(item.name_cn || item.name || "");
                const score = item.score ? `‚≠ê${item.score}` : "";
                const typeLabel = item.type_label || "";
                
                el.innerHTML = `
                    ${item.cover 
                        ? `<img class="drawer-rec-img" src="${escapeHtml(item.cover)}" alt="${name}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 3 4%22><rect fill=%22%23f0f0f0%22 width=%223%22 height=%224%22/><text x=%221.5%22 y=%222.2%22 font-size=%220.5%22 text-anchor=%22middle%22 fill=%22%23ccc%22>Êó†Âõæ</text></svg>'">`
                        : `<div class="drawer-rec-img" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:16px;">üì∑</div>`
                    }
                    <div class="drawer-rec-info">
                        <div class="drawer-rec-name" title="${name}">${name}</div>
                        <div class="drawer-rec-meta">
                            ${score ? `<span class="drawer-rec-score">${score}</span>` : ""}
                            ${typeLabel ? `<span class="drawer-rec-type">${escapeHtml(typeLabel)}</span>` : ""}
                        </div>
                    </div>
                `;
                el.onclick = () => drawerSelectItem(item);
                grid.appendChild(el);
            });
            
            _drawerOffset += items.length;
            moreBtn.style.display = items.length >= DRAWER_COUNT ? "" : "none";
        } catch (e) {
            if (index !== _drawerIndex) return;
            grid.innerHTML = `
                <div class="drawer-empty" style="grid-column: 1/-1;">
                    <div class="drawer-empty-icon">‚ö†Ô∏è</div>
                    <div>ÁΩëÁªúÈîôËØØ</div>
                    <div style="font-size:12px;margin-top:8px;color:#bbb;">${escapeHtml(e.message)}</div>
                </div>
            `;
        }
    }

    // HTML ËΩ¨‰πâÈò≤Ê≠¢ XSS
    function escapeHtml(str) {
        if (!str) return "";
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function drawerLoadMore() {
        const btn = document.getElementById("drawerMoreBtn");
        btn.classList.add("pulse");
        setTimeout(() => btn.classList.remove("pulse"), 300);
        loadDrawerRecommendations();
    }

    async function drawerSelectItem(item) {
        const index = _drawerIndex;
        if (index < 0) return;

        const grid = document.getElementById("drawerRecGrid");
        grid.innerHTML = `
            <div class="drawer-loading" style="grid-column: 1/-1;">
                <div class="spinner"></div>
                <div>Ê≠£Âú®‰∏ãËΩΩÂ∞ÅÈù¢...</div>
            </div>
        `;

        try {
            const displayName = item.name_cn || item.name || "cover";
            const safeName = displayName.replace(/[<>:"\/\\|?*\s]/g, "_").substring(0, 60);
            const dlResp = await fetch("/api/download-cover", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: item.cover, filename: `${safeName}_${item.id}`, source: "bgm" }),
            });
            const dlData = await dlResp.json();
            
            if (index !== _drawerIndex) return;
            
            if (dlData.error) {
                alert("‰∏ãËΩΩÂ∞ÅÈù¢Â§±Ë¥•: " + dlData.error);
                loadDrawerRecommendations();
                return;
            }

            cellImages[index] = "covers/" + encodeURIComponent(dlData.filename);
            cellCrops[index] = defaultCrop();
            cellSubjectIDs[index] = item.id;
            
            // Ê∑ªÂä†ÊàêÂäüÂä®Áîª
            const cell = document.querySelectorAll(".grid-cell")[index];
            if (cell) {
                cell.classList.add("success-pop");
                setTimeout(() => cell.classList.remove("success-pop"), 400);
            }
            
            renderCellImage(index, displayName);
            hideDrawer();
            await loadCovers();
            updateProgressBar();
            saveState();
        } catch (e) {
            if (index !== _drawerIndex) return;
            alert("ÈÄâÊã©Â§±Ë¥•: " + e.message);
            loadDrawerRecommendations();
        }
    }

    function drawerOpenFullModal() {
        const index = _drawerIndex;
        hideDrawer();
        openCoverPicker(index);
    }

    function drawerCrop() {
        const index = _drawerIndex;
        if (index < 0 || !cellImages[index]) return;
        hideDrawer();
        openCropModal(index);
    }

    function drawerClear() {
        const index = _drawerIndex;
        if (index < 0) return;
        cellImages[index] = null;
        cellCrops[index] = null;
        cellSubjectIDs[index] = null;
        cellSwapOffsets[index] = 0;
        renderCellImage(index);
        hideDrawer();
        saveState();
        updateProgressBar();
    }

    // ---- Âø´ÈÄüÊêúÁ¥¢Ê®°ÊÄÅÊ°Ü ----

    let _quickSearchIndex = -1;
    let _quickSearchVersion = 0;
    let _quickSearchTimer = null;
    let _quickSearchOffset = 0;
    let _quickSearchItems = [];

    // handleCellClick Â§ÑÁêÜÊ†ºÂ≠êÁÇπÂáª‰∫ã‰ª∂
    function handleCellClick(index, event) {
        if (event.target.classList.contains("cell-tool-btn")) return;
        
        if (cellImages[index]) {
            showDrawer(index);
        } else {
            showQuickSearch(index);
        }
    }

    // showQuickSearch ÊòæÁ§∫Âø´ÈÄüÊêúÁ¥¢Ê®°ÊÄÅÊ°Ü
    function showQuickSearch(index) {
        _quickSearchIndex = index;
        activeCellIndex = index;
        _quickSearchVersion++;
        _quickSearchOffset = 0;
        _quickSearchItems = [];
        
        const backdrop = document.getElementById("quickSearchBackdrop");
        const popup = document.getElementById("quickSearchPopup");
        const title = document.getElementById("quickSearchTitle");
        const input = document.getElementById("quickSearchInput");
        const results = document.getElementById("quickSearchResults");
        const refreshBtn = document.getElementById("quickSearchRefreshBtn");
        
        title.textContent = texts[index];
        input.value = "";
        results.innerHTML = '<div class="quick-search-hint">ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢ÔºåÊàñÁÇπÂáª‰∏ãÊñπ„ÄåÊé®Ëçê„ÄçÊµèËßàÁÉ≠Èó®‰ΩúÂìÅ</div>';
        refreshBtn.style.display = "none";
        
        document.querySelectorAll(".grid-cell").forEach((c, i) => {
            c.classList.toggle("selected", i === index);
        });
        
        requestAnimationFrame(() => {
            backdrop.classList.add("active");
            popup.classList.add("active");
            input.focus();
        });
        
        document.addEventListener("keydown", handleQuickSearchEscape);
    }

    // hideQuickSearch ÈöêËóèÂø´ÈÄüÊêúÁ¥¢Ê®°ÊÄÅÊ°Ü
    function hideQuickSearch() {
        const backdrop = document.getElementById("quickSearchBackdrop");
        const popup = document.getElementById("quickSearchPopup");
        
        backdrop.classList.remove("active");
        popup.classList.remove("active");
        
        document.querySelectorAll(".grid-cell").forEach(c => c.classList.remove("selected"));
        document.removeEventListener("keydown", handleQuickSearchEscape);
        
        _quickSearchIndex = -1;
    }

    // handleQuickSearchEscape ESCÈîÆÂÖ≥Èó≠
    function handleQuickSearchEscape(e) {
        if (e.key === "Escape") hideQuickSearch();
    }

    // doQuickSearch ÊâßË°åÂø´ÈÄüÊêúÁ¥¢
    function doQuickSearch() {
        const keyword = document.getElementById("quickSearchInput").value.trim();
        if (!keyword) return;
        
        _quickSearchOffset = 0;
        clearTimeout(_quickSearchTimer);
        _quickSearchTimer = setTimeout(() => executeQuickSearch(keyword), 200);
    }

    // executeQuickSearch ÂÆûÈôÖÊâßË°åÊêúÁ¥¢ËØ∑Ê±Ç
    async function executeQuickSearch(keyword) {
        const version = ++_quickSearchVersion;
        const results = document.getElementById("quickSearchResults");
        const btn = document.getElementById("quickSearchBtn");
        const refreshBtn = document.getElementById("quickSearchRefreshBtn");
        
        results.innerHTML = '<div class="quick-search-loading"><div class="spinner"></div>ÊêúÁ¥¢‰∏≠...</div>';
        btn.disabled = true;
        
        try {
            const resp = await fetch("/api/browse", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ keyword, limit: 12, sort: "match" })
            });
            const data = await resp.json();
            
            if (version !== _quickSearchVersion) return;
            
            if (data.error) {
                results.innerHTML = `<div class="quick-search-empty">‚ùå ${escapeHtml(data.error)}</div>`;
                refreshBtn.style.display = "none";
                return;
            }
            
            const items = data.results || [];
            if (items.length === 0) {
                results.innerHTML = '<div class="quick-search-empty">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥‰ΩúÂìÅ</div>';
                refreshBtn.style.display = "none";
                return;
            }
            
            _quickSearchItems = items;
            renderQuickSearchResults(items);
            refreshBtn.style.display = "none";
        } catch (e) {
            if (version !== _quickSearchVersion) return;
            results.innerHTML = `<div class="quick-search-empty">‚ö†Ô∏è ÁΩëÁªúÈîôËØØ</div>`;
        } finally {
            btn.disabled = false;
        }
    }

    // renderQuickSearchResults Ê∏≤ÊüìÂø´ÈÄüÊêúÁ¥¢ÁªìÊûúÔºàÂàóË°®Â∏ÉÂ±ÄÔºâ
    function renderQuickSearchResults(items) {
        const results = document.getElementById("quickSearchResults");
        results.innerHTML = "";
        
        const list = document.createElement("div");
        list.className = "qs-list";
        
        items.forEach(item => {
            const el = document.createElement("div");
            el.className = "qs-item";
            
            const name = escapeHtml(item.name_cn || item.name || "");
            const score = item.score ? item.score.toFixed(1) : "";
            const typeLabel = item.type_label || "";
            const summary = item.summary ? escapeHtml(item.summary) : "";
            
            el.innerHTML = `
                <div class="qs-item-cover">
                    ${item.cover 
                        ? `<img src="${escapeHtml(item.cover)}" alt="" loading="lazy">`
                        : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:18px;">üì∑</div>`
                    }
                </div>
                <div class="qs-item-body">
                    <div class="qs-item-name" title="${name}">${name}</div>
                    <div class="qs-item-meta">
                        ${score ? `<span class="qs-item-score">‚≠ê${score}</span>` : ""}
                        ${typeLabel ? `<span class="qs-item-type">${escapeHtml(typeLabel)}</span>` : ""}
                    </div>
                    ${summary ? `<div class="qs-item-desc">${summary}</div>` : ""}
                </div>
            `;
            el.onclick = () => quickSearchSelectItem(item);
            list.appendChild(el);
        });
        
        results.appendChild(list);
    }

    // quickSearchSelectItem ÈÄâÊã©Âø´ÈÄüÊêúÁ¥¢ÁªìÊûú
    async function quickSearchSelectItem(item) {
        const index = _quickSearchIndex;
        if (index < 0 || !item.cover) {
            if (!item.cover) alert("ËØ•‰ΩúÂìÅÊ≤°ÊúâÂ∞ÅÈù¢");
            return;
        }
        
        const results = document.getElementById("quickSearchResults");
        results.innerHTML = '<div class="quick-search-loading"><div class="spinner"></div>Ê≠£Âú®‰∏ãËΩΩÂ∞ÅÈù¢...</div>';
        
        try {
            const displayName = item.name_cn || item.name || "cover";
            const safeName = displayName.replace(/[<>:"\/\\|?*\s]/g, "_").substring(0, 60);
            
            const resp = await fetch("/api/download-cover", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: item.cover, filename: `${safeName}_${item.id}`, source: "bgm" })
            });
            const data = await resp.json();
            
            if (data.error) {
                alert("‰∏ãËΩΩÂ§±Ë¥•: " + data.error);
                renderQuickSearchResults(_quickSearchItems);
                return;
            }
            
            cellImages[index] = "covers/" + encodeURIComponent(data.filename);
            cellCrops[index] = defaultCrop();
            if (typeof item.id === "number") cellSubjectIDs[index] = item.id;
            
            const cell = document.querySelectorAll(".grid-cell")[index];
            if (cell) {
                cell.classList.add("success-pop");
                setTimeout(() => cell.classList.remove("success-pop"), 400);
            }
            
            renderCellImage(index, displayName);
            hideQuickSearch();
            await loadCovers();
            updateProgressBar();
            saveState();
        } catch (e) {
            alert("ÈÄâÊã©Â§±Ë¥•: " + e.message);
            renderQuickSearchResults(_quickSearchItems);
        }
    }

    // quickSearchShowRec ÊòæÁ§∫Êé®Ëçê‰ΩúÂìÅ
    async function quickSearchShowRec() {
        const index = _quickSearchIndex;
        if (index < 0) return;
        
        const label = texts[index];
        const mapping = cellTagMap[label];
        
        const version = ++_quickSearchVersion;
        const results = document.getElementById("quickSearchResults");
        const refreshBtn = document.getElementById("quickSearchRefreshBtn");
        
        results.innerHTML = '<div class="quick-search-loading"><div class="spinner"></div>Âä†ËΩΩÊé®Ëçê‰ΩúÂìÅ...</div>';
        
        try {
            const body = { offset: _quickSearchOffset, limit: 12, sort: "heat" };
            if (mapping) {
                if (mapping.tags && mapping.tags.length > 0) body.tags = mapping.tags;
                if (mapping.type) body.subjectType = mapping.type;
                body.sort = mapping.sort || "heat";
            }
            if (!body.tags && !body.subjectType) body.subjectType = "anime";
            
            const resp = await fetch("/api/browse", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            const data = await resp.json();
            
            if (version !== _quickSearchVersion) return;
            
            if (data.error) {
                results.innerHTML = `<div class="quick-search-empty">‚ùå ${escapeHtml(data.error)}</div>`;
                refreshBtn.style.display = "none";
                return;
            }
            
            const items = data.results || [];
            const usedIDs = new Set(cellSubjectIDs.filter(id => id != null));
            const filtered = items.filter(item => !usedIDs.has(item.id));
            
            if (filtered.length === 0) {
                results.innerHTML = '<div class="quick-search-empty">ÊöÇÊó†Êõ¥Â§öÊé®Ëçê</div>';
                refreshBtn.style.display = "none";
                return;
            }
            
            _quickSearchItems = filtered;
            _quickSearchOffset += items.length;
            renderQuickSearchResults(filtered);
            refreshBtn.style.display = "";
        } catch (e) {
            if (version !== _quickSearchVersion) return;
            results.innerHTML = '<div class="quick-search-empty">‚ö†Ô∏è ÁΩëÁªúÈîôËØØ</div>';
        }
    }

    // quickSearchRefresh Êç¢‰∏ÄÊâπÊé®Ëçê
    function quickSearchRefresh() {
        quickSearchShowRec();
    }

    // quickSearchOpenFull ÊâìÂºÄÂÆåÊï¥ÊêúÁ¥¢ÂºπÁ™ó
    function quickSearchOpenFull() {
        const index = _quickSearchIndex;
        hideQuickSearch();
        openCoverPicker(index);
    }

    // ÂÖºÂÆπÊóßÂáΩÊï∞ÂêçÔºàÂ¶ÇÊûúÊúâÂÖ∂‰ªñÂú∞ÊñπË∞ÉÁî®Ôºâ
    function showPopover(index) { showDrawer(index); }
    function hidePopover() { hideDrawer(); }

    // ÂêØÂä®ÊµÅÁ®ãÔºöÂàùÂßãÂåñÁΩëÊ†º„ÄÅÊ†áÁ≠æÊµèËßàÂô®ÔºåÂÜçÂä†ËΩΩÂ∞ÅÈù¢ÂíåÁä∂ÊÄÅ„ÄÇ
    initGrid();
    initTagBrowser();
    loadCovers();
    loadState();
</script>

</body>
</html>
