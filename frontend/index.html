<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACGNç”Ÿæ¶¯ä¸ªäººå–œå¥½è¡¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #f0f0f0;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .ctrl-box {
            margin-top: 16px;
            margin-bottom: 16px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            background-color: #ea4c89;
            color: #fff;
            border: none;
            padding: 10px 30px;
            font-size: 15px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(234, 76, 137, 0.25);
            transition: background-color 0.3s;
        }
        .ctrl-btn:hover { background-color: #f082ac; }

        .grid-wrapper {
            background: #ffffff;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .grid-title {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(6, 150px);
            gap: 0;
        }

        .grid-cell {
            width: 150px;
            height: 240px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border-right: 2px solid #333;
            border-bottom: 2px solid #333;
            background: #fff;
            display: flex;
            flex-direction: column;
            transition: opacity 0.15s;
        }
        .grid-cell:hover { opacity: 0.85; }

        /* é¦–è¡Œé¦–åˆ—è¾¹æ¡† */
        .grid-cell:nth-child(6n+1) { border-left: 2px solid #333; }
        .grid-cell:nth-child(-n+6) { border-top: 2px solid #333; }

        .cell-img-area {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
        }
        .cell-img-area img {
            position: absolute;
            image-rendering: auto;
        }
        .cell-img-area .placeholder {
            color: #ccc;
            font-size: 28px;
            user-select: none;
        }

        .cell-label {
            height: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-top: 1px solid #ccc;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            padding: 0 4px;
        }

        /* ========== å°é¢é€‰æ‹©å¼¹çª— ========== */
        .cover-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.55);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .cover-modal.active { display: flex; }

        .cover-modal-inner {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            max-width: 820px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        .cover-modal-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
            text-align: center;
        }
        .cover-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px;
        }
        .cover-item {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.2s;
            aspect-ratio: 3/4;
        }
        .cover-item:hover {
            border-color: #ea4c89;
            box-shadow: 0 0 8px rgba(234,76,137,0.35);
            transform: scale(1.04);
        }
        .cover-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: auto;
        }
        .cover-modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 14px;
        }
        .cover-modal-btn {
            padding: 7px 24px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        .cover-modal-btn.close-btn { background: #eee; color: #555; }
        .cover-modal-btn.close-btn:hover { background: #ddd; }
        .cover-modal-btn.clear-btn { background: #ff6b6b; color: #fff; }
        .cover-modal-btn.clear-btn:hover { background: #ee5a5a; }

        .no-covers-msg {
            text-align: center;
            color: #999;
            padding: 36px 20px;
            font-size: 13px;
            line-height: 2;
            grid-column: 1 / -1;
        }

        /* å°é¢å·¥å…·æ  */
        .cover-toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin-bottom: 10px;
        }
        .cover-tool-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 14px;
            border: 1.5px solid #ddd;
            border-radius: 6px;
            background: #fff;
            font-size: 12px;
            font-weight: bold;
            color: #555;
            cursor: pointer;
            transition: all 0.15s;
        }
        .cover-tool-btn:hover { border-color: #ea4c89; color: #ea4c89; }
        .cover-tool-btn:active { background: #fce4ec; }
        .cover-tool-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Tab åˆ‡æ¢ */
        .modal-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 14px;
            border-bottom: 2px solid #eee;
        }
        .modal-tab {
            flex: 1;
            padding: 10px 0;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            background: none;
            border-top: none; border-left: none; border-right: none;
        }
        .modal-tab:hover { color: #666; }
        .modal-tab.active {
            color: #ea4c89;
            border-bottom-color: #ea4c89;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* æœç´¢é¢æ¿ï¼ˆå ä½ï¼Œåç»­è¿ç§»ï¼‰ */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-bar input:focus { border-color: #ea4c89; }
        .search-bar select {
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
            outline: none;
        }
        .search-bar select:focus { border-color: #ea4c89; }
        .search-bar button {
            padding: 8px 18px;
            background: #ea4c89;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }
        .search-bar button:hover { background: #f082ac; }
        .search-bar button:disabled { background: #ccc; cursor: not-allowed; }

        .search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        .search-item {
            cursor: pointer;
            border: 2px solid #eee;
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.2s;
            background: #fff;
        }
        .search-item:hover {
            border-color: #ea4c89;
            box-shadow: 0 2px 12px rgba(234,76,137,0.2);
            transform: translateY(-2px);
        }
        .search-item-img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            display: block;
            background: #f5f5f5;
        }
        .search-item-info {
            padding: 6px 8px;
        }
        .search-item-name {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .search-item-sub {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .search-status {
            text-align: center;
            padding: 30px 20px;
            color: #999;
            font-size: 13px;
        }
        .search-status .spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 3px solid #eee;
            border-top-color: #ea4c89;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-bottom: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ä¸‹è½½ä¸­è¦†ç›–å±‚ */
        .download-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .download-overlay-box {
            background: #fff;
            padding: 24px 36px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .download-overlay-box .spinner {
            width: 28px; height: 28px;
            border: 3px solid #eee;
            border-top-color: #ea4c89;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin: 0 auto 10px;
        }

        /* æ ‡ç­¾æµè§ˆ */
        .tag-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        .tag-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            background: #fce4ec;
            color: #c62828;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .tag-badge .remove-tag {
            cursor: pointer;
            font-size: 14px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .tag-badge .remove-tag:hover { opacity: 1; }
        .result-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #999;
        }
        .search-item-meta {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px 6px;
        }
        .search-item-type {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 3px;
            font-weight: bold;
            background: #e3f2fd;
            color: #1565c0;
        }
        .search-item-type.type-anime { background: #e3f2fd; color: #1565c0; }
        .search-item-type.type-game  { background: #fce4ec; color: #c62828; }
        .search-item-type.type-book  { background: #e8f5e9; color: #2e7d32; }
        .search-item-score {
            font-size: 10px;
            color: #ff9800;
            font-weight: bold;
        }
        .load-more-wrapper {
            text-align: center;
            padding: 16px 0;
            grid-column: 1 / -1;
        }
        .load-more-btn {
            padding: 8px 32px;
            background: #fff;
            border: 2px solid #ea4c89;
            color: #ea4c89;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .load-more-btn:hover {
            background: #ea4c89;
            color: #fff;
        }
        .load-more-btn:disabled { background: #eee; border-color: #ccc; color: #999; cursor: not-allowed; }

        /* ç±»å‹ç­›é€‰ */
        .type-filter-row {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .type-btn {
            padding: 4px 14px;
            border: 1.5px solid #ddd;
            border-radius: 14px;
            background: #fff;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            color: #555;
            transition: all 0.15s;
        }
        .type-btn:hover { border-color: #ea4c89; color: #ea4c89; }
        .type-btn.active {
            background: #ea4c89;
            border-color: #ea4c89;
            color: #fff;
        }

        /* åˆ†é¡µ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            padding: 12px 0 4px;
            flex-wrap: wrap;
            grid-column: 1 / -1;
        }
        .page-btn {
            min-width: 32px;
            height: 32px;
            padding: 0 8px;
            border: 1.5px solid #ddd;
            border-radius: 6px;
            background: #fff;
            font-size: 13px;
            cursor: pointer;
            color: #555;
            transition: all 0.15s;
        }
        .page-btn:hover { border-color: #ea4c89; color: #ea4c89; }
        .page-btn.active { background: #ea4c89; border-color: #ea4c89; color: #fff; font-weight: bold; }
        .page-btn:disabled { background: #f5f5f5; color: #ccc; cursor: not-allowed; border-color: #eee; }
        .page-ellipsis { color: #aaa; font-size: 13px; padding: 0 4px; }

        /* æ ‡ç­¾æµè§ˆå™¨ */
        .tag-browser {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 8px 10px;
            background: #fafafa;
            margin-bottom: 10px;
        }
        .tag-browser::-webkit-scrollbar { width: 4px; }
        .tag-browser::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }
        .tag-cat-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 7px;
        }
        .tag-cat-row:last-child { margin-bottom: 0; }
        .tag-cat-label {
            font-size: 11px;
            color: #aaa;
            white-space: nowrap;
            padding-top: 4px;
            min-width: 48px;
            font-weight: bold;
        }
        .tag-cat-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .tag-pick-btn {
            padding: 3px 10px;
            border: 1.5px solid #ddd;
            border-radius: 14px;
            background: #fff;
            font-size: 12px;
            cursor: pointer;
            color: #555;
            transition: all 0.15s;
            line-height: 1.6;
        }
        .tag-pick-btn:hover { border-color: #ea4c89; color: #ea4c89; }
        .tag-pick-btn.active {
            background: #ea4c89;
            border-color: #ea4c89;
            color: #fff;
        }
        .search-sort-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        .search-sort-row label {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
        }
        .sort-select {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
            outline: none;
        }
        .sort-select:focus { border-color: #ea4c89; }

        /* å°é¢ç¼–è¾‘æŒ‰é’® */
        .cover-edit-btn {
            position: absolute;
            top: 4px; right: 4px;
            width: 26px; height: 26px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }
        .cover-item:hover .cover-edit-btn { opacity: 1; }
        .grid-cell:hover .cover-edit-btn { opacity: 1; }
        .cover-edit-btn:hover { background: #ea4c89 !important; }

        /* è£å‰ªç¼–è¾‘å™¨ */
        .crop-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.78);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .crop-modal.active { display: flex; }
        .crop-modal-inner {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            width: min(700px, 95vw);
            max-height: 94vh;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.45);
        }
        .crop-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .crop-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 80%;
        }
        .crop-close-x {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #aaa;
            padding: 0 2px;
            line-height: 1;
        }
        .crop-close-x:hover { color: #333; }
        .crop-body {
            display: flex;
            gap: 14px;
            align-items: stretch;
        }
        .crop-workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .crop-stage {
            background: #1c1c1c;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        .crop-viewport {
            width: min(360px, 65vw);
            aspect-ratio: 3 / 4;
            max-height: 56vh;
            overflow: hidden;
            position: relative;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.18);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
            cursor: move;
            background: #000;
            touch-action: none;
            transition: border-color 0.15s;
        }
        .crop-viewport:hover {
            border-color: rgba(234,76,137,0.4);
        }
        .crop-viewport.dragging {
            cursor: move;
            border-color: rgba(234,76,137,0.7);
        }
        .crop-img {
            position: absolute;
            user-select: none;
            pointer-events: none;
        }
        .crop-grid-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            background-image:
                linear-gradient(to right, rgba(255,255,255,0.6) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.6) 1px, transparent 1px);
            background-size: 33.333% 33.333%;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.4);
        }
        .crop-center-mark {
            position: absolute;
            top: 50%; left: 50%;
            width: 20px; height: 20px;
            margin: -10px 0 0 -10px;
            pointer-events: none;
            z-index: 2;
            opacity: 0.6;
            transition: opacity 0.15s;
        }
        .crop-center-mark::before,
        .crop-center-mark::after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 3px rgba(0,0,0,0.7);
            border-radius: 1px;
        }
        .crop-center-mark::before {
            left: 0; right: 0; top: 50%;
            height: 2px; margin-top: -1px;
        }
        .crop-center-mark::after {
            top: 0; bottom: 0; left: 50%;
            width: 2px; margin-left: -1px;
        }
        .crop-viewport:hover .crop-center-mark,
        .crop-viewport.dragging .crop-center-mark { opacity: 1; }
        .crop-controls {
            background: #f7f7f7;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .crop-control {
            display: grid;
            grid-template-columns: 66px 1fr 42px;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }
        .crop-control input[type="range"] {
            width: 100%;
            accent-color: #ea4c89;
        }
        .crop-control-value {
            text-align: right;
            font-variant-numeric: tabular-nums;
            color: #333;
            font-weight: bold;
        }
        .crop-side {
            width: 180px;
            min-width: 180px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .crop-preview-card {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        .crop-preview-title {
            font-size: 12px;
            color: #777;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .crop-preview-box {
            width: 126px;
            aspect-ratio: 3 / 4;
            border: 1.5px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            margin: 0 auto;
            position: relative;
            background: #111;
        }
        .crop-preview-tip {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            line-height: 1.5;
        }
        .crop-hint {
            font-size: 11px;
            color: #888;
            line-height: 1.6;
        }
        .crop-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .crop-reset-btn {
            padding: 7px 18px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            color: #666;
        }
        .crop-reset-btn:hover { border-color: #bbb; background: #f8f8f8; }
        .crop-cancel-btn {
            padding: 7px 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 13px;
        }
        .crop-save-btn {
            padding: 7px 22px;
            border: none;
            border-radius: 5px;
            background: #ea4c89;
            color: #fff;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        .crop-save-btn:hover { background: #d93a77; }
        .crop-save-btn:disabled { background: #ccc; cursor: not-allowed; }

        #exportCanvas { display: none; }
    </style>
</head>
<body>

    <div class="grid-wrapper">
        <div class="grid-title">ACGNç”Ÿæ¶¯ä¸ªäººå–œå¥½è¡¨</div>
        <div class="grid-container" id="gridContainer"></div>
    </div>

    <div class="ctrl-box">
        <button class="ctrl-btn" onclick="saveImage()">ğŸ’¾ ä¿å­˜ä¸ºå›¾ç‰‡</button>
    </div>

    <!-- å°é¢é€‰æ‹©å¼¹çª— -->
    <div class="cover-modal" id="coverModal">
        <div class="cover-modal-inner">
            <div class="cover-modal-title" id="modalTitle">é€‰æ‹©å°é¢</div>

            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="covers" onclick="switchTab('covers')">ğŸ“ å·²æœ‰å°é¢</button>
                <button class="modal-tab" data-tab="search" onclick="switchTab('search')">ğŸ” æœç´¢ä½œå“</button>
            </div>

            <!-- å·²æœ‰å°é¢ -->
            <div class="tab-panel active" id="tabCovers">
                <div class="cover-toolbar">
                    <button class="cover-tool-btn" onclick="triggerUploadCover()" title="ä»æœ¬åœ°å¯¼å…¥å›¾ç‰‡åˆ° covers ç›®å½•">ğŸ“‚ å¯¼å…¥å°é¢</button>
                    <button class="cover-tool-btn" onclick="refreshCovers()" title="åˆ·æ–° covers ç›®å½•ï¼ˆæ‹–å…¥æ–°æ–‡ä»¶åç‚¹å‡»ï¼‰">ğŸ”„ åˆ·æ–°</button>
                </div>
                <input type="file" id="uploadCoverInput" accept="image/*" multiple style="display:none" onchange="handleUploadFiles(this.files)">
                <div class="cover-grid" id="coverGrid"></div>
            </div>

            <!-- æœç´¢ä½œå“ -->
            <div class="tab-panel" id="tabSearch">
                <!-- æ ‡ç­¾æµè§ˆå™¨ -->
                <div class="tag-browser" id="tagBrowser"></div>
                <!-- å·²é€‰æ ‡ç­¾ -->
                <div class="tag-badges" id="tagBadges"></div>
                <!-- ç±»å‹ç­›é€‰ -->
                <div class="type-filter-row" id="typeFilterRow">
                    <button class="type-btn active" data-type="all" onclick="setSubjectType('all')">ğŸ“¦ å…¨éƒ¨</button>
                    <button class="type-btn" data-type="anime" onclick="setSubjectType('anime')">ğŸ¥ åŠ¨ç”»</button>
                    <button class="type-btn" data-type="manga" onclick="setSubjectType('manga')">ğŸ“– æ¼«ç”»</button>
                    <button class="type-btn" data-type="novel" onclick="setSubjectType('novel')">ğŸ“ è½»å°è¯´</button>
                    <button class="type-btn" data-type="galgame" onclick="setSubjectType('galgame')">ğŸ® GALGAME</button>
                </div>
                <!-- æ’åº -->
                <div class="search-sort-row">
                    <label>æ’åºï¼š</label>
                    <select class="sort-select" id="sortSelect" onchange="onSortChange()">
                        <option value="rank">æŒ‰æ’å</option>
                        <option value="score">æŒ‰è¯„åˆ†</option>
                        <option value="heat" selected>æŒ‰çƒ­åº¦</option>
                        <option value="match">æŒ‰åŒ¹é…åº¦</option>
                    </select>
                </div>
                <!-- å…³é”®è¯æœç´¢ -->
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯è¿›ä¸€æ­¥ç­›é€‰ï¼ˆå¯é€‰ï¼‰..." onkeydown="if(event.key==='Enter') doSearch()">
                    <button onclick="doSearch()" id="searchBtn">æœç´¢</button>
                </div>
                <!-- ç»“æœä¿¡æ¯ -->
                <div id="resultInfo" class="result-info" style="display:none;"><span id="resultCount"></span></div>
                <!-- æœç´¢ç»“æœ -->
                <div id="searchResults">
                    <div class="search-status">é€‰æ‹©ä¸Šæ–¹é¢˜ææ ‡ç­¾ï¼Œæˆ–ç›´æ¥è¾“å…¥å…³é”®è¯æœç´¢</div>
                </div>
                <!-- åˆ†é¡µ -->
                <div id="pagination" class="pagination"></div>
            </div>

            <div class="cover-modal-actions">
                <button class="cover-modal-btn clear-btn" onclick="clearCover()">æ¸…é™¤å°é¢</button>
                <button class="cover-modal-btn close-btn" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è£å‰ªå¼¹çª— -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-modal-inner">
            <div class="crop-header">
                <div class="crop-title" id="cropTitle">è£å‰ªå°é¢</div>
                <button class="crop-close-x" onclick="closeCropModal()" aria-label="å…³é—­">Ã—</button>
            </div>
            <div class="crop-body">
                <div class="crop-workspace">
                    <div class="crop-stage">
                        <div class="crop-viewport" id="cropViewport">
                            <img id="cropImage" class="crop-img" alt="crop-source" draggable="false">
                            <div class="crop-grid-overlay"></div>
                            <div class="crop-center-mark"></div>
                        </div>
                    </div>
                    <div class="crop-controls">
                        <div class="crop-control">
                            <span>ç¼©æ”¾</span>
                            <input id="cropZoom" type="range" min="100" max="300" step="1">
                            <span id="cropZoomValue" class="crop-control-value">100%</span>
                        </div>
                        <div class="crop-control">
                            <span>æ¨ªå‘</span>
                            <input id="cropX" type="range" min="0" max="100" step="1">
                            <span id="cropXValue" class="crop-control-value">50%</span>
                        </div>
                        <div class="crop-control">
                            <span>çºµå‘</span>
                            <input id="cropY" type="range" min="0" max="100" step="1">
                            <span id="cropYValue" class="crop-control-value">50%</span>
                        </div>
                    </div>
                    <div class="crop-hint">æ‹–æ‹½å›¾ç‰‡å¯å¿«é€Ÿè°ƒæ•´è£å‰ªåŒºåŸŸï¼›è¯¥æ“ä½œåªå½±å“å½“å‰æ ¼å­æ˜¾ç¤ºï¼Œä¸ä¼šä¿®æ”¹ covers åŸå›¾ã€‚</div>
                </div>
                <div class="crop-side">
                    <div class="crop-preview-card">
                        <div class="crop-preview-title">è£å‰ªé¢„è§ˆ</div>
                        <div class="crop-preview-box">
                            <img id="cropPreviewImage" class="crop-img" alt="crop-preview" draggable="false">
                        </div>
                        <div class="crop-preview-tip">é¢„è§ˆä¸æ ¼å­æ˜¾ç¤ºåŠå¯¼å‡ºä¿æŒä¸€è‡´ã€‚</div>
                    </div>
                </div>
            </div>
            <div class="crop-actions">
                <button class="crop-reset-btn" onclick="resetCropDraft()">é‡ç½®</button>
                <button class="crop-cancel-btn" onclick="closeCropModal()">å–æ¶ˆ</button>
                <button class="crop-save-btn" onclick="saveCropDraft()">åº”ç”¨è£å‰ª</button>
            </div>
        </div>
    </div>

    <canvas id="exportCanvas"></canvas>

<script>
    // texts å®šä¹‰ 6Ã—10 ç½‘æ ¼çš„ 60 ä¸ªåˆ†ç±»æ ‡ç­¾ã€‚
    const texts = [
        "å…¥å‘ä½œ", "æœ€å–œæ¬¢", "çœ‹æœ€å¤šæ¬¡", "æœ€æƒ³å®‰åˆ©", "æœ€ä¸€çœ¼ç¼˜", "æœ€éœ‡æ’¼",
        "æœ€æ²»æ„ˆ", "æœ€æç¬‘", "æœ€æ„ŸåŠ¨", "æœ€çƒ­è¡€", "æœ€è‡´éƒ", "æœ€ç”µæ³¢",
        "æœ€ä½³å‰§æƒ…", "æœ€ä½³æ¼”å‡º", "æœ€ä½³éŸ³ä¹", "æœ€ä½³ä¸–ç•Œè§‚", "æœ€ä½³è§’è‰²å¡‘é€ ", "æ‰­çš„æœ€å‰å®³",
        "æœ€ä½³æ‹çˆ±", "æœ€ä½³ä¿®ç½—åœº", "æœ€ä½³åå®«", "æœ€ä½³ç™¾åˆ", "æœ€ä½³è€½ç¾", "æœ€ä½³ç¾¤åƒ",
        "æœ€ä½³æ—¥å¸¸", "æœ€ä½³æ ¡å›­", "æœ€ä½³è¿åŠ¨", "æœ€ä½³æˆ˜æ–—", "æœ€ä½³æ™ºæ–—", "æœ€ä½³æ‚¬ç–‘",
        "æœ€ä½³å¥‡å¹»", "æœ€ä½³ç§‘å¹»", "æœ€ä½³æœºç”²", "æœ€ä½³å†’é™©", "æœ€ä½³å²è¯—", "æœ€ä½³æœ«æ—¥",
        "æœ€ä½³å¼‚ä¸–ç•Œ", "æœ€ä½³ç©¿è¶Š", "æœ€ä½³æ¶ç©º", "æœ€ä½³è½¬ç”Ÿ", "æœ€ä½³åŸåˆ›", "æœ€ä½³æ”¹ç¼–",
        "æœ€ä½³æ—¶é—´è½®å›", "æœ€ä½³å™è¯¡", "æœ€ä½³ä¼ªå¨˜", "æœ€ä½³è¶…èƒ½åŠ›", "æœ€ä½³èŒåœº", "æœ€ä½³ç¾é£Ÿ",
        "å°ä¼—æœ€çˆ±", "æœ€çˆ±ç”»é£", "æœ€çˆ±é•¿ç¯‡", "æœ€ææ€–", "æœ€å†™å®", "å¸¸å¬è¯´ä»æœªçœ‹",
        "èŠ±æœ€å¤šé’±", "æœ€è¢«ä½ä¼°", "æœ€è¿‡èª‰", "æœ€èƒƒç–¼", "æœ€æœŸç»­ä½œ", "æœ€è®¨åŒ"
    ];

    // cellImages ä¿å­˜æ¯ä¸ªæ ¼å­çš„å°é¢ URLã€‚
    const cellImages = new Array(texts.length).fill(null);
    // cellCrops ä¿å­˜æ¯ä¸ªæ ¼å­çš„è£å‰ªå‚æ•°ï¼ˆä»…å½±å“å½“å‰ç”¨æˆ·å±•ç¤ºä¸å¯¼å‡ºï¼Œä¸æ”¹åŸå›¾ï¼‰ã€‚
    const cellCrops = new Array(texts.length).fill(null);
    // coverUrls ä¿å­˜ /api/covers è¿”å›çš„å°é¢åˆ—è¡¨ã€‚
    let coverUrls = [];
    // activeCellIndex è®°å½•å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ ¼å­ç´¢å¼•ã€‚
    let activeCellIndex = -1;
    // _imgCache ç¼“å­˜å·²åŠ è½½å›¾ç‰‡ï¼Œå‡å°‘é‡å¤å¯¼å‡ºæ—¶çš„ç½‘ç»œå’Œè§£ç å¼€é”€ã€‚
    const _imgCache = new Map();
    // è£å‰ªç¼–è¾‘çŠ¶æ€
    let cropEditingIndex = -1;
    let cropDraft = null;
    let cropDragging = false;
    let cropDragStartX = 0;
    let cropDragStartY = 0;

    // æœç´¢é¢æ¿çš„é¢˜ææ ‡ç­¾åˆ†ç»„ï¼Œç”¨äº Bangumi tag æµè§ˆã€‚
    const allTags = [
        { label: "æƒ…æ„Ÿä½“éªŒ", tags: ["æ²»æ„ˆ", "æç¬‘", "çƒ­è¡€", "æ„ŸåŠ¨", "å‚¬æ³ª", "è‡´éƒ", "ææ€–", "æ‚¬ç–‘", "ç´§å¼ "] },
        { label: "æ‹çˆ±äººé™…", tags: ["æ‹çˆ±", "é’æ˜¥", "ç™¾åˆ", "BL", "åå®«", "ä¸‰è§’å…³ç³»", "ç¾¤åƒ", "æ—¥å¸¸"] },
        { label: "ä¸–ç•Œè®¾å®š", tags: ["å¼‚ä¸–ç•Œ", "ç©¿è¶Š", "è½¬ç”Ÿ", "æ¶ç©º", "å¥‡å¹»", "ç§‘å¹»", "èµ›åšæœ‹å…‹", "æœ«æ—¥", "å²è¯—", "ç¥è¯"] },
        { label: "é¢˜æç±»å‹", tags: ["æ ¡å›­", "è¿åŠ¨", "æˆ˜æ–—", "å†’é™©", "æœºç”²", "è¶…èƒ½åŠ›", "èŒåœº", "ç¾é£Ÿ", "éŸ³ä¹", "å¶åƒ", "æ¨ç†", "å†å²"] },
        { label: "å™äº‹é£æ ¼", tags: ["å‰§æƒ…", "åŸåˆ›", "æ”¹ç¼–", "å†™å®", "å™è¿°æ€§è¯¡è®¡", "æ—¶é—´å¾ªç¯", "æ™ºæ–—"] },
        { label: "ç‰¹è‰²å…ƒç´ ", tags: ["ä¼ªå¨˜", "å…½è€³", "é­”æ³•", "å¥³ç©¿ç”·è£…", "å¿è€…", "æ­¦å£«", "å¸è¡€é¬¼", "åƒµå°¸"] },
    ];

    // æœç´¢çŠ¶æ€
    let currentTags = [];           // å½“å‰é€‰ä¸­çš„æ ‡ç­¾åˆ—è¡¨
    let currentPage = 1;            // å½“å‰é¡µç 
    let currentTotal = 0;           // æœç´¢ç»“æœæ€»æ•°
    let currentSubjectType = "all"; // ç±»å‹ç­›é€‰
    const PAGE_SIZE = 20;           // æ¯é¡µæ¡æ•°
    let _searchTimer = null;        // æœç´¢é˜²æŠ–è®¡æ—¶å™¨
    let _loadingRequests = 0;       // æ­£åœ¨è¿›è¡Œçš„åŠ è½½è¯·æ±‚æ•°é‡
    let _searchVersion = 0;         // æœç´¢ç‰ˆæœ¬å·ï¼Œç”¨äºéš”ç¦»æ—§è¯·æ±‚ç»“æœ
    const _pageCache = new Map();   // åˆ†é¡µç¼“å­˜ key -> data
    const _inflight = new Map();    // è¯·æ±‚å»é‡ key -> Promise
    const CACHE_LIMIT = 120;        // åˆ†é¡µç¼“å­˜ä¸Šé™ï¼Œé¿å…æ— é™å¢é•¿
    const PREFETCH_STEPS = [1, 2, -1]; // é¢„åŠ è½½é¡ºåºï¼šå1é¡µã€å2é¡µã€å‰1é¡µ

    // initGrid åˆ›å»º 60 ä¸ªç½‘æ ¼æ ¼å­å¹¶ç»‘å®šç‚¹å‡»äº‹ä»¶ã€‚
    function initGrid() {
        const container = document.getElementById("gridContainer");
        container.innerHTML = "";
        texts.forEach((text, i) => {
            const cell = document.createElement("div");
            cell.className = "grid-cell";
            cell.onclick = () => openCoverPicker(i);
            cell.innerHTML = `
                <div class="cell-img-area" id="imgArea${i}">
                    <span class="placeholder">ï¼‹</span>
                </div>
                <div class="cell-label">${text}</div>
            `;
            container.appendChild(cell);
            renderCellImage(i, text);
        });
    }

    function defaultCrop() {
        return { zoom: 1, centerX: 0.5, centerY: 0.5 };
    }

    function cloneCrop(crop) {
        return {
            zoom: Number(crop?.zoom ?? 1),
            centerX: Number(crop?.centerX ?? 0.5),
            centerY: Number(crop?.centerY ?? 0.5),
        };
    }

    function clampCrop(crop) {
        crop.zoom = Math.min(3, Math.max(1, Number(crop.zoom) || 1));
        const cx = Number(crop.centerX);
        const cy = Number(crop.centerY);
        crop.centerX = Math.min(1, Math.max(0, isNaN(cx) ? 0.5 : cx));
        crop.centerY = Math.min(1, Math.max(0, isNaN(cy) ? 0.5 : cy));
        return crop;
    }

    function getCellCrop(index) {
        return clampCrop(cloneCrop(cellCrops[index] || defaultCrop()));
    }

    // computeCropLayout æ ¹æ®å›¾ç‰‡åŸå§‹å°ºå¯¸ã€å®¹å™¨å®½é«˜æ¯”å’Œè£å‰ªå‚æ•°è®¡ç®—å®šä½ç™¾åˆ†æ¯”ã€‚
    function computeCropLayout(natW, natH, containerRatio, crop) {
        const imgRatio = natW / natH;
        let wPct, hPct;
        if (imgRatio > containerRatio) {
            hPct = 100 * crop.zoom;
            wPct = 100 * crop.zoom * imgRatio / containerRatio;
        } else {
            wPct = 100 * crop.zoom;
            hPct = 100 * crop.zoom * containerRatio / imgRatio;
        }
        const overflowX = wPct - 100;
        const overflowY = hPct - 100;
        return {
            width: wPct + '%',
            height: hPct + '%',
            left: -(crop.centerX * overflowX) + '%',
            top: -(crop.centerY * overflowY) + '%',
        };
    }

    // applyCropLayoutToElement å°†è£å‰ªå¸ƒå±€åº”ç”¨åˆ°å›¾ç‰‡å…ƒç´ ã€‚
    function applyCropLayoutToElement(img, layout) {
        img.style.objectFit = '';
        img.style.objectPosition = '';
        img.style.width = layout.width;
        img.style.height = layout.height;
        img.style.left = layout.left;
        img.style.top = layout.top;
    }

    function renderCellImage(index, altText = "cover") {
        const area = document.getElementById(`imgArea${index}`);
        if (!area) return;
        area.innerHTML = "";

        const url = cellImages[index];
        if (!url) {
            const placeholder = document.createElement("span");
            placeholder.className = "placeholder";
            placeholder.textContent = "ï¼‹";
            area.appendChild(placeholder);
            return;
        }

        const crop = getCellCrop(index);
        const img = document.createElement("img");
        img.src = url;
        img.alt = altText;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.objectPosition = `${crop.centerX * 100}% ${crop.centerY * 100}%`;
        img.onload = () => {
            const r = (area.offsetWidth && area.offsetHeight)
                ? area.offsetWidth / area.offsetHeight : 150 / 204;
            const layout = computeCropLayout(img.naturalWidth, img.naturalHeight, r, crop);
            applyCropLayoutToElement(img, layout);
        };
        area.appendChild(img);

        const editBtn = document.createElement("button");
        editBtn.className = "cover-edit-btn";
        editBtn.type = "button";
        editBtn.title = "è£å‰ªå°é¢";
        editBtn.textContent = "âœ‚";
        editBtn.onclick = (e) => {
            e.stopPropagation();
            openCropModal(index);
        };
        area.appendChild(editBtn);
    }

    // loadCovers ä»åç«¯åŠ è½½ covers ç›®å½•ä¸­çš„å°é¢åˆ—è¡¨ã€‚
    async function loadCovers() {
        try {
            const resp = await fetch("/api/covers");
            if (!resp.ok) return;
            const list = await resp.json();
            coverUrls = list.map(n => ({ name: n, url: "covers/" + encodeURIComponent(n) }));
        } catch (e) {
            console.warn("åŠ è½½å°é¢å¤±è´¥:", e);
        }
    }

    // refreshCovers æ‰‹åŠ¨åˆ·æ–°å°é¢åˆ—è¡¨å¹¶é‡æ–°æ¸²æŸ“å¼¹çª—å†…ç½‘æ ¼ã€‚
    async function refreshCovers() {
        await loadCovers();
        renderCoverGrid();
    }

    // renderCoverGrid æ¸²æŸ“å¼¹çª—å†…çš„å·²æœ‰å°é¢ç½‘æ ¼ã€‚
    function renderCoverGrid() {
        const grid = document.getElementById("coverGrid");
        if (!grid) return;
        grid.innerHTML = "";
        if (coverUrls.length === 0) {
            grid.innerHTML = `<div class="no-covers-msg">covers æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡<br>ç‚¹å‡»ã€Œå¯¼å…¥å°é¢ã€ä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼Œæˆ–åˆ‡æ¢åˆ°ã€Œæœç´¢ä½œå“ã€Tab åœ¨çº¿æœç´¢</div>`;
            return;
        }
        coverUrls.forEach(({ name, url }) => {
            const item = document.createElement("div");
            item.className = "cover-item";
            item.innerHTML = `<img src="${url}" alt="${name}" title="${name}">`;
            item.onclick = (e) => { e.stopPropagation(); selectCover(url, name); };
            grid.appendChild(item);
        });
    }

    // triggerUploadCover è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ã€‚
    function triggerUploadCover() {
        document.getElementById("uploadCoverInput").click();
    }

    // handleUploadFiles ä¸Šä¼ é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶åˆ°åç«¯ covers ç›®å½•ã€‚
    async function handleUploadFiles(files) {
        if (!files || files.length === 0) return;
        const overlay = document.createElement("div");
        overlay.className = "download-overlay";
        overlay.innerHTML = `<div class="download-overlay-box">
            <div class="spinner"></div>
            <div>æ­£åœ¨å¯¼å…¥å°é¢ï¼ˆ0/${files.length}ï¼‰...</div>
        </div>`;
        document.body.appendChild(overlay);
        const msgEl = overlay.querySelector("div > div:last-child");

        let lastFilename = null;
        try {
            for (let i = 0; i < files.length; i++) {
                msgEl.textContent = `æ­£åœ¨å¯¼å…¥å°é¢ï¼ˆ${i + 1}/${files.length}ï¼‰...`;
                const form = new FormData();
                form.append("file", files[i]);
                const resp = await fetch("/api/upload-cover", { method: "POST", body: form });
                const data = await resp.json();
                if (data.error) {
                    alert(`å¯¼å…¥ ${files[i].name} å¤±è´¥: ${data.error}`);
                    continue;
                }
                lastFilename = data.filename;
            }
            await loadCovers();
            renderCoverGrid();
            if (lastFilename && activeCellIndex >= 0) {
                // ä¸è‡ªåŠ¨é€‰æ‹©ï¼Œä»…åˆ·æ–°åˆ—è¡¨
            }
        } catch (e) {
            alert("å¯¼å…¥å‡ºé”™: " + e.message);
        } finally {
            overlay.remove();
            document.getElementById("uploadCoverInput").value = "";
        }
    }

    // openCoverPicker æ‰“å¼€å¼¹çª—å¹¶æ¸²æŸ“å¯é€‰å°é¢ã€‚
    function openCoverPicker(index) {
        activeCellIndex = index;
        const grid = document.getElementById("coverGrid");
        document.getElementById("modalTitle").textContent = `ä¸ºã€Œ${texts[index]}ã€é€‰æ‹©å°é¢`;

        // æ¸²æŸ“å·²æœ‰å°é¢åˆ—è¡¨
        renderCoverGrid();

        // é‡ç½®æœç´¢çŠ¶æ€
        currentTags = [];
        currentPage = 1;
        currentTotal = 0;
        currentSubjectType = "all";
        document.getElementById("searchInput").value = "";
        document.getElementById("resultInfo").style.display = "none";
        document.getElementById("pagination").innerHTML = "";
        document.getElementById("searchResults").innerHTML =
            '<div class="search-status">é€‰æ‹©ä¸Šæ–¹é¢˜ææ ‡ç­¾ï¼Œæˆ–ç›´æ¥è¾“å…¥å…³é”®è¯æœç´¢</div>';
        document.querySelectorAll(".type-btn").forEach(b =>
            b.classList.toggle("active", b.dataset.type === "all"));
        _searchVersion += 1;
        _pageCache.clear();
        _inflight.clear();
        syncTagBrowserUI();
        renderTagBadges();

        // é»˜è®¤æ˜¾ç¤ºå·²æœ‰å°é¢ Tab
        switchTab("covers");
        document.getElementById("coverModal").classList.add("active");
    }

    // selectCover å°†é€‰ä¸­å°é¢å†™å…¥å½“å‰æ ¼å­å¹¶ä¿å­˜çŠ¶æ€ã€‚
    function selectCover(url, name) {
        const i = activeCellIndex;
        cellImages[i] = url;
        cellCrops[i] = defaultCrop();
        renderCellImage(i, name);
        closeModal();
        saveState();
    }

    // clearCover æ¸…é™¤å½“å‰æ ¼å­çš„å°é¢å¹¶ä¿å­˜çŠ¶æ€ã€‚
    function clearCover() {
        const i = activeCellIndex;
        cellImages[i] = null;
        cellCrops[i] = null;
        renderCellImage(i);
        closeModal();
        saveState();
    }

    // closeModal å…³é—­å°é¢é€‰æ‹©å¼¹çª—ã€‚
    function closeModal() {
        document.getElementById("coverModal").classList.remove("active");
    }

    // ç‚¹å‡»å¼¹çª—é®ç½©å±‚å…³é—­
    document.addEventListener("click", (e) => {
        if (e.target === document.getElementById("coverModal")) closeModal();
        if (e.target === document.getElementById("cropModal")) closeCropModal();
    });

    function openCropModal(index) {
        if (!cellImages[index]) return;
        cropEditingIndex = index;
        cropDraft = getCellCrop(index);
        const title = texts[index] || "å½“å‰æ ¼å­";
        document.getElementById("cropTitle").textContent = `è£å‰ªå°é¢ Â· ã€Œ${title}ã€`;
        const src = cellImages[index];
        const cropImg = document.getElementById("cropImage");
        const previewImg = document.getElementById("cropPreviewImage");
        cropImg.src = src;
        previewImg.src = src;
        [cropImg, previewImg].forEach(el => {
            el.style.width = '100%';
            el.style.height = '100%';
            el.style.objectFit = 'cover';
            el.style.left = '0';
            el.style.top = '0';
        });
        syncCropInputs();
        if (cropImg.complete && cropImg.naturalWidth > 0) {
            applyCropDraftToPreview();
        } else {
            cropImg.onload = () => applyCropDraftToPreview();
        }
        document.getElementById("cropModal").classList.add("active");
    }

    function closeCropModal() {
        document.getElementById("cropModal").classList.remove("active");
        cropEditingIndex = -1;
        cropDraft = null;
        cropDragging = false;
        document.getElementById("cropViewport").classList.remove("dragging");
    }

    function syncCropInputs() {
        if (!cropDraft) return;
        const zoomVal = Math.round(cropDraft.zoom * 100);
        const xVal = Math.round(cropDraft.centerX * 100);
        const yVal = Math.round(cropDraft.centerY * 100);
        document.getElementById("cropZoom").value = String(zoomVal);
        document.getElementById("cropX").value = String(xVal);
        document.getElementById("cropY").value = String(yVal);
        document.getElementById("cropZoomValue").textContent = `${zoomVal}%`;
        document.getElementById("cropXValue").textContent = `${xVal}%`;
        document.getElementById("cropYValue").textContent = `${yVal}%`;
    }

    function applyCropDraftToPreview() {
        if (!cropDraft) return;
        clampCrop(cropDraft);
        const cropImg = document.getElementById("cropImage");
        if (!cropImg.naturalWidth) return;
        const layout = computeCropLayout(
            cropImg.naturalWidth, cropImg.naturalHeight, 3 / 4, cropDraft
        );
        applyCropLayoutToElement(cropImg, layout);
        applyCropLayoutToElement(document.getElementById("cropPreviewImage"), layout);
        syncCropInputs();
    }

    function resetCropDraft() {
        cropDraft = defaultCrop();
        applyCropDraftToPreview();
    }

    function saveCropDraft() {
        if (cropEditingIndex < 0 || !cropDraft) return;
        cellCrops[cropEditingIndex] = clampCrop(cloneCrop(cropDraft));
        renderCellImage(cropEditingIndex);
        saveState();
        closeCropModal();
    }

    document.getElementById("cropZoom").addEventListener("input", (e) => {
        if (!cropDraft) return;
        cropDraft.zoom = Number(e.target.value) / 100;
        cropDraft = clampCrop(cropDraft);
        applyCropDraftToPreview();
    });
    document.getElementById("cropX").addEventListener("input", (e) => {
        if (!cropDraft) return;
        cropDraft.centerX = Number(e.target.value) / 100;
        cropDraft = clampCrop(cropDraft);
        applyCropDraftToPreview();
    });
    document.getElementById("cropY").addEventListener("input", (e) => {
        if (!cropDraft) return;
        cropDraft.centerY = Number(e.target.value) / 100;
        cropDraft = clampCrop(cropDraft);
        applyCropDraftToPreview();
    });

    const cropViewport = document.getElementById("cropViewport");
    cropViewport.addEventListener("pointerdown", (e) => {
        if (!cropDraft) return;
        cropDragging = true;
        cropDragStartX = e.clientX;
        cropDragStartY = e.clientY;
        cropViewport.classList.add("dragging");
        cropViewport.setPointerCapture(e.pointerId);
    });
    cropViewport.addEventListener("pointermove", (e) => {
        if (!cropDragging || !cropDraft) return;
        const dx = e.clientX - cropDragStartX;
        const dy = e.clientY - cropDragStartY;
        cropDragStartX = e.clientX;
        cropDragStartY = e.clientY;

        const cropImg = document.getElementById("cropImage");
        if (!cropImg.naturalWidth) return;
        const rect = cropViewport.getBoundingClientRect();
        const imgRatio = cropImg.naturalWidth / cropImg.naturalHeight;
        const boxRatio = rect.width / rect.height || 3 / 4;
        let wFactor, hFactor;
        if (imgRatio > boxRatio) {
            hFactor = cropDraft.zoom;
            wFactor = cropDraft.zoom * imgRatio / boxRatio;
        } else {
            wFactor = cropDraft.zoom;
            hFactor = cropDraft.zoom * boxRatio / imgRatio;
        }
        const overflowXPx = (wFactor - 1) * rect.width;
        const overflowYPx = (hFactor - 1) * rect.height;
        if (overflowXPx > 0.5) cropDraft.centerX -= dx / overflowXPx;
        if (overflowYPx > 0.5) cropDraft.centerY -= dy / overflowYPx;
        cropDraft = clampCrop(cropDraft);
        applyCropDraftToPreview();
    });
    cropViewport.addEventListener("pointerup", (e) => {
        cropDragging = false;
        cropViewport.classList.remove("dragging");
        if (cropViewport.hasPointerCapture(e.pointerId)) {
            cropViewport.releasePointerCapture(e.pointerId);
        }
    });
    cropViewport.addEventListener("pointercancel", () => {
        cropDragging = false;
        cropViewport.classList.remove("dragging");
    });

    // switchTab åˆ‡æ¢å¼¹çª—å†…çš„ tab é¢æ¿ã€‚
    function switchTab(tab) {
        document.querySelectorAll(".modal-tab").forEach(t =>
            t.classList.toggle("active", t.dataset.tab === tab));
        document.getElementById("tabCovers").classList.toggle("active", tab === "covers");
        document.getElementById("tabSearch").classList.toggle("active", tab === "search");
        if (tab === "search") {
            setTimeout(() => document.getElementById("searchInput").focus(), 100);
        }
    }

    // ---- æœç´¢é¢æ¿åŠŸèƒ½ ----

    // initTagBrowser æŒ‰åˆ†ç±»æ¸²æŸ“æ ‡ç­¾é€‰æ‹©æŒ‰é’®ã€‚
    function initTagBrowser() {
        const browser = document.getElementById("tagBrowser");
        browser.innerHTML = "";
        allTags.forEach(({ label, tags }) => {
            const row = document.createElement("div");
            row.className = "tag-cat-row";
            row.innerHTML = `<span class="tag-cat-label">${label}</span>`;
            const group = document.createElement("div");
            group.className = "tag-cat-group";
            tags.forEach(tag => {
                const btn = document.createElement("button");
                btn.className = "tag-pick-btn";
                btn.textContent = tag;
                btn.dataset.tag = tag;
                btn.onclick = () => toggleTag(tag);
                group.appendChild(btn);
            });
            row.appendChild(group);
            browser.appendChild(row);
        });
    }

    // syncTagBrowserUI åŒæ­¥æ ‡ç­¾æŒ‰é’®çš„é€‰ä¸­é«˜äº®ã€‚
    function syncTagBrowserUI() {
        document.querySelectorAll(".tag-pick-btn").forEach(btn =>
            btn.classList.toggle("active", currentTags.includes(btn.dataset.tag)));
    }

    // renderTagBadges æ¸²æŸ“å·²é€‰æ ‡ç­¾å¾½ç« ã€‚
    function renderTagBadges() {
        const container = document.getElementById("tagBadges");
        container.innerHTML = "";
        currentTags.forEach((tag, idx) => {
            const badge = document.createElement("span");
            badge.className = "tag-badge";
            badge.innerHTML = `${tag} <span class="remove-tag" onclick="removeTag(${idx})">Ã—</span>`;
            container.appendChild(badge);
        });
    }

    // toggleTag åˆ‡æ¢æ ‡ç­¾é€‰ä¸­çŠ¶æ€ï¼Œæœ‰æ¡ä»¶æ—¶è‡ªåŠ¨æœç´¢ã€‚
    function toggleTag(tag) {
        const idx = currentTags.indexOf(tag);
        if (idx === -1) currentTags.push(tag);
        else currentTags.splice(idx, 1);
        syncTagBrowserUI();
        renderTagBadges();
        if (hasSearchCondition()) doSearch();
        else resetSearchResults();
    }

    // removeTag ç§»é™¤æŒ‡å®šä½ç½®çš„æ ‡ç­¾ã€‚
    function removeTag(idx) {
        currentTags.splice(idx, 1);
        syncTagBrowserUI();
        renderTagBadges();
        if (hasSearchCondition()) doSearch();
        else resetSearchResults();
    }

    // setSubjectType åˆ‡æ¢ä½œå“ç±»å‹ç­›é€‰ã€‚
    function setSubjectType(type) {
        currentSubjectType = type;
        document.querySelectorAll(".type-btn").forEach(b =>
            b.classList.toggle("active", b.dataset.type === type));
        if (hasSearchCondition()) doSearch();
    }

    // onSortChange æ’åºå­—æ®µå˜æ›´æ—¶è§¦å‘æœç´¢ã€‚
    function onSortChange() {
        if (hasSearchCondition()) doSearch();
    }

    // hasSearchCondition åˆ¤æ–­æ˜¯å¦æœ‰æœ‰æ•ˆæœç´¢æ¡ä»¶ã€‚
    function hasSearchCondition() {
        return currentTags.length > 0
            || document.getElementById("searchInput").value.trim()
            || currentSubjectType !== "all";
    }

    // resetSearchResults æ¸…ç©ºæœç´¢ç»“æœåŒºã€‚
    function resetSearchResults() {
        document.getElementById("searchResults").innerHTML =
            '<div class="search-status">é€‰æ‹©ä¸Šæ–¹é¢˜ææ ‡ç­¾ï¼Œæˆ–ç›´æ¥è¾“å…¥å…³é”®è¯æœç´¢</div>';
        document.getElementById("resultInfo").style.display = "none";
        document.getElementById("pagination").innerHTML = "";
    }

    // doSearch è§¦å‘æœç´¢ï¼ˆ300ms é˜²æŠ–ï¼‰ã€‚
    function doSearch() {
        currentPage = 1;
        _searchVersion += 1;
        _pageCache.clear();
        _inflight.clear();
        clearTimeout(_searchTimer);
        _searchTimer = setTimeout(() => loadAndRenderPage(currentPage, true), 300);
    }

    // currentSearchParams è¯»å–å½“å‰æœç´¢å‚æ•°å¿«ç…§ï¼Œé¿å…è¯·æ±‚è¿‡ç¨‹è¢« UI æ”¹åŠ¨å½±å“ã€‚
    function currentSearchParams() {
        return {
            sort: document.getElementById("sortSelect").value,
            keyword: document.getElementById("searchInput").value.trim(),
            subjectType: currentSubjectType,
            tags: [...currentTags],
        };
    }

    // pageCacheKey ç”Ÿæˆåˆ†é¡µç¼“å­˜é”®ï¼Œç»‘å®šæœç´¢æ¡ä»¶å’Œé¡µç ã€‚
    function pageCacheKey(params, page) {
        return JSON.stringify([
            params.tags,
            params.keyword,
            params.subjectType,
            params.sort,
            page,
        ]);
    }

    // trimCache å¦‚æœç¼“å­˜è¶…é™ï¼Œåˆ é™¤æœ€æ—©å†™å…¥çš„æ¡ç›®ã€‚
    function trimCache() {
        while (_pageCache.size > CACHE_LIMIT) {
            const oldestKey = _pageCache.keys().next().value;
            if (!oldestKey) break;
            _pageCache.delete(oldestKey);
        }
    }

    // fetchPageData è·å–æŒ‡å®šé¡µæ•°æ®ï¼šå…ˆè¯»ç¼“å­˜ï¼Œå†å¤ç”¨é£è¡Œä¸­è¯·æ±‚ï¼Œæœ€åå‘æ–°è¯·æ±‚ã€‚
    async function fetchPageData(page, params, version) {
        const key = pageCacheKey(params, page);
        if (_pageCache.has(key)) {
            return _pageCache.get(key);
        }
        if (_inflight.has(key)) {
            return _inflight.get(key);
        }

        const offset = (page - 1) * PAGE_SIZE;
        const body = {
            offset,
            limit: PAGE_SIZE,
            sort: params.sort,
            subjectType: params.subjectType,
        };
        if (params.tags.length > 0) body.tags = params.tags;
        if (params.keyword) body.keyword = params.keyword;

        const promise = (async () => {
            const resp = await fetch("/api/browse", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            const data = await resp.json();
            if (!data.error && version === _searchVersion) {
                _pageCache.set(key, data);
                trimCache();
            }
            return data;
        })();

        _inflight.set(key, promise);
        promise.finally(() => _inflight.delete(key));
        return promise;
    }

    // prefetchAround åå°é¢„åŠ è½½ç›¸é‚»é¡µï¼Œå¤ç”¨ fetchPageData å»é‡é€»è¾‘ã€‚
    function prefetchAround(page, totalPages, params, version) {
        PREFETCH_STEPS.forEach(step => {
            const nextPage = page + step;
            if (nextPage < 1 || nextPage > totalPages || nextPage === page) {
                return;
            }
            fetchPageData(nextPage, params, version).catch(() => {});
        });
    }

    // loadAndRenderPage åŠ è½½å¹¶æ¸²æŸ“æŒ‡å®šé¡µï¼Œæ”¯æŒç¼“å­˜å‘½ä¸­ã€è¯·æ±‚å»é‡å’Œåå°é¢„åŠ è½½ã€‚
    async function loadAndRenderPage(page, showLoading) {
        const version = _searchVersion;
        const params = currentSearchParams();

        const resultsDiv = document.getElementById("searchResults");
        const btn = document.getElementById("searchBtn");
        _loadingRequests += 1;
        btn.disabled = true;
        btn.textContent = "æœç´¢ä¸­...";
        if (showLoading) {
            resultsDiv.innerHTML = '<div class="search-status"><div class="spinner"></div><br>æ­£åœ¨åŠ è½½ä½œå“...</div>';
            document.getElementById("pagination").innerHTML = "";
        }

        try {
            const data = await fetchPageData(page, params, version);
            if (version !== _searchVersion) return;
            if (page !== currentPage) return;

            if (data.error) {
                resultsDiv.innerHTML = `<div class="search-status">âŒ ${data.error}</div>`;
                return;
            }
            renderBrowseResults(data);
            const totalPages = Math.max(1, Math.ceil((data.total || 0) / PAGE_SIZE));
            prefetchAround(page, totalPages, params, version);
        } catch (e) {
            if (version !== _searchVersion) return;
            if (page !== currentPage) return;
            resultsDiv.innerHTML = `<div class="search-status">âŒ æœç´¢å‡ºé”™: ${e.message}</div>`;
        } finally {
            _loadingRequests = Math.max(0, _loadingRequests - 1);
            if (_loadingRequests === 0) {
                btn.disabled = false;
                btn.textContent = "æœç´¢";
            }
        }
    }

    // renderBrowseResults æ¸²æŸ“æœç´¢ç»“æœå¡ç‰‡å’Œåˆ†é¡µã€‚
    function renderBrowseResults(data) {
        const resultsDiv = document.getElementById("searchResults");
        currentTotal = data.total || 0;
        const items = data.results || [];
        const totalPages = Math.max(1, Math.ceil(currentTotal / PAGE_SIZE));

        // æ˜¾ç¤ºç»“æœä¿¡æ¯
        const infoDiv = document.getElementById("resultInfo");
        infoDiv.style.display = "flex";
        document.getElementById("resultCount").textContent =
            `å…± ${currentTotal} ä¸ªç»“æœ Â· ç¬¬ ${currentPage} / ${totalPages} é¡µ`;

        if (items.length === 0) {
            resultsDiv.innerHTML = '<div class="search-status">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä½œå“</div>';
            document.getElementById("pagination").innerHTML = "";
            return;
        }

        // æ¸²æŸ“ç»“æœå¡ç‰‡
        resultsDiv.innerHTML = "";
        const grid = document.createElement("div");
        grid.className = "search-results";
        resultsDiv.appendChild(grid);

        items.forEach(item => {
            const el = document.createElement("div");
            el.className = "search-item";
            const displayName = item.name_cn || item.name;
            const subName = item.name_cn ? item.name : "";
            const coverSrc = item.cover || "";
            const typeLabel = item.type_label || "";
            const typeClass = typeLabel === "åŠ¨ç”»" ? "type-anime"
                            : typeLabel === "æ¸¸æˆ" ? "type-game"
                            : typeLabel === "ä¹¦ç±" ? "type-book" : "";
            const score = item.score ? `â­${item.score}` : "";

            el.innerHTML = `
                ${coverSrc
                    ? `<img class="search-item-img" src="${coverSrc}" alt="${displayName}" loading="lazy"
                           onerror="this.style.display='none'">`
                    : `<div class="search-item-img" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">æ— å›¾</div>`
                }
                <div class="search-item-info">
                    <div class="search-item-name" title="${displayName}">${displayName}</div>
                    ${subName ? `<div class="search-item-sub" title="${subName}">${subName}</div>` : ""}
                </div>
                <div class="search-item-meta">
                    ${typeLabel ? `<span class="search-item-type ${typeClass}">${typeLabel}</span>` : ""}
                    ${score ? `<span class="search-item-score">${score}</span>` : ""}
                </div>
            `;
            el.onclick = () => downloadAndApplyCover(item);
            grid.appendChild(el);
        });

        renderPagination(totalPages);
    }

    // renderPagination æ¸²æŸ“åˆ†é¡µæŒ‰é’®ã€‚
    function renderPagination(totalPages) {
        const pag = document.getElementById("pagination");
        pag.innerHTML = "";
        if (totalPages <= 1) return;

        const addBtn = (label, page, disabled = false, active = false) => {
            const b = document.createElement("button");
            b.className = "page-btn" + (active ? " active" : "");
            b.textContent = label;
            b.disabled = disabled;
            if (!disabled && !active) b.onclick = () => goToPage(page);
            pag.appendChild(b);
        };
        const addEllipsis = () => {
            const s = document.createElement("span");
            s.className = "page-ellipsis";
            s.textContent = "â€¦";
            pag.appendChild(s);
        };

        // ä¸Šä¸€é¡µ
        addBtn("â€¹", currentPage - 1, currentPage <= 1);
        // é¡µç ï¼ˆå½“å‰é¡µå‰åå„æ˜¾ç¤º 2 é¡µï¼Œé¦–å°¾è¶…èŒƒå›´åŠ çœç•¥å·ï¼‰
        const WING = 2;
        let lo = Math.max(1, currentPage - WING);
        let hi = Math.min(totalPages, currentPage + WING);
        if (lo > 1) { addBtn("1", 1); if (lo > 2) addEllipsis(); }
        for (let p = lo; p <= hi; p++) addBtn(String(p), p, false, p === currentPage);
        if (hi < totalPages) { if (hi < totalPages - 1) addEllipsis(); addBtn(String(totalPages), totalPages); }
        // ä¸‹ä¸€é¡µ
        addBtn("â€º", currentPage + 1, currentPage >= totalPages);
    }

    // goToPage è·³è½¬åˆ°æŒ‡å®šé¡µã€‚
    function goToPage(page) {
        currentPage = page;
        const params = currentSearchParams();
        const key = pageCacheKey(params, page);
        const shouldShowLoading = !_pageCache.has(key) && !_inflight.has(key);
        loadAndRenderPage(page, shouldShowLoading);
        document.getElementById("searchResults").scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // downloadAndApplyCover ä¸‹è½½æœç´¢ç»“æœçš„å°é¢å¹¶åº”ç”¨åˆ°å½“å‰æ ¼å­ã€‚
    async function downloadAndApplyCover(item) {
        if (!item.cover) {
            alert("è¯¥ä½œå“æ²¡æœ‰å°é¢å›¾ç‰‡");
            return;
        }

        // æ˜¾ç¤ºä¸‹è½½é®ç½©
        const overlay = document.createElement("div");
        overlay.className = "download-overlay";
        overlay.innerHTML = `<div class="download-overlay-box">
            <div class="spinner"></div>
            <div>æ­£åœ¨ä¸‹è½½å°é¢...</div>
        </div>`;
        document.body.appendChild(overlay);

        try {
            const displayName = item.name_cn || item.name || "cover";
            const safeName = displayName.replace(/[<>:"\/\\|?*\s]/g, "_").substring(0, 60);
            const filename = `${safeName}_${item.id}`;

            const resp = await fetch("/api/download-cover", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: item.cover, filename })
            });
            const data = await resp.json();

            if (data.error) {
                alert("ä¸‹è½½å¤±è´¥: " + data.error);
                return;
            }

            // å°†ä¸‹è½½çš„å°é¢åº”ç”¨åˆ°å½“å‰æ ¼å­
            const coverPath = "covers/" + encodeURIComponent(data.filename);
            selectCover(coverPath, data.filename);
            await loadCovers();
        } catch (e) {
            alert("ä¸‹è½½å‡ºé”™: " + e.message);
        } finally {
            overlay.remove();
        }
    }

    // saveState å°†æ ¼å­æ•°æ®ä¿å­˜åˆ°æœåŠ¡ç«¯ state.jsonã€‚
    async function saveState() {
        try {
            await fetch("/api/state", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cells: cellImages, crops: cellCrops })
            });
        } catch (e) {
            console.warn("ä¿å­˜çŠ¶æ€å¤±è´¥:", e);
        }
    }

    // loadState ä»æœåŠ¡ç«¯è¯»å–å¹¶æ¢å¤å·²ä¿å­˜çš„æ ¼å­çŠ¶æ€ã€‚
    async function loadState() {
        try {
            const resp = await fetch("/api/state");
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data.cells) return;
            data.cells.forEach((url, i) => {
                if (url && i < cellImages.length) {
                    cellImages[i] = url;
                    if (Array.isArray(data.crops) && data.crops[i]) {
                        cellCrops[i] = clampCrop(cloneCrop(data.crops[i]));
                    } else {
                        cellCrops[i] = defaultCrop();
                    }
                    renderCellImage(i);
                }
            });
        } catch (e) {
            console.warn("åŠ è½½çŠ¶æ€å¤±è´¥:", e);
        }
    }

    // saveImage å°†å½“å‰è¡¨æ ¼ç»˜åˆ¶åˆ° canvas å¹¶ä¸‹è½½ä¸º PNGã€‚
    async function saveImage() {
        const cols = 6;
        const rows = 10;
        const boxW = 220;
        const boxH = 310;
        const border = 2;
        const padding = 36;
        const titleH = 70;
        const labelH = 40;
        const totalW = padding * 2 + cols * boxW + (cols + 1) * border;
        const totalH = padding * 2 + titleH + rows * boxH + (rows + 1) * border;

        const canvas = document.getElementById("exportCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = totalW;
        canvas.height = totalH;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, totalW, totalH);

        ctx.fillStyle = "#333";
        ctx.font = "bold 36px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ACGNç”Ÿæ¶¯ä¸ªäººå–œå¥½è¡¨", totalW / 2, padding + titleH / 2);

        const loadImg = (src) => new Promise((resolve) => {
            if (!src) {
                resolve(null);
                return;
            }
            if (_imgCache.has(src)) {
                resolve(_imgCache.get(src));
                return;
            }
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                _imgCache.set(src, img);
                resolve(img);
            };
            img.onerror = () => resolve(null);
            img.src = src;
        });

        const imgs = await Promise.all(cellImages.map(loadImg));
        const gridLeft = padding;
        const gridTop = padding + titleH;

        for (let i = 0; i < texts.length; i++) {
            const col = i % cols;
            const row = Math.floor(i / cols);
            const x = gridLeft + col * boxW + (col + 1) * border;
            const y = gridTop + row * boxH + (row + 1) * border;

            ctx.fillStyle = "#fff";
            ctx.fillRect(x, y, boxW, boxH);

            if (imgs[i]) {
                ctx.save();
                ctx.beginPath();
                ctx.rect(x, y, boxW, boxH - labelH);
                ctx.clip();
                coverDraw(ctx, imgs[i], x, y, boxW, boxH - labelH, getCellCrop(i));
                ctx.restore();
            }

            const textY = y + boxH - labelH;
            ctx.fillStyle = "#f0f0f0";
            ctx.fillRect(x, textY, boxW, labelH);
            ctx.strokeStyle = "#ccc";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, textY);
            ctx.lineTo(x + boxW, textY);
            ctx.stroke();

            ctx.fillStyle = "#333";
            ctx.font = "bold 18px sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(texts[i], x + boxW / 2, textY + labelH / 2);
        }

        ctx.strokeStyle = "#333";
        ctx.lineWidth = border;
        const gridW = cols * boxW + (cols + 1) * border;
        const gridH = rows * boxH + (rows + 1) * border;

        for (let r = 0; r <= rows; r++) {
            const lineY = gridTop + r * boxH + r * border + border / 2;
            ctx.beginPath();
            ctx.moveTo(gridLeft, lineY);
            ctx.lineTo(gridLeft + gridW, lineY);
            ctx.stroke();
        }

        for (let c = 0; c <= cols; c++) {
            const lineX = gridLeft + c * boxW + c * border + border / 2;
            ctx.beginPath();
            ctx.moveTo(lineX, gridTop);
            ctx.lineTo(lineX, gridTop + gridH);
            ctx.stroke();
        }

        const link = document.createElement("a");
        link.download = "ACGNç”Ÿæ¶¯ä¸ªäººå–œå¥½è¡¨.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    }

    // coverDraw ä½¿ç”¨ cover æ–¹å¼ç»˜åˆ¶å›¾ç‰‡å¹¶åº”ç”¨è£å‰ªï¼ˆcenterX/centerY æ§åˆ¶å…¨å›¾å†…çš„å¯è§†åŒºåŸŸåç§»ï¼‰ã€‚
    function coverDraw(ctx, img, x, y, w, h, crop = defaultCrop()) {
        crop = clampCrop(cloneCrop(crop));
        const imageRatio = img.width / img.height;
        const boxRatio = w / h;
        let baseW, baseH;
        if (imageRatio > boxRatio) {
            baseH = img.height;
            baseW = baseH * boxRatio;
        } else {
            baseW = img.width;
            baseH = baseW / boxRatio;
        }

        const srcW = baseW / crop.zoom;
        const srcH = baseH / crop.zoom;
        const maxOffX = img.width - srcW;
        const maxOffY = img.height - srcH;
        const srcX = crop.centerX * maxOffX;
        const srcY = crop.centerY * maxOffY;

        ctx.drawImage(img, srcX, srcY, srcW, srcH, x, y, w, h);
    }

    // å¯åŠ¨æµç¨‹ï¼šåˆå§‹åŒ–ç½‘æ ¼ã€æ ‡ç­¾æµè§ˆå™¨ï¼Œå†åŠ è½½å°é¢å’ŒçŠ¶æ€ã€‚
    initGrid();
    initTagBrowser();
    loadCovers();
    loadState();
</script>

</body>
</html>
